<%- include('../partials/forms', { errors, values }) %>
<% 
  // Ensure functions are available in this scope
  const _errors = (typeof errors === 'object' && errors) ? errors : {};
  const _values = (typeof values === 'object' && values) ? values : {};
  
  function fieldError(name) {
    const val = _errors[name];
    if (!val) return '';
    return Array.isArray(val) ? val[0] : val;
  }
  
  function valueFor(name, fallback) {
    if (Object.prototype.hasOwnProperty.call(_values, name) && _values[name] != null) {
      return _values[name];
    }
    return fallback || '';
  }
%>
<section class="apply-header" id="apply-header">
  <div class="apply-header__container">
    <span class="apply-header__badge">Apply</span>
    <h1 class="apply-header__headline">
      <span class="apply-header__headline-fashion">Create your comp card.</span>
      <span class="apply-header__headline-ai">AI-curated quality.</span>
    </h1>
    <p class="apply-header__subheadline">Submit your details once. Our AI refines your bio, standardizes your stats, and delivers a polished PDF comp card â€” free, instantly, no watermark.</p>
    <div class="apply-header__accent"></div>
  </div>
</section>

<section class="apply-main">
  <div class="apply-grid">
      <div class="apply-info">
        <div class="apply-info__card">
          <h2 class="apply-info__title">What you'll get</h2>
          <ul class="apply-info__list">
            <li>
              <strong>Free PDF comp card</strong>
              <span>Watermark-free, ready to share with agencies</span>
            </li>
            <li>
              <strong>AI-curated bio</strong>
              <span>Professional third-person copy, instantly refined</span>
            </li>
            <li>
              <strong>Standardized format</strong>
              <span>Consistent layout trusted by booking directors</span>
            </li>
            <li>
              <strong>Live portfolio option</strong>
              <span>Upgrade to $9.99/mo for booking-ready links & analytics</span>
            </li>
          </ul>
        </div>
        <div class="apply-info__note">
          <p><strong>Four steps.</strong> Save progress anytime. We'll refine the copy and deliver your comp card instantly.</p>
        </div>
      </div>

      <div class="apply-form-wrapper">
        <div class="apply-form-card">
          <% const userIsLoggedIn = typeof isLoggedIn !== 'undefined' ? isLoggedIn : false; %>
          <div class="apply-form-header">
            <ol class="apply-steps">
              <li class="is-active" data-step="1"><%= userIsLoggedIn ? '1 BASIC INFO' : '1 ACCOUNT' %></li>
              <li data-step="2">2 EXPERIENCE</li>
              <li data-step="3">3 PHOTOS</li>
              <li data-step="4">4 REVIEW</li>
            </ol>
          </div>

          <form method="post" action="/apply" enctype="multipart/form-data" class="form" id="apply-form">
            
            <!-- Step 1: VITALS -->
            <div class="form-step" data-step="1">
              <div class="form-grid">
                <div class="form-field <%= fieldError('first_name') ? 'has-error' : '' %>">
                  <label for="first_name">FIRST NAME</label>
                  <input id="first_name" name="first_name" value="<%= valueFor('first_name', '') %>" required>
                  <% if (fieldError('first_name')) { %>
                    <p class="field-error" role="alert"><%= fieldError('first_name') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('last_name') ? 'has-error' : '' %>">
                  <label for="last_name">LAST NAME</label>
                  <input id="last_name" name="last_name" value="<%= valueFor('last_name', '') %>" required>
                  <% if (fieldError('last_name')) { %>
                    <p class="field-error" role="alert"><%= fieldError('last_name') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldError('phone') ? 'has-error' : '' %>">
                  <label for="phone">PHONE</label>
                  <input id="phone" name="phone" type="tel" autocomplete="tel" value="<%= valueFor('phone', '') %>" placeholder="+1 (555) 123-4567">
                  <% if (fieldError('phone')) { %>
                    <p class="field-error" role="alert"><%= fieldError('phone') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('city') ? 'has-error' : '' %>">
                  <label for="city">PRIMARY CITY</label>
                  <input id="city" name="city" value="<%= valueFor('city', '') %>" placeholder="New York, NY" required>
                  <% if (fieldError('city')) { %>
                    <p class="field-error" role="alert"><%= fieldError('city') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('city_secondary') ? 'has-error' : '' %>">
                  <label for="city_secondary">SECONDARY CITY <span class="muted">(optional)</span></label>
                  <input id="city_secondary" name="city_secondary" value="<%= valueFor('city_secondary', '') %>" placeholder="Los Angeles, CA">
                  <% if (fieldError('city_secondary')) { %>
                    <p class="field-error" role="alert"><%= fieldError('city_secondary') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldError('height_cm') ? 'has-error' : '' %>">
                  <label for="height_cm">HEIGHT</label>
                  <input id="height_cm" name="height_cm" type="text" value="<%= valueFor('height_cm', '') %>" placeholder="5' 11&quot; or 180 cm" required>
                  <% if (fieldError('height_cm')) { %>
                    <p class="field-error" role="alert"><%= fieldError('height_cm') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldError('bust') ? 'has-error' : '' %>">
                  <label for="bust">BUST <span class="muted">(inches)</span></label>
                  <input id="bust" name="bust" type="number" min="20" max="60" value="<%= valueFor('bust', '') %>" placeholder="32">
                  <% if (fieldError('bust')) { %>
                    <p class="field-error" role="alert"><%= fieldError('bust') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('waist') ? 'has-error' : '' %>">
                  <label for="waist">WAIST <span class="muted">(inches)</span></label>
                  <input id="waist" name="waist" type="number" min="20" max="50" value="<%= valueFor('waist', '') %>" placeholder="24">
                  <% if (fieldError('waist')) { %>
                    <p class="field-error" role="alert"><%= fieldError('waist') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('hips') ? 'has-error' : '' %>">
                  <label for="hips">HIPS <span class="muted">(inches)</span></label>
                  <input id="hips" name="hips" type="number" min="25" max="60" value="<%= valueFor('hips', '') %>" placeholder="34">
                  <% if (fieldError('hips')) { %>
                    <p class="field-error" role="alert"><%= fieldError('hips') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldError('shoe_size') ? 'has-error' : '' %>">
                  <label for="shoe_size">SHOE SIZE</label>
                  <% 
                    const shoeSizeValue = valueFor('shoe_size', '');
                    const shoeSizeOptions = ['5 US', '5.5 US', '6 US', '6.5 US', '7 US', '7.5 US', '8 US', '8.5 US', '9 US', '9.5 US', '10 US', '10.5 US', '11 US', '11.5 US', '12 US', '13 US'];
                    const isShoeSizeOther = shoeSizeValue && !shoeSizeOptions.includes(shoeSizeValue);
                  %>
                  <select id="shoe_size" name="shoe_size">
                    <option value="">Select...</option>
                    <% shoeSizeOptions.forEach(opt => { %>
                      <option value="<%= opt %>" <%= shoeSizeValue === opt ? 'selected' : '' %>><%= opt %></option>
                    <% }); %>
                    <option value="Other" <%= isShoeSizeOther ? 'selected' : '' %>>Other</option>
                  </select>
                  <input type="text" id="shoe_size_other" name="shoe_size_other" value="<%= isShoeSizeOther ? shoeSizeValue : '' %>" placeholder="Enter shoe size" style="margin-top: 0.5rem; display: <%= isShoeSizeOther ? 'block' : 'none' %>;">
                  <% if (fieldError('shoe_size')) { %>
                    <p class="field-error" role="alert"><%= fieldError('shoe_size') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('eye_color') ? 'has-error' : '' %>">
                  <label for="eye_color">EYE COLOR</label>
                  <% 
                    const eyeColorValue = valueFor('eye_color', '');
                    const eyeColorOptions = ['Brown', 'Blue', 'Green', 'Hazel', 'Gray', 'Amber', 'Other'];
                    const isEyeColorOther = eyeColorValue && !eyeColorOptions.includes(eyeColorValue);
                  %>
                  <select id="eye_color" name="eye_color">
                    <option value="">Select...</option>
                    <% eyeColorOptions.filter(opt => opt !== 'Other').forEach(opt => { %>
                      <option value="<%= opt %>" <%= eyeColorValue === opt ? 'selected' : '' %>><%= opt %></option>
                    <% }); %>
                    <option value="Other" <%= isEyeColorOther ? 'selected' : '' %>>Other</option>
                  </select>
                  <input type="text" id="eye_color_other" name="eye_color_other" value="<%= isEyeColorOther ? eyeColorValue : '' %>" placeholder="Enter eye color" style="margin-top: 0.5rem; display: <%= isEyeColorOther ? 'block' : 'none' %>;">
                  <% if (fieldError('eye_color')) { %>
                    <p class="field-error" role="alert"><%= fieldError('eye_color') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('hair_color') ? 'has-error' : '' %>">
                  <label for="hair_color">HAIR COLOR</label>
                  <% 
                    const hairColorValue = valueFor('hair_color', '');
                    const hairColorOptions = ['Black', 'Brown', 'Blonde', 'Red', 'Auburn', 'Gray', 'White', 'Other'];
                    const isHairColorOther = hairColorValue && !hairColorOptions.includes(hairColorValue);
                  %>
                  <select id="hair_color" name="hair_color">
                    <option value="">Select...</option>
                    <% hairColorOptions.filter(opt => opt !== 'Other').forEach(opt => { %>
                      <option value="<%= opt %>" <%= hairColorValue === opt ? 'selected' : '' %>><%= opt %></option>
                    <% }); %>
                    <option value="Other" <%= isHairColorOther ? 'selected' : '' %>>Other</option>
                  </select>
                  <input type="text" id="hair_color_other" name="hair_color_other" value="<%= isHairColorOther ? hairColorValue : '' %>" placeholder="Enter hair color" style="margin-top: 0.5rem; display: <%= isHairColorOther ? 'block' : 'none' %>;">
                  <% if (fieldError('hair_color')) { %>
                    <p class="field-error" role="alert"><%= fieldError('hair_color') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldError('gender') ? 'has-error' : '' %>">
                  <label for="gender">GENDER</label>
                  <select id="gender" name="gender">
                    <option value="">Select...</option>
                    <option value="Male" <%= valueFor('gender', '') === 'Male' ? 'selected' : '' %>>Male</option>
                    <option value="Female" <%= valueFor('gender', '') === 'Female' ? 'selected' : '' %>>Female</option>
                    <option value="Non-binary" <%= valueFor('gender', '') === 'Non-binary' ? 'selected' : '' %>>Non-binary</option>
                    <option value="Other" <%= valueFor('gender', '') === 'Other' ? 'selected' : '' %>>Other</option>
                    <option value="Prefer not to say" <%= valueFor('gender', '') === 'Prefer not to say' ? 'selected' : '' %>>Prefer not to say</option>
                  </select>
                  <% if (fieldError('gender')) { %>
                    <p class="field-error" role="alert"><%= fieldError('gender') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('date_of_birth') ? 'has-error' : '' %>">
                  <label for="date_of_birth">DATE OF BIRTH</label>
                  <input id="date_of_birth" name="date_of_birth" type="date" value="<%= valueFor('date_of_birth', '') %>" max="<%= new Date(new Date().setFullYear(new Date().getFullYear() - 18)).toISOString().split('T')[0] %>">
                  <% if (fieldError('date_of_birth')) { %>
                    <p class="field-error" role="alert"><%= fieldError('date_of_birth') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('dress_size') ? 'has-error' : '' %>" id="dress-size-field">
                  <label for="dress_size">DRESS SIZE</label>
                  <input id="dress_size" name="dress_size" type="text" value="<%= valueFor('dress_size', '') %>" placeholder="6 US">
                  <% if (fieldError('dress_size')) { %>
                    <p class="field-error" role="alert"><%= fieldError('dress_size') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldError('weight') || fieldError('weight_unit') ? 'has-error' : '' %>">
                  <label for="weight">WEIGHT</label>
                  <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                    <input id="weight" name="weight" type="number" step="0.1" min="30" max="440" value="<%= valueFor('weight', '') || (valueFor('weight_kg', '') ? valueFor('weight_kg', '') : valueFor('weight_lbs', '')) %>" placeholder="143" style="flex: 1;">
                    <select id="weight_unit" name="weight_unit" style="width: auto; min-width: 80px;">
                      <option value="lbs" <%= (!valueFor('weight_unit', '') && valueFor('weight_kg', '')) ? '' : (valueFor('weight_unit', '') === 'lbs' ? 'selected' : (!valueFor('weight_lbs', '') ? 'selected' : '')) %>>lbs</option>
                      <option value="kg" <%= valueFor('weight_unit', '') === 'kg' ? 'selected' : '' %>>kg</option>
                    </select>
                  </div>
                  <input type="hidden" id="weight_kg" name="weight_kg" value="<%= valueFor('weight_kg', '') %>">
                  <input type="hidden" id="weight_lbs" name="weight_lbs" value="<%= valueFor('weight_lbs', '') %>">
                  <% if (fieldError('weight') || fieldError('weight_unit')) { %>
                    <p class="field-error" role="alert"><%= fieldError('weight') || fieldError('weight_unit') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('hair_length') ? 'has-error' : '' %>">
                  <label for="hair_length">HAIR LENGTH</label>
                  <select id="hair_length" name="hair_length">
                    <option value="">Select...</option>
                    <option value="Short" <%= valueFor('hair_length', '') === 'Short' ? 'selected' : '' %>>Short</option>
                    <option value="Medium" <%= valueFor('hair_length', '') === 'Medium' ? 'selected' : '' %>>Medium</option>
                    <option value="Long" <%= valueFor('hair_length', '') === 'Long' ? 'selected' : '' %>>Long</option>
                    <option value="Very Long" <%= valueFor('hair_length', '') === 'Very Long' ? 'selected' : '' %>>Very Long</option>
                  </select>
                  <% if (fieldError('hair_length')) { %>
                    <p class="field-error" role="alert"><%= fieldError('hair_length') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldError('skin_tone') ? 'has-error' : '' %>">
                  <label for="skin_tone">SKIN TONE</label>
                  <% 
                    const skinToneValue = valueFor('skin_tone', '');
                    const skinToneOptions = ['Fair', 'Light', 'Medium', 'Olive', 'Tan', 'Brown', 'Dark', 'Other'];
                    const isSkinToneOther = skinToneValue && !skinToneOptions.includes(skinToneValue);
                  %>
                  <select id="skin_tone" name="skin_tone">
                    <option value="">Select...</option>
                    <% skinToneOptions.filter(opt => opt !== 'Other').forEach(opt => { %>
                      <option value="<%= opt %>" <%= skinToneValue === opt ? 'selected' : '' %>><%= opt %></option>
                    <% }); %>
                    <option value="Other" <%= isSkinToneOther ? 'selected' : '' %>>Other</option>
                  </select>
                  <input type="text" id="skin_tone_other" name="skin_tone_other" value="<%= isSkinToneOther ? skinToneValue : '' %>" placeholder="Enter skin tone" style="margin-top: 0.5rem; display: <%= isSkinToneOther ? 'block' : 'none' %>;">
                  <% if (fieldError('skin_tone')) { %>
                    <p class="field-error" role="alert"><%= fieldError('skin_tone') %></p>
                  <% } %>
                </div>
              </div>
            </div>

            <!-- Step 2: EXPERIENCE -->
            <div class="form-step" data-step="2">
              <div class="form-field <%= fieldError('bio') ? 'has-error' : '' %>">
                <label for="bio">BIO</label>
                <p class="form-field__help">Tell us about your editorial focus. The Brain will refine this into third-person copy automatically.</p>
                <textarea id="bio" name="bio" rows="5" required placeholder="Tell us about your editorial focus."><%= valueFor('bio', '') %></textarea>
                <% if (fieldError('bio')) { %>
                  <p class="field-error" role="alert"><%= fieldError('bio') %></p>
                <% } %>
              </div>

              <div class="form-field">
                <label>EXPERIENCE</label>
                <p class="form-field__help">Select all that apply</p>
                <div class="checkbox-group" id="experience-checkboxes">
                  <% 
                    const specialtiesValue = valueFor('specialties', '');
                    const experienceDetailsValue = valueFor('experience_details', '');
                    let experienceDetailsObj = {};
                    if (experienceDetailsValue) {
                      try {
                        experienceDetailsObj = typeof experienceDetailsValue === 'string' ? JSON.parse(experienceDetailsValue) : experienceDetailsValue;
                      } catch (e) {
                        experienceDetailsObj = {};
                      }
                    }
                    const specialtiesArray = Array.isArray(specialtiesValue) ? specialtiesValue : (specialtiesValue ? [specialtiesValue] : []);
                    const hasSpecialty = (val) => specialtiesArray.includes(val);
                    const experienceOptions = ['Runway', 'Acting', 'Dancing', 'Music', 'Art', 'Content Creation'];
                  %>
                  <% experienceOptions.forEach(option => { %>
                    <label class="checkbox-label">
                      <input type="checkbox" name="specialties" value="<%= option %>" <%= hasSpecialty(option) ? 'checked' : '' %> data-experience="<%= option.toLowerCase().replace(/\s+/g, '-') %>">
                      <span><%= option %></span>
                    </label>
                  <% }); %>
                  <label class="checkbox-label">
                    <input type="checkbox" name="specialties" value="Other" <%= hasSpecialty('Other') ? 'checked' : '' %> data-experience="other">
                    <span>Other</span>
                  </label>
                </div>
                <div id="experience-details-container" style="margin-top: 1rem;"></div>
                <input type="hidden" id="experience_details" name="experience_details" value='<%= typeof experienceDetailsValue === "string" ? experienceDetailsValue : JSON.stringify(experienceDetailsObj) %>'>
              </div>

              <div class="form-field <%= fieldError('partner_agency_email') ? 'has-error' : '' %>">
                <label for="partner_agency_email">PARTNER AGENCY EMAIL <span class="muted">(optional)</span></label>
                <input id="partner_agency_email" name="partner_agency_email" type="email" value="<%= valueFor('partner_agency_email', '') %>">
                <% if (fieldError('partner_agency_email')) { %>
                  <p class="field-error" role="alert"><%= fieldError('partner_agency_email') %></p>
                <% } %>
              </div>

              <div class="form-field">
                <label>LANGUAGES</label>
                <p class="form-field__help">Add languages you speak</p>
                <% 
                  const languagesValue = valueFor('languages', '');
                  let languagesArray = [];
                  if (Array.isArray(languagesValue)) {
                    languagesArray = languagesValue;
                  } else if (typeof languagesValue === 'string') {
                    try {
                      languagesArray = JSON.parse(languagesValue);
                    } catch {
                      languagesArray = languagesValue ? languagesValue.split(',').map(l => l.trim()).filter(l => l) : [];
                    }
                  }
                  const languageOptions = ['English', 'Spanish', 'French', 'Italian', 'German', 'Portuguese', 'Mandarin', 'Japanese', 'Korean'];
                  const selectedLanguages = languagesArray.filter(l => languageOptions.includes(l));
                  const otherLanguages = languagesArray.filter(l => !languageOptions.includes(l));
                %>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <select id="add-language-select" style="flex: 1;">
                    <option value="">Select a language...</option>
                    <% languageOptions.forEach(lang => { %>
                      <option value="<%= lang %>" <%= selectedLanguages.includes(lang) ? 'disabled' : '' %>><%= lang %></option>
                    <% }); %>
                    <option value="Other">Other</option>
                  </select>
                  <button type="button" id="add-language-btn" class="button button-secondary" style="width: auto; padding: 0.5rem 1rem;">Add</button>
                </div>
                <input type="text" id="language-other-input" name="language_other_input" placeholder="Enter custom language" style="margin-bottom: 0.5rem; display: none; width: 100%; padding: 0.5rem;">
                <div id="selected-languages-container" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                  <% selectedLanguages.forEach(lang => { %>
                    <span class="language-tag" data-language="<%= lang %>" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: #f0f0f0; border-radius: 4px; font-size: 0.9rem;">
                      <%= lang %>
                      <button type="button" class="remove-language" data-language="<%= lang %>" style="background: none; border: none; cursor: pointer; font-size: 1.2rem; line-height: 1; color: #666;">&times;</button>
                    </span>
                  <% }); %>
                  <% otherLanguages.forEach(lang => { %>
                    <span class="language-tag" data-language="<%= lang %>" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: #f0f0f0; border-radius: 4px; font-size: 0.9rem;">
                      <%= lang %>
                      <button type="button" class="remove-language" data-language="<%= lang %>" style="background: none; border: none; cursor: pointer; font-size: 1.2rem; line-height: 1; color: #666;">&times;</button>
                    </span>
                  <% }); %>
                </div>
                <input type="hidden" id="languages" name="languages" value='<%= JSON.stringify(languagesArray) %>'>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldError('availability_travel') ? 'has-error' : '' %>">
                  <label>
                    <input type="checkbox" name="availability_travel" value="true" <%= valueFor('availability_travel', false) ? 'checked' : '' %>>
                    <span>Willing to travel</span>
                  </label>
                  <% if (fieldError('availability_travel')) { %>
                    <p class="field-error" role="alert"><%= fieldError('availability_travel') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('availability_schedule') ? 'has-error' : '' %>">
                  <label for="availability_schedule">AVAILABILITY</label>
                  <select id="availability_schedule" name="availability_schedule">
                    <option value="">Select...</option>
                    <option value="Full-time" <%= valueFor('availability_schedule', '') === 'Full-time' ? 'selected' : '' %>>Full-time</option>
                    <option value="Part-time" <%= valueFor('availability_schedule', '') === 'Part-time' ? 'selected' : '' %>>Part-time</option>
                    <option value="Flexible" <%= valueFor('availability_schedule', '') === 'Flexible' ? 'selected' : '' %>>Flexible</option>
                    <option value="Weekends only" <%= valueFor('availability_schedule', '') === 'Weekends only' ? 'selected' : '' %>>Weekends only</option>
                  </select>
                  <% if (fieldError('availability_schedule')) { %>
                    <p class="field-error" role="alert"><%= fieldError('availability_schedule') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldError('experience_level') ? 'has-error' : '' %>">
                  <label for="experience_level">EXPERIENCE LEVEL</label>
                  <select id="experience_level" name="experience_level">
                    <option value="">Select...</option>
                    <option value="Beginner" <%= valueFor('experience_level', '') === 'Beginner' ? 'selected' : '' %>>Beginner</option>
                    <option value="Intermediate" <%= valueFor('experience_level', '') === 'Intermediate' ? 'selected' : '' %>>Intermediate</option>
                    <option value="Experienced" <%= valueFor('experience_level', '') === 'Experienced' ? 'selected' : '' %>>Experienced</option>
                    <option value="Professional" <%= valueFor('experience_level', '') === 'Professional' ? 'selected' : '' %>>Professional</option>
                  </select>
                  <% if (fieldError('experience_level')) { %>
                    <p class="field-error" role="alert"><%= fieldError('experience_level') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('training') ? 'has-error' : '' %>">
                  <label for="training">TRAINING</label>
                  <textarea id="training" name="training" rows="3" placeholder="Formal training in modeling, acting, etc."><%= valueFor('training', '') %></textarea>
                  <% if (fieldError('training')) { %>
                    <p class="field-error" role="alert"><%= fieldError('training') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-field <%= fieldError('portfolio_url') ? 'has-error' : '' %>">
                <label for="portfolio_url">PORTFOLIO URL <span class="muted">(optional)</span></label>
                <input id="portfolio_url" name="portfolio_url" type="url" value="<%= valueFor('portfolio_url', '') %>" placeholder="https://yourportfolio.com">
                <% if (fieldError('portfolio_url')) { %>
                  <p class="field-error" role="alert"><%= fieldError('portfolio_url') %></p>
                <% } %>
              </div>

              <div class="form-section-divider"></div>
              <h4 class="form-section-title">Social Media</h4>
              <div class="form-grid">
                <div class="form-field <%= fieldError('instagram_handle') ? 'has-error' : '' %>">
                  <label for="instagram_handle">INSTAGRAM <span class="muted">(optional)</span></label>
                  <input id="instagram_handle" name="instagram_handle" type="text" value="<%= valueFor('instagram_handle', '') %>" placeholder="@username">
                  <% if (fieldError('instagram_handle')) { %>
                    <p class="field-error" role="alert"><%= fieldError('instagram_handle') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('twitter_handle') ? 'has-error' : '' %>">
                  <label for="twitter_handle">TWITTER/X <span class="muted">(optional)</span></label>
                  <input id="twitter_handle" name="twitter_handle" type="text" value="<%= valueFor('twitter_handle', '') %>" placeholder="@username">
                  <% if (fieldError('twitter_handle')) { %>
                    <p class="field-error" role="alert"><%= fieldError('twitter_handle') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('tiktok_handle') ? 'has-error' : '' %>">
                  <label for="tiktok_handle">TIKTOK <span class="muted">(optional)</span></label>
                  <input id="tiktok_handle" name="tiktok_handle" type="text" value="<%= valueFor('tiktok_handle', '') %>" placeholder="@username">
                  <% if (fieldError('tiktok_handle')) { %>
                    <p class="field-error" role="alert"><%= fieldError('tiktok_handle') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-section-divider"></div>
              <h4 class="form-section-title">Professional Reference</h4>
              <div class="form-grid">
                <div class="form-field <%= fieldError('reference_name') ? 'has-error' : '' %>">
                  <label for="reference_name">REFERENCE NAME <span class="muted">(optional)</span></label>
                  <input id="reference_name" name="reference_name" type="text" value="<%= valueFor('reference_name', '') %>" placeholder="John Doe">
                  <% if (fieldError('reference_name')) { %>
                    <p class="field-error" role="alert"><%= fieldError('reference_name') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('reference_email') ? 'has-error' : '' %>">
                  <label for="reference_email">REFERENCE EMAIL <span class="muted">(optional)</span></label>
                  <input id="reference_email" name="reference_email" type="email" value="<%= valueFor('reference_email', '') %>" placeholder="john@example.com">
                  <% if (fieldError('reference_email')) { %>
                    <p class="field-error" role="alert"><%= fieldError('reference_email') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('reference_phone') ? 'has-error' : '' %>">
                  <label for="reference_phone">REFERENCE PHONE <span class="muted">(optional)</span></label>
                  <input id="reference_phone" name="reference_phone" type="tel" value="<%= valueFor('reference_phone', '') %>" placeholder="+1 (555) 123-4567">
                  <% if (fieldError('reference_phone')) { %>
                    <p class="field-error" role="alert"><%= fieldError('reference_phone') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-section-divider"></div>
              <h4 class="form-section-title">Emergency Contact</h4>
              <div class="form-grid">
                <div class="form-field <%= fieldError('emergency_contact_name') ? 'has-error' : '' %>">
                  <label for="emergency_contact_name">EMERGENCY CONTACT NAME</label>
                  <input id="emergency_contact_name" name="emergency_contact_name" type="text" value="<%= valueFor('emergency_contact_name', '') %>" placeholder="Jane Doe">
                  <% if (fieldError('emergency_contact_name')) { %>
                    <p class="field-error" role="alert"><%= fieldError('emergency_contact_name') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('emergency_contact_phone') ? 'has-error' : '' %>">
                  <label for="emergency_contact_phone">EMERGENCY CONTACT PHONE</label>
                  <input id="emergency_contact_phone" name="emergency_contact_phone" type="tel" value="<%= valueFor('emergency_contact_phone', '') %>" placeholder="+1 (555) 123-4567">
                  <% if (fieldError('emergency_contact_phone')) { %>
                    <p class="field-error" role="alert"><%= fieldError('emergency_contact_phone') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('emergency_contact_relationship') ? 'has-error' : '' %>">
                  <label for="emergency_contact_relationship">RELATIONSHIP</label>
                  <input id="emergency_contact_relationship" name="emergency_contact_relationship" type="text" value="<%= valueFor('emergency_contact_relationship', '') %>" placeholder="Parent, Spouse, etc.">
                  <% if (fieldError('emergency_contact_relationship')) { %>
                    <p class="field-error" role="alert"><%= fieldError('emergency_contact_relationship') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-section-divider"></div>
              <h4 class="form-section-title">Previous Representation</h4>
              <% 
                const previousRepsValue = valueFor('previous_representations', '');
                let previousRepsArray = [];
                if (previousRepsValue) {
                  try {
                    previousRepsArray = typeof previousRepsValue === 'string' ? JSON.parse(previousRepsValue) : previousRepsValue;
                  } catch (e) {
                    previousRepsArray = [];
                  }
                }
                if (!Array.isArray(previousRepsArray)) previousRepsArray = [];
                if (previousRepsArray.length === 0) previousRepsArray = [{}];
              %>
              <div id="previous-representations-container">
                <% previousRepsArray.forEach((rep, index) => { %>
                  <div class="previous-representation-entry" data-index="<%= index %>" style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #e0e0e0; border-radius: 4px;">
                    <% if (previousRepsArray.length > 1) { %>
                      <button type="button" class="remove-rep-entry" data-index="<%= index %>" style="float: right; background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Remove</button>
                    <% } %>
                    <div class="form-grid">
                      <div class="form-field">
                        <label>
                          <input type="checkbox" name="previous_rep_<%= index %>_has_manager" value="true" <%= rep.has_manager ? 'checked' : '' %>>
                          <span>Had Manager</span>
                        </label>
                      </div>
                      <div class="form-field">
                        <label>
                          <input type="checkbox" name="previous_rep_<%= index %>_has_agency" value="true" <%= rep.has_agency ? 'checked' : '' %>>
                          <span>Had Agency</span>
                        </label>
                      </div>
                    </div>
                    <div class="form-grid" id="manager-fields-<%= index %>" style="display: <%= rep.has_manager ? 'flex' : 'none' %>;">
                      <div class="form-field">
                        <label>Manager Name</label>
                        <input type="text" name="previous_rep_<%= index %>_manager_name" value="<%= rep.manager_name || '' %>" placeholder="Manager name">
                      </div>
                      <div class="form-field">
                        <label>Manager Contact</label>
                        <input type="text" name="previous_rep_<%= index %>_manager_contact" value="<%= rep.manager_contact || '' %>" placeholder="Email or phone">
                      </div>
                    </div>
                    <div class="form-grid" id="agency-fields-<%= index %>" style="display: <%= rep.has_agency ? 'flex' : 'none' %>;">
                      <div class="form-field">
                        <label>Agency Name</label>
                        <input type="text" name="previous_rep_<%= index %>_agency_name" value="<%= rep.agency_name || '' %>" placeholder="Agency name">
                      </div>
                      <div class="form-field">
                        <label>Agent Name</label>
                        <input type="text" name="previous_rep_<%= index %>_agent_name" value="<%= rep.agent_name || '' %>" placeholder="Agent name">
                      </div>
                      <div class="form-field">
                        <label>Agency/Agent Contact</label>
                        <input type="text" name="previous_rep_<%= index %>_agency_contact" value="<%= rep.agency_contact || '' %>" placeholder="Email or phone">
                      </div>
                    </div>
                    <div class="form-field" style="margin-top: 0.75rem;">
                      <label>Reason for Leaving</label>
                      <textarea name="previous_rep_<%= index %>_reason_leaving" rows="2" placeholder="Reason for leaving..."><%= rep.reason_leaving || '' %></textarea>
                    </div>
                  </div>
                <% }); %>
              </div>
              <button type="button" id="add-previous-rep-btn" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">+ Add Another</button>
              <input type="hidden" id="previous_representations" name="previous_representations" value='<%= typeof previousRepsValue === "string" ? previousRepsValue : JSON.stringify(previousRepsArray) %>'>

              <div class="form-section-divider"></div>
              <h4 class="form-section-title">Additional Information</h4>
              <div class="form-grid">
                <div class="form-field <%= fieldError('work_eligibility') ? 'has-error' : '' %>">
                  <label for="work_eligibility">WORK ELIGIBILITY <span class="muted">(optional)</span></label>
                  <select id="work_eligibility" name="work_eligibility">
                    <option value="">Select...</option>
                    <option value="Yes" <%= valueFor('work_eligibility', '') === 'Yes' ? 'selected' : '' %>>Yes</option>
                    <option value="No" <%= valueFor('work_eligibility', '') === 'No' ? 'selected' : '' %>>No</option>
                  </select>
                  <% if (fieldError('work_eligibility')) { %>
                    <p class="field-error" role="alert"><%= fieldError('work_eligibility') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('work_status') ? 'has-error' : '' %>">
                  <label for="work_status">WORK STATUS <span class="muted">(optional)</span></label>
                  <% 
                    const workStatusValue = valueFor('work_status', '');
                    const workStatusOptions = ['Citizen', 'PR', 'Visa', 'Other'];
                    const isWorkStatusOther = workStatusValue && !workStatusOptions.includes(workStatusValue);
                  %>
                  <select id="work_status" name="work_status">
                    <option value="">Select...</option>
                    <% workStatusOptions.filter(opt => opt !== 'Other').forEach(opt => { %>
                      <option value="<%= opt %>" <%= workStatusValue === opt ? 'selected' : '' %>><%= opt %></option>
                    <% }); %>
                    <option value="Other" <%= isWorkStatusOther ? 'selected' : '' %>>Other</option>
                  </select>
                  <input type="text" id="work_status_other" name="work_status_other" value="<%= isWorkStatusOther ? workStatusValue : '' %>" placeholder="Enter work status" style="margin-top: 0.5rem; display: <%= isWorkStatusOther ? 'block' : 'none' %>;">
                  <% if (fieldError('work_status')) { %>
                    <p class="field-error" role="alert"><%= fieldError('work_status') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('union_membership') ? 'has-error' : '' %>">
                  <label for="union_membership">UNION MEMBERSHIP <span class="muted">(optional)</span></label>
                  <input id="union_membership" name="union_membership" type="text" value="<%= valueFor('union_membership', '') %>" placeholder="SAG-AFTRA, etc.">
                  <% if (fieldError('union_membership')) { %>
                    <p class="field-error" role="alert"><%= fieldError('union_membership') %></p>
                  <% } %>
                </div>
                <div class="form-field <%= fieldError('ethnicity') ? 'has-error' : '' %>">
                  <label for="ethnicity">ETHNICITY <span class="muted">(optional)</span></label>
                  <input id="ethnicity" name="ethnicity" type="text" value="<%= valueFor('ethnicity', '') %>" placeholder="Optional">
                  <% if (fieldError('ethnicity')) { %>
                    <p class="field-error" role="alert"><%= fieldError('ethnicity') %></p>
                  <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field">
                  <label>
                    <input type="checkbox" name="tattoos" value="true" <%= valueFor('tattoos', false) ? 'checked' : '' %>>
                    <span>Has visible tattoos</span>
                  </label>
                </div>
                <div class="form-field">
                  <label>
                    <input type="checkbox" name="piercings" value="true" <%= valueFor('piercings', false) ? 'checked' : '' %>>
                    <span>Has visible piercings</span>
                  </label>
                </div>
              </div>

              <div class="form-field">
                <label>COMFORT LEVEL</label>
                <p class="form-field__help">Select all that apply</p>
                <% 
                  const comfortLevelsValue = valueFor('comfort_levels', '');
                  let comfortLevelsArray = [];
                  if (Array.isArray(comfortLevelsValue)) {
                    comfortLevelsArray = comfortLevelsValue;
                  } else if (typeof comfortLevelsValue === 'string') {
                    try {
                      comfortLevelsArray = JSON.parse(comfortLevelsValue);
                    } catch {
                      comfortLevelsArray = comfortLevelsValue ? comfortLevelsValue.split(',').map(c => c.trim()).filter(c => c) : [];
                    }
                  }
                  const hasComfortLevel = (val) => comfortLevelsArray.includes(val);
                  const comfortOptions = ['Swimwear', 'Lingerie', 'Implied Nudity', 'Not Comfortable'];
                %>
                <div class="checkbox-group">
                  <% comfortOptions.forEach(option => { %>
                    <label class="checkbox-label">
                      <input type="checkbox" name="comfort_levels" value="<%= option %>" <%= hasComfortLevel(option) ? 'checked' : '' %>>
                      <span><%= option %></span>
                    </label>
                  <% }); %>
                </div>
              </div>
            </div>

            <!-- Step 3: PHOTOS -->
            <div class="form-step" data-step="3">
              <!-- Digitals - Mandatory First Section -->
              <div class="form-field">
                <label for="digitals">DIGITALS <span style="color: #dc3545;">*</span></label>
                <p class="form-field__help">Upload high-resolution digitals. JPEG, PNG, or WebP. Maximum 10MB per image.</p>
                <div class="file-upload-area" id="digitals-upload-area">
                  <input type="file" id="digitals" name="digitals" accept="image/jpeg,image/png,image/webp" multiple>
                  <div class="file-upload-dropzone">
                    <p class="file-upload-text">Drag and drop images here, or <span class="file-upload-link">browse</span></p>
                    <p class="file-upload-hint">You can select multiple files</p>
                  </div>
                  <div class="file-preview-grid" id="digitals-preview-grid"></div>
                </div>
              </div>

              <!-- Experience-specific upload blocks (auto-generated) -->
              <div id="experience-uploads-container"></div>

              <!-- Additional Images - Optional -->
              <div class="form-field" style="margin-top: 2rem;">
                <label for="additional_images">ADDITIONAL IMAGES <span class="muted">(optional)</span></label>
                <p class="form-field__help">Upload any additional images for your portfolio.</p>
                <div class="file-upload-area" id="additional-images-upload-area">
                  <input type="file" id="additional_images" name="additional_images" accept="image/jpeg,image/png,image/webp" multiple>
                  <div class="file-upload-dropzone">
                    <p class="file-upload-text">Drag and drop images here, or <span class="file-upload-link">browse</span></p>
                    <p class="file-upload-hint">You can select multiple files</p>
                  </div>
                  <div class="file-preview-grid" id="additional-images-preview-grid"></div>
                </div>
              </div>
            </div>

            <!-- Step 4: REVIEW & ACCOUNT CREATION -->
            <div class="form-step" data-step="4">
              <div class="review-summary">
                <h3>Review Your Application</h3>
                <div class="review-section">
                  <h4>Account Information</h4>
                  <dl>
                    <dt>Name:</dt>
                    <dd id="review-name"></dd>
                    <dt>Phone:</dt>
                    <dd id="review-phone"></dd>
                  </dl>
                </div>
                
                <% if (!userIsLoggedIn) { %>
                <div class="review-section" style="border-top: 1px solid rgba(15, 23, 42, 0.1); padding-top: 1.5rem; margin-top: 1.5rem;">
                  <h4>Create Your Account</h4>
                  <p style="margin-bottom: 1.5rem; color: rgba(15, 23, 42, 0.7); font-size: 0.9rem;">Save your profile by creating an account. You'll be able to update your portfolio and apply to agencies.</p>
                  <div class="form-grid">
                    <div class="form-field <%= fieldError('email') ? 'has-error' : '' %>">
                      <label for="email">EMAIL</label>
                      <input id="email" name="email" type="email" autocomplete="email" value="<%= valueFor('email', '') %>" required>
                      <% if (fieldError('email')) { %>
                        <p class="field-error" role="alert"><%= fieldError('email') %></p>
                      <% } %>
                    </div>
                  </div>
                  <div class="form-grid">
                    <div class="form-field <%= fieldError('password') ? 'has-error' : '' %>">
                      <label for="password">PASSWORD</label>
                      <input id="password" name="password" type="password" autocomplete="new-password" value="<%= valueFor('password', '') %>" required minlength="8">
                      <% if (fieldError('password')) { %>
                        <p class="field-error" role="alert"><%= fieldError('password') %></p>
                      <% } %>
                      <p class="form-field__help">Minimum 8 characters</p>
                    </div>
                    <div class="form-field <%= fieldError('password_confirm') ? 'has-error' : '' %>">
                      <label for="password_confirm">CONFIRM PASSWORD</label>
                      <input id="password_confirm" name="password_confirm" type="password" autocomplete="new-password" value="<%= valueFor('password_confirm', '') %>" required minlength="8">
                      <% if (fieldError('password_confirm')) { %>
                        <p class="field-error" role="alert"><%= fieldError('password_confirm') %></p>
                      <% } %>
                    </div>
                  </div>
                </div>
                <% } %>
                <div class="review-section">
                  <h4>Physical Stats</h4>
                  <dl>
                    <dt>City:</dt>
                    <dd id="review-city"></dd>
                    <dt>Gender:</dt>
                    <dd id="review-gender"></dd>
                    <dt>Date of Birth:</dt>
                    <dd id="review-date-of-birth"></dd>
                    <dt>Age:</dt>
                    <dd id="review-age"></dd>
                    <dt>Height:</dt>
                    <dd id="review-height"></dd>
                    <dt>Weight:</dt>
                    <dd id="review-weight"></dd>
                    <dt>Dress Size:</dt>
                    <dd id="review-dress-size"></dd>
                    <dt>Bust:</dt>
                    <dd id="review-bust"></dd>
                    <dt>Waist:</dt>
                    <dd id="review-waist"></dd>
                    <dt>Hips:</dt>
                    <dd id="review-hips"></dd>
                    <dt>Shoe Size:</dt>
                    <dd id="review-shoe-size"></dd>
                    <dt>Eye Color:</dt>
                    <dd id="review-eye-color"></dd>
                    <dt>Hair Color:</dt>
                    <dd id="review-hair-color"></dd>
                    <dt>Hair Length:</dt>
                    <dd id="review-hair-length"></dd>
                    <dt>Skin Tone:</dt>
                    <dd id="review-skin-tone"></dd>
                  </dl>
                </div>
                <div class="review-section">
                  <h4>Experience</h4>
                  <dl>
                    <dt>Bio:</dt>
                    <dd id="review-bio"></dd>
                    <dt>Specialties:</dt>
                    <dd id="review-specialties"></dd>
                    <dt>Languages:</dt>
                    <dd id="review-languages"></dd>
                    <dt>Availability:</dt>
                    <dd id="review-availability"></dd>
                    <dt>Experience Level:</dt>
                    <dd id="review-experience-level"></dd>
                    <dt>Training:</dt>
                    <dd id="review-training"></dd>
                    <dt>Portfolio URL:</dt>
                    <dd id="review-portfolio-url"></dd>
                    <dt>Social Media:</dt>
                    <dd id="review-social-media"></dd>
                  </dl>
                </div>
                <div class="review-section">
                  <h4>Additional Information</h4>
                  <dl>
                    <dt>Work Eligibility:</dt>
                    <dd id="review-work-eligibility"></dd>
                    <dt>Work Status:</dt>
                    <dd id="review-work-status"></dd>
                    <dt>Union Membership:</dt>
                    <dd id="review-union-membership"></dd>
                    <dt>Ethnicity:</dt>
                    <dd id="review-ethnicity"></dd>
                    <dt>Tattoos:</dt>
                    <dd id="review-tattoos"></dd>
                    <dt>Piercings:</dt>
                    <dd id="review-piercings"></dd>
                  </dl>
                </div>
                <div class="review-section">
                  <h4>Photos</h4>
                  <p id="review-photos-count">0 images selected</p>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="button button-secondary" id="prev-button" disabled>Previous</button>
              <button type="button" class="button button-primary" id="next-button" data-loading-text="<%= userIsLoggedIn ? 'Saving applicationâ€¦' : 'Creating accountâ€¦' %>">Next</button>
            </div>
          </form>

          <p class="apply-note">Uploads happen nextâ€”have 2-6 high-resolution portraits ready for the dashboard.</p>
        </div>
      </div>
    </div>
</section>
