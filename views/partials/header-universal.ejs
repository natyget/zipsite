<% 
  // Access variables from parent scope
  const user = typeof currentUser !== 'undefined' && currentUser ? currentUser : null;
  const page = typeof currentPage !== 'undefined' ? currentPage : '';
  const isHomepageFlag = typeof isHomepage !== 'undefined' && isHomepage === true;
  const userProfile = typeof profile !== 'undefined' && profile ? profile : null;
%>
<header class="universal-header <%= isHomepageFlag ? 'universal-header--homepage' : '' %>" role="banner">
  <div class="universal-header__inner">
    <a class="universal-header__logo" href="/">PHOLIO</a>
    
    <button class="universal-header__menu-toggle" aria-expanded="false" aria-controls="universalNav" aria-label="Toggle navigation">
      <span></span>
      <span></span>
      <span></span>
    </button>
    
    <nav class="universal-header__nav" aria-label="Primary">
      <ul>
        <li><a href="/" <%= page === '/' || page === 'home' ? 'aria-current="page"' : '' %>>Home</a></li>
        <li><a href="/features" <%= page === 'features' ? 'aria-current="page"' : '' %>>Features</a></li>
        <li><a href="/pricing" <%= page === 'pricing' ? 'aria-current="page"' : '' %>>Pricing</a></li>
        <li><a href="/pro" <%= page === 'pro' ? 'aria-current="page"' : '' %>>Studio+</a></li>
        <li><a href="/press" <%= page === 'press' ? 'aria-current="page"' : '' %>>Press</a></li>
      </ul>
    </nav>

    <div class="universal-header__actions">
      <% if (user && user.id && user.role) { %>
        <% 
          const dashboardHref = user.role === 'AGENCY' ? '/dashboard/agency' : '/dashboard/talent';
          // Get user name from profile or fallback to email
          let displayName = '';
          let userInitial = 'U';
          if (userProfile && userProfile.first_name && userProfile.last_name) {
            displayName = userProfile.first_name + ' ' + userProfile.last_name;
            userInitial = userProfile.first_name.charAt(0).toUpperCase();
          } else if (userProfile && userProfile.first_name) {
            displayName = userProfile.first_name;
            userInitial = userProfile.first_name.charAt(0).toUpperCase();
          } else if (user.email) {
            displayName = user.email.split('@')[0];
            userInitial = user.email.charAt(0).toUpperCase();
          }
          const roleLabel = user.role === 'AGENCY' ? 'Agency' : 'Talent';
        %>
        <div class="universal-header__user-wrapper">
          <div class="universal-header__user-dropdown">
            <button type="button" class="universal-header__user" data-initial="<%= userInitial %>" aria-label="User menu" aria-expanded="false" id="universal-user-menu-button">
              <span class="universal-header__user-name"><%= displayName %></span>
              <span class="universal-header__badge universal-header__badge--role"><%= roleLabel %></span>
              <% if (userProfile && userProfile.is_pro) { %>
                <span class="universal-header__badge universal-header__badge--pro">Studio+</span>
              <% } else if (userProfile && !userProfile.is_pro) { %>
                <span class="universal-header__badge universal-header__badge--free">Free</span>
              <% } %>
              <svg class="universal-header__user-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="universal-header__user-menu" id="universal-user-menu" role="menu" aria-labelledby="universal-user-menu-button">
              <!-- User Info Header -->
              <div class="universal-header__user-menu-header">
                <div class="universal-header__user-menu-avatar" data-initial="<%= userInitial %>"></div>
                <div class="universal-header__user-menu-info">
                  <div class="universal-header__user-menu-name"><%= displayName %></div>
                  <div class="universal-header__user-menu-email"><%= user.email %></div>
                  <div class="universal-header__user-menu-role"><%= roleLabel %></div>
                </div>
              </div>
              <div class="universal-header__user-menu-divider"></div>
              <a href="<%= dashboardHref %>" class="universal-header__user-menu-item" role="menuitem">
                <svg class="universal-header__user-menu-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M2 8C2 10.2091 3.79086 12 6 12C7.86384 12 9.42994 10.7252 9.87398 9H14V7H9.87398C9.42994 5.27477 7.86384 4 6 4C3.79086 4 2 5.79086 2 8Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M14 8C14 10.2091 12.2091 12 10 12C8.13616 12 6.57006 10.7252 6.12602 9H2V7H6.12602C6.57006 5.27477 8.13616 4 10 4C12.2091 4 14 5.79086 14 8Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Dashboard</span>
              </a>
              <a href="/dashboard/settings" class="universal-header__user-menu-item" role="menuitem">
                <svg class="universal-header__user-menu-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 10C9.10457 10 10 9.10457 10 8C10 6.89543 9.10457 6 8 6C6.89543 6 6 6.89543 6 8C6 9.10457 6.89543 10 8 10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M13.6569 10.3431C13.8447 10.5309 13.9492 10.7852 13.9492 11.0503C13.9492 11.3153 13.8447 11.5696 13.6569 11.7574L11.7574 13.6569C11.5696 13.8447 11.3153 13.9492 11.0503 13.9492C10.7852 13.9492 10.5309 13.8447 10.3431 13.6569L2.34315 5.65685C2.15536 5.46906 2.05086 5.21481 2.05086 4.94975C2.05086 4.68469 2.15536 4.43044 2.34315 4.24264L4.24264 2.34315C4.43044 2.15536 4.68469 2.05086 4.94975 2.05086C5.21481 2.05086 5.46906 2.15536 5.65685 2.34315L13.6569 10.3431Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Settings</span>
              </a>
              <form method="post" action="/logout" class="universal-header__user-menu-item-form">
                <button type="submit" class="universal-header__user-menu-item universal-header__user-menu-item--logout" role="menuitem">
                  <svg class="universal-header__user-menu-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 14H3.33333C2.59695 14 2 13.403 2 12.6667V3.33333C2 2.59695 2.59695 2 3.33333 2H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10 11.3333L14 8L10 4.66667" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span>Logout</span>
                </button>
              </form>
            </div>
          </div>
        </div>
      <% } else { %>
        <a class="universal-header__link" href="/login">Login</a>
        <a class="universal-header__cta universal-header__cta--primary" href="/apply">Start Creating</a>
      <% } %>
    </div>
  </div>
  
  <div class="universal-header__nav-panel" id="universalNav" aria-hidden="true" hidden>
    <div class="universal-header__nav-panel-inner">
      <div class="universal-header__nav-panel-top">
        <span class="universal-header__nav-panel-logo">PHOLIO</span>
        <button class="universal-header__close" type="button" aria-label="Close menu">
          <span></span>
          <span></span>
        </button>
      </div>

      <% if (user && user.id && user.role) { %>
        <% 
          // Get user name from profile or fallback to email
          let mobileDisplayName = '';
          let mobileUserInitial = 'U';
          if (userProfile && userProfile.first_name && userProfile.last_name) {
            mobileDisplayName = userProfile.first_name + ' ' + userProfile.last_name;
            mobileUserInitial = userProfile.first_name.charAt(0).toUpperCase();
          } else if (userProfile && userProfile.first_name) {
            mobileDisplayName = userProfile.first_name;
            mobileUserInitial = userProfile.first_name.charAt(0).toUpperCase();
          } else if (user.email) {
            mobileDisplayName = user.email.split('@')[0];
            mobileUserInitial = user.email.charAt(0).toUpperCase();
          }
          const mobileRoleLabel = user.role === 'AGENCY' ? 'Agency' : 'Talent';
        %>
        <div class="universal-header__mobile-user">
          <div class="universal-header__mobile-avatar" data-initial="<%= mobileUserInitial %>"></div>
          <div class="universal-header__mobile-user-info">
            <span class="universal-header__mobile-user-name"><%= mobileDisplayName %></span>
            <span class="universal-header__mobile-user-email"><%= user.email %></span>
            <div class="universal-header__mobile-user-badges">
              <span class="universal-header__badge universal-header__badge--role"><%= mobileRoleLabel %></span>
              <% if (userProfile && userProfile.is_pro) { %>
                <span class="universal-header__badge universal-header__badge--pro">Studio+</span>
              <% } else if (userProfile && !userProfile.is_pro) { %>
                <span class="universal-header__badge universal-header__badge--free">Free</span>
              <% } %>
            </div>
          </div>
        </div>
      <% } %>

      <nav class="universal-header__mobile-nav" aria-label="Primary">
        <ul>
          <li>
            <a href="/" <%= page === '/' || page === 'home' ? 'aria-current="page"' : '' %>>
              <svg class="universal-header__mobile-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              <span>Home</span>
            </a>
          </li>
          <li>
            <a href="/features" <%= page === 'features' ? 'aria-current="page"' : '' %>>
              <svg class="universal-header__mobile-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              <span>Features</span>
            </a>
          </li>
          <li>
            <a href="/pricing" <%= page === 'pricing' ? 'aria-current="page"' : '' %>>
              <svg class="universal-header__mobile-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
              <span>Pricing</span>
            </a>
          </li>
          <li>
            <a href="/pro" <%= page === 'pro' ? 'aria-current="page"' : '' %>>
              <svg class="universal-header__mobile-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
              <span>Studio+</span>
            </a>
          </li>
          <li>
            <a href="/press" <%= page === 'press' ? 'aria-current="page"' : '' %>>
              <svg class="universal-header__mobile-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
              </svg>
              <span>Press</span>
            </a>
          </li>
        </ul>
      </nav>

      <div class="universal-header__mobile-actions">
        <% if (user && user.id && user.role) { %>
          <% const dashboardHref = user.role === 'AGENCY' ? '/dashboard/agency' : '/dashboard/talent'; %>
          <a href="<%= dashboardHref %>" class="universal-header__mobile-link">Go to Dashboard</a>
          <a href="/dashboard/settings" class="universal-header__mobile-link">Settings</a>
          <form method="post" action="/logout" class="universal-header__mobile-logout">
            <button type="submit">Logout</button>
          </form>
        <% } else { %>
          <a href="/login" class="universal-header__mobile-link">Login</a>
          <a class="universal-header__cta universal-header__cta--primary universal-header__mobile-cta" href="/apply">Start Creating</a>
        <% } %>
      </div>
    </div>
  </div>
</header>
<div class="universal-header__overlay" id="universalNavOverlay" hidden aria-hidden="true"></div>

