<%- include('../partials/forms', { errors, values }) %>
<% const _errors=(typeof errors==='object' && errors) ? errors : {}; const _values=(typeof values==='object' && values) ? values : {}; const valueFor=(name, fallback='')=> {
  if (Object.prototype.hasOwnProperty.call(_values, name) && _values[name] != null) {
    return _values[name];
  }
  return fallback;
};

const fieldError = (name) => {
  const v = _errors[name];
  if (!v) return '';
  return Array.isArray(v) ? v[0] : v;
};
%>
<section class="auth-page">
  <div class="auth-page__visual">
    <div class="auth-page__visual-content">
      <span class="auth-page__visual-badge">Sign In</span>
      <h1 class="auth-page__visual-headline">
        <span class="auth-page__visual-headline-fashion">Welcome back.</span>
        <span class="auth-page__visual-headline-ai">Your editorial studio.</span>
      </h1>
      <p class="auth-page__visual-tagline">Access your dashboard, refresh your comp card, and keep your book in sync with every update.</p>
      <div class="auth-page__visual-accent"></div>
    </div>
  </div>
  
  <div class="auth-page__form">
    <div class="auth-page__form-container">
      <div class="auth-page__form-header">
        <h2 class="auth-page__form-title">Sign in</h2>
        <p class="auth-page__form-subtitle">Enter your credentials to continue</p>
      </div>
      
      <div class="auth-card" role="form">
        <form method="post" action="/login" class="form" data-async>
          <input type="hidden" name="next" value="<%= valueFor('next', '') %>">
          
          <div class="form-field <%= fieldError('email') ? 'has-error' : '' %>">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="email" value="<%= valueFor('email', '') %>">
            <% if (fieldError('email')) { %>
              <p class="field-error" role="alert"><%= fieldError('email') %></p>
            <% } %>
          </div>
          
          <div class="form-field <%= fieldError('password') ? 'has-error' : '' %>">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" autocomplete="current-password">
            <% if (fieldError('password')) { %>
              <p class="field-error" role="alert"><%= fieldError('password') %></p>
            <% } %>
          </div>
          
          <input type="hidden" name="firebase_token" id="firebase_token">
          <button type="submit" class="button button-primary button-block" data-loading-text="Signing in‚Ä¶">Sign in</button>
        </form>
        
        <div class="auth-divider">
          <span>or</span>
        </div>
        
        <button type="button" id="google-signin-btn" class="button button-google button-block" data-loading-text="Signing in‚Ä¶">
          <svg width="18" height="18" viewBox="0 0 18 18" style="margin-right: 8px; vertical-align: middle;">
            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
            <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.348 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>
            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.293C4.672 5.163 6.656 3.58 9 3.58z"/>
          </svg>
          Sign in with Google
        </button>
        
        <p class="auth-switch">Need an account? <a href="/apply">Start Creating</a>.</p>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  const loginForm = document.querySelector('form[action="/login"]');
  const googleSignInBtn = document.getElementById('google-signin-btn');
  if (!loginForm) return;

  // Check for redirect result (when user returns from Google Sign-In redirect)
  try {
    if (window.FirebaseAuth && typeof window.FirebaseAuth.getRedirectResult === 'function') {
      console.log('[Login] Checking for redirect result...');
      const redirectResult = await window.FirebaseAuth.getRedirectResult();
      
      if (redirectResult && redirectResult.user) {
        console.log('[Login] ‚úÖ Redirect sign-in successful, processing...');
        
        // Show loading state
        if (googleSignInBtn) {
          googleSignInBtn.disabled = true;
          googleSignInBtn.innerHTML = '<span>Signing in‚Ä¶</span>';
        }
        
        try {
          // Get ID token
          const idToken = await redirectResult.user.getIdToken();
          const email = redirectResult.user.email;
          
          console.log('[Login] Got Firebase token from redirect:', {
            hasToken: !!idToken,
            tokenLength: idToken ? idToken.length : 0,
            email: email
          });
          
          if (!idToken) {
            throw new Error('Failed to get authentication token');
          }
          
          // Populate email field
          const emailInput = loginForm.querySelector('#email');
          if (emailInput && email) {
            emailInput.value = email;
          }
          
          // Populate password field with dummy value (not used for Google Sign-In)
          const passwordInput = loginForm.querySelector('#password');
          if (passwordInput) {
            passwordInput.value = 'google-sign-in';
          }
          
          // Submit to backend - handleLogin will handle the response and redirect
          console.log('[Login] üîµ Calling handleLogin with redirect token...');
          handleLogin(idToken);
          // Note: handleLogin is async but we don't await it here because it handles redirect internally
        } catch (tokenError) {
          console.error('[Login] ‚ùå Error getting token from redirect result:', tokenError);
          resetButtons();
          showError('Failed to complete sign-in. Please try again.');
        }
      } else {
        console.log('[Login] No redirect result found, continuing with normal flow');
      }
    }
  } catch (redirectError) {
    console.error('[Login] Error checking redirect result:', redirectError);
    // Don't show error - user might just be visiting the page normally
    if (redirectError.code && redirectError.code !== 'auth/no-auth-event') {
      showError('Error processing Google Sign-In. Please try again.');
    }
  }

  // Function to handle login submission (used by both email/password and Google)
  function handleLogin(idToken) {
    // Validate Firebase token is present
    if (!idToken || typeof idToken !== 'string' || idToken.trim() === '') {
      console.error('[Login] ‚ùå Firebase token is missing or invalid!');
      showError('Authentication failed. Please try signing in again.');
      return;
    }
    
    // Submit as JSON to ensure Firebase token is properly sent
    const emailInput = loginForm.querySelector('#email');
    const passwordInput = loginForm.querySelector('#password');
    const nextInput = loginForm.querySelector('input[name="next"]');
    const firebaseTokenInput = loginForm.querySelector('#firebase_token');
    
    // Also store token in hidden input field for redundancy
    if (firebaseTokenInput) {
      firebaseTokenInput.value = idToken;
    }
    
    const payload = {
      firebase_token: idToken,
      email: emailInput?.value || '',
      password: passwordInput?.value || '',
      next: nextInput?.value || ''
    };
    
    console.log('[Login] Submitting login request:', {
      hasToken: !!idToken,
      tokenLength: idToken ? idToken.length : 0,
      tokenPreview: idToken ? `${idToken.substring(0, 30)}...` : 'MISSING',
      hasEmail: !!payload.email,
      hasPassword: !!payload.password,
      hasNext: !!payload.next,
      action: loginForm.action,
      contentType: 'application/json'
    });
    
    // Submit via POST as JSON
    console.log('[Login] üîµ Sending fetch request to:', loginForm.action);
    
    // Create AbortController for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
    
    fetch(loginForm.action, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
      credentials: 'same-origin', // Include cookies for session
      signal: controller.signal
    })
    .then(async response => {
      console.log('[Login] üì• Response received:', {
        status: response.status,
        statusText: response.statusText,
        ok: response.ok,
        redirected: response.redirected,
        url: response.url,
        location: response.headers.get('location'),
        contentType: response.headers.get('content-type')
      });
      
      // Always expect JSON response from backend
      const contentType = response.headers.get('content-type') || '';
      
      // Clear timeout on successful response
      clearTimeout(timeoutId);
      
      if (response.ok) {
        // Success response - should be JSON with redirect URL
        if (contentType.includes('application/json')) {
          try {
            const data = await response.json();
            console.log('[Login] Success response:', data);
            
            // Handle different response formats
            let redirectUrl = null;
            
            if (data.success && data.redirect) {
              redirectUrl = data.redirect;
            } else if (data.redirect) {
              // Some responses might just have redirect without success flag
              redirectUrl = data.redirect;
            } else if (data.url) {
              // Fallback to url field
              redirectUrl = data.url;
            }
            
            if (redirectUrl) {
              console.log('[Login] ‚úÖ Redirecting to:', redirectUrl);
              // Reset button state before redirect
              resetButtons();
              // Small delay to ensure session is set, then redirect
              setTimeout(() => {
                console.log('[Login] üöÄ Executing redirect to:', redirectUrl);
                window.location.href = redirectUrl;
              }, 150);
            } else {
              console.error('[Login] ‚ùå No redirect URL in response:', data);
              // Try to determine redirect based on user role if available
              const defaultRedirect = '/dashboard/talent';
              console.warn('[Login] Using default redirect:', defaultRedirect);
              resetButtons();
              setTimeout(() => {
                console.log('[Login] üöÄ Executing default redirect to:', defaultRedirect);
                window.location.href = defaultRedirect;
              }, 150);
            }
          } catch (e) {
            console.error('[Login] ‚ùå Error parsing JSON response:', e);
            // Even if JSON parsing fails, try to redirect to default dashboard
            console.warn('[Login] Attempting default redirect after JSON parse error');
            resetButtons();
            setTimeout(() => {
              console.log('[Login] üöÄ Executing fallback redirect');
              window.location.href = '/dashboard/talent';
            }, 150);
          }
        } else {
          // Not JSON - might be HTML redirect or other format
          console.warn('[Login] Non-JSON response received');
          const locationHeader = response.headers.get('location');
          const redirectUrl = locationHeader || '/dashboard/talent';
          console.log('[Login] Attempting redirect to:', redirectUrl);
          resetButtons();
          setTimeout(() => {
            console.log('[Login] üöÄ Executing non-JSON redirect');
            window.location.href = redirectUrl;
          }, 150);
        }
      } else {
        // Error response - parse JSON error
        if (contentType.includes('application/json')) {
          try {
            const errorData = await response.json();
            console.error('[Login] Error response (JSON):', errorData);
            
            resetButtons();
            
            if (errorData.errors) {
              // Show validation errors
              const errorMessages = Object.values(errorData.errors).flat();
              showError(errorMessages.join(', '));
            } else if (errorData.error) {
              showError(errorData.error);
            } else {
              showError('Authentication failed. Please try again.');
            }
          } catch (e) {
            console.error('[Login] Error parsing JSON error response:', e);
            showError('An error occurred. Please try again.');
            resetButtons();
          }
        } else {
          // HTML error response - show generic error
          console.error('[Login] HTML error response received');
          showError('Authentication failed. Please check your credentials and try again.');
          resetButtons();
        }
      }
    })
    .catch(error => {
      // Clear timeout if error occurs
      clearTimeout(timeoutId);
      
      console.error('[Login] ‚ùå Network or submission error:', error);
      console.error('[Login] Error details:', {
        name: error.name,
        message: error.message,
        stack: error.stack
      });
      
      resetButtons();
      
      // Provide more specific error messages
      if (error.name === 'AbortError') {
        showError('Request timed out. Please check your connection and try again.');
      } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
        showError('Network error. Please check your internet connection and try again.');
      } else {
        showError('An error occurred during sign-in. Please try again. If the problem persists, contact support.');
      }
    });
  }

  // Function to show error
  function showError(message) {
    let errorDisplay = loginForm.querySelector('.auth-error');
    if (!errorDisplay) {
      errorDisplay = document.createElement('div');
      errorDisplay.className = 'auth-error field-error';
      errorDisplay.style.cssText = 'margin-bottom: 1rem; padding: 0.75rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;';
      loginForm.insertBefore(errorDisplay, loginForm.firstChild);
    }
    errorDisplay.textContent = message;
    errorDisplay.style.display = 'block';
  }

  // Function to reset button states
  function resetButtons() {
    const submitButton = loginForm.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.disabled = false;
      submitButton.textContent = submitButton.dataset.originalText || 'Sign in';
    }
    if (googleSignInBtn) {
      googleSignInBtn.disabled = false;
      // Restore original button HTML with SVG icon
      const originalHTML = googleSignInBtn.dataset.originalText || 
        '<svg width="18" height="18" viewBox="0 0 18 18" style="margin-right: 8px; vertical-align: middle;"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.348 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.293C4.672 5.163 6.656 3.58 9 3.58z"/></svg>Sign in with Google';
      googleSignInBtn.innerHTML = originalHTML;
    }
  }

  // Email/Password login
  loginForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const email = loginForm.querySelector('#email').value.trim();
    const password = loginForm.querySelector('#password').value;
    const submitButton = loginForm.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;

    // Validate email/password for traditional login
    if (!email || !password) {
      alert('Please enter your email and password.');
      return;
    }

    // Check if Firebase Auth is available
    if (!window.FirebaseAuth || typeof window.FirebaseAuth.signIn !== 'function') {
      console.error('[Login] Firebase Auth not initialized');
      console.error('[Login] Firebase Auth available:', !!window.FirebaseAuth);
      
      // Provide more helpful error message
      let errorMsg = 'Authentication system not ready. ';
      if (!window.firebaseAuth) {
        errorMsg += 'Firebase is initializing. Please wait a moment and try again.';
      } else {
        errorMsg += 'Please refresh the page and try again.';
      }
      
      alert(errorMsg);
      return;
    }

    try {
      // Store original button text if not already stored
      if (!submitButton.dataset.originalText) {
        submitButton.dataset.originalText = submitButton.textContent;
      }
      
      // Show loading state
      submitButton.disabled = true;
      submitButton.textContent = submitButton.dataset.loadingText || 'Signing in‚Ä¶';

      // Sign in with Firebase
      const userCredential = await window.FirebaseAuth.signIn(email, password);
      
      // Get ID token
      const idToken = await userCredential.user.getIdToken();
      
      console.log('[Login] Email/password sign-in successful, got Firebase token:', {
        hasToken: !!idToken,
        tokenLength: idToken ? idToken.length : 0
      });
      
      // Submit form to backend
      handleLogin(idToken);
    } catch (error) {
      console.error('[Login] Authentication error:', error);
      
      // Reset button state
      submitButton.disabled = false;
      submitButton.textContent = submitButton.dataset.originalText || originalText;

      // Show error message
      const errorMessage = window.getFirebaseErrorMessage ? window.getFirebaseErrorMessage(error) : error.message || 'Authentication failed. Please try again.';
      showError(errorMessage);
    }
  });

  // Google Sign-In
  if (googleSignInBtn) {
    googleSignInBtn.addEventListener('click', async function() {
      // Check if Firebase Auth is available
      if (!window.FirebaseAuth) {
        console.error('[Login] ‚ùå window.FirebaseAuth is not defined');
        showError('Authentication system not ready. Please refresh the page and try again.');
        return;
      }
      
      if (typeof window.FirebaseAuth.signInWithGoogle !== 'function') {
        console.error('[Login] ‚ùå signInWithGoogle function not available');
        console.error('[Login] Available methods:', Object.keys(window.FirebaseAuth));
        showError('Authentication system not ready. Please refresh the page and try again.');
        return;
      }
      
      // Check if Firebase auth instance is ready
      try {
        const auth = await window.FirebaseAuth.getAuth();
        if (!auth) {
          console.error('[Login] ‚ùå Firebase auth instance not available');
          showError('Firebase authentication is not initialized. Please refresh the page.');
          return;
        }
        console.log('[Login] ‚úÖ Firebase auth instance ready');
      } catch (authError) {
        console.error('[Login] ‚ùå Error getting Firebase auth instance:', authError);
        showError('Firebase authentication is not ready. Please refresh the page and try again.');
        return;
      }

      // Check if popups might be blocked (heuristic check)
      try {
        const testPopup = window.open('', '_blank', 'width=1,height=1');
        if (!testPopup || testPopup.closed || typeof testPopup.closed === 'undefined') {
          console.warn('[Login] ‚ö†Ô∏è Popups may be blocked by browser');
          // Don't show error yet - let Firebase handle it and show better error
        } else {
          testPopup.close();
        }
      } catch (e) {
        // Popup check failed - continue anyway
        console.warn('[Login] Could not test popup availability');
      }

      // Store original button HTML at the start (before any modifications)
      if (!googleSignInBtn.dataset.originalText) {
        googleSignInBtn.dataset.originalText = googleSignInBtn.innerHTML;
      }
      const originalText = googleSignInBtn.dataset.originalText;

      try {
        
        // Show loading state
        googleSignInBtn.disabled = true;
        googleSignInBtn.innerHTML = '<span>' + (googleSignInBtn.dataset.loadingText || 'Signing in‚Ä¶') + '</span>';

        // Sign in with Google
        // Try popup first, but if it fails, we'll handle it gracefully
        console.log('[Login] üîµ Starting Google Sign-In (popup)...');
        const userCredential = await window.FirebaseAuth.signInWithGoogle(false); // false = use popup
        console.log('[Login] ‚úÖ Google popup completed, got user credential');
        
        // Get ID token and user email
        console.log('[Login] üîµ Getting ID token...');
        const idToken = await userCredential.user.getIdToken();
        const email = userCredential.user.email;
        
        console.log('[Login] ‚úÖ Google Sign-In successful, got Firebase token:', {
          hasToken: !!idToken,
          tokenLength: idToken ? idToken.length : 0,
          tokenPreview: idToken ? `${idToken.substring(0, 20)}...` : 'MISSING',
          email: email,
          userId: userCredential.user.uid
        });
        
        // Populate email field (for validation fallback, though it won't be needed)
        const emailInput = loginForm.querySelector('#email');
        if (emailInput && email) {
          emailInput.value = email;
        }
        
        // Populate password field with a dummy value to satisfy HTML5 validation
        // (backend will ignore it when firebase_token is present)
        const passwordInput = loginForm.querySelector('#password');
        if (passwordInput) {
          passwordInput.value = 'google-sign-in';
        }
        
        // Submit form to backend
        console.log('[Login] üîµ Calling handleLogin with token...');
        handleLogin(idToken);
      } catch (error) {
        // Reset button state first
        resetButtons();

        // Handle different error types
        if (error.code === 'auth/popup-closed-by-user') {
          // Popup closed - but user might have successfully authenticated
          // Firebase sometimes closes the popup automatically after successful auth
          console.log('[Login] Popup closed, checking if user is authenticated...');
          
          // Show loading state while checking
          googleSignInBtn.disabled = true;
          googleSignInBtn.innerHTML = '<span>Checking authentication...</span>';
          
          // Check multiple times with increasing delays (Firebase auth state can take time to update)
          let authDetected = false;
          const checkAuthState = async (attempt = 1, maxAttempts = 6) => {
            try {
              const currentUser = await window.FirebaseAuth.getCurrentUser();
              console.log(`[Login] Auth check attempt ${attempt}/${maxAttempts}:`, currentUser ? 'User found' : 'No user');
              
              if (currentUser) {
                authDetected = true;
                console.log('[Login] ‚úÖ User is authenticated, proceeding with login...');
                
                const idToken = await currentUser.getIdToken();
                const email = currentUser.email;
                
                // Populate form fields
                const emailInput = loginForm.querySelector('#email');
                if (emailInput && email) {
                  emailInput.value = email;
                }
                const passwordInput = loginForm.querySelector('#password');
                if (passwordInput) {
                  passwordInput.value = 'google-sign-in';
                }
                
                // Show loading state
                googleSignInBtn.disabled = true;
                googleSignInBtn.innerHTML = '<span>Signing in‚Ä¶</span>';
                
                // Submit to backend
                handleLogin(idToken);
                return true; // Auth detected
              }
              
              // If not found and more attempts left, wait and try again
              if (attempt < maxAttempts) {
                const delay = attempt * 300; // Increasing delay: 300ms, 600ms, 900ms, etc.
                await new Promise(resolve => setTimeout(resolve, delay));
                return await checkAuthState(attempt + 1, maxAttempts);
              }
              
              return false; // No auth detected after all attempts
            } catch (checkError) {
              console.error(`[Login] Error checking auth state (attempt ${attempt}):`, checkError);
              if (attempt < maxAttempts) {
                const delay = attempt * 300;
                await new Promise(resolve => setTimeout(resolve, delay));
                return await checkAuthState(attempt + 1, maxAttempts);
              }
              return false;
            }
          };
          
          // Also set up onAuthStateChanged listener as backup
          let listenerTriggered = false;
          const unsubscribe = window.FirebaseAuth.onAuthStateChanged(async (user) => {
            if (user && !listenerTriggered && !authDetected) {
              listenerTriggered = true;
              authDetected = true;
              unsubscribe();
              
              console.log('[Login] ‚úÖ User authenticated via onAuthStateChanged, proceeding...');
              
              const idToken = await user.getIdToken();
              const email = user.email;
              
              // Populate form fields
              const emailInput = loginForm.querySelector('#email');
              if (emailInput && email) {
                emailInput.value = email;
              }
              const passwordInput = loginForm.querySelector('#password');
              if (passwordInput) {
                passwordInput.value = 'google-sign-in';
              }
              
              // Show loading state
              googleSignInBtn.disabled = true;
              googleSignInBtn.innerHTML = '<span>Signing in‚Ä¶</span>';
              
              // Submit to backend
              handleLogin(idToken);
            }
          });
          
          // Start checking auth state
          const authFound = await checkAuthState();
          
          // Clean up listener if auth not found
          if (!authFound && !authDetected) {
            setTimeout(() => {
              if (!authDetected) {
                unsubscribe();
                resetButtons();
                console.log('[Login] No authentication detected after popup closure - user likely closed popup before completing sign-in');
              }
            }, 2000);
          }
        } else if (error.code === 'auth/popup-blocked') {
          // Popup was blocked by browser - try redirect flow
          console.error('[Login] Popup blocked by browser, attempting redirect flow');
          try {
            // Try redirect flow as fallback
            await window.FirebaseAuth.signInWithGoogle(true); // true = use redirect
            // If redirect succeeds, we'll be redirected away, so no need to show error
            console.log('[Login] Redirect flow initiated, user will be redirected');
            return; // Exit early, redirect will happen
          } catch (redirectError) {
            console.error('[Login] Redirect flow also failed:', redirectError);
            showError('Popup was blocked and redirect failed. Please allow popups for this site or check your browser settings. You can also try refreshing the page.');
          }
        } else if (error.code === 'auth/unauthorized-domain') {
          // Domain not authorized in Firebase
          console.error('[Login] Unauthorized domain error');
          showError('This domain is not authorized for Google Sign-In. Please contact support.');
        } else if (error.code === 'auth/network-request-failed') {
          // Network error
          console.error('[Login] Network error during Google Sign-In');
          showError('Network error. Please check your internet connection and try again.');
        } else {
          // Other errors - show error message
          const errorMessage = window.getFirebaseErrorMessage ? window.getFirebaseErrorMessage(error) : error.message || 'Google Sign-In failed. Please try again.';
          console.error('[Login] Unexpected Google Sign-In error:', errorMessage);
          showError(errorMessage);
        }
      }
    });
  }
});
</script>
