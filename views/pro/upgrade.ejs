<% const safeProfile = (typeof profile !== 'undefined' && profile) ? profile : {}; %>

<section class="pro-upgrade-hero">
  <div class="pro-upgrade-hero__content">
    <span class="pro-upgrade-hero__eyebrow">Premium Features</span>
    <h1 class="pro-upgrade-hero__title">Upgrade to ZipSite Pro</h1>
    <p class="pro-upgrade-hero__description">
      Unlock watermark-free PDFs, advanced analytics, and priority support for your professional portfolio.
    </p>
  </div>
</section>

<section class="pro-features">
  <div class="dash-panel">
    <header class="dash-panel__header">
      <h3>Pro Features</h3>
      <p>Everything you need for a professional modeling career</p>
    </header>
    <div class="dash-panel__body">
      <div class="pro-features__grid">
        <div class="pro-feature">
          <div class="pro-feature__icon">‚úì</div>
          <h4 class="pro-feature__title">Watermark-Free PDFs</h4>
          <p class="pro-feature__description">Generate professional comp cards without ZipSite branding for client submissions.</p>
        </div>
        <div class="pro-feature">
          <div class="pro-feature__icon">‚úì</div>
          <h4 class="pro-feature__title">Advanced Analytics</h4>
          <p class="pro-feature__description">Track portfolio views, PDF downloads, and engagement metrics to optimize your presence.</p>
        </div>
        <div class="pro-feature">
          <div class="pro-feature__icon">‚úì</div>
          <h4 class="pro-feature__title">Priority Support</h4>
          <p class="pro-feature__description">Get fast-tracked help from our editorial team for profile optimization and technical issues.</p>
        </div>
        <div class="pro-feature">
          <div class="pro-feature__icon">‚úì</div>
          <h4 class="pro-feature__title">Unlimited Updates</h4>
          <p class="pro-feature__description">Refresh your portfolio, bio, and imagery as often as you need without restrictions.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="pro-pricing">
  <div class="dash-panel">
    <header class="dash-panel__header">
      <h3>Pricing</h3>
      <p>Simple, transparent pricing for professionals</p>
    </header>
    <div class="dash-panel__body">
      <div class="pro-pricing__card">
        <div class="pro-pricing__amount">
          <span class="pro-pricing__currency">$</span>
          <span class="pro-pricing__price">9.99</span>
          <span class="pro-pricing__period">/month</span>
        </div>
        <p class="pro-pricing__note">Cancel anytime, no questions asked.</p>
      </div>
    </div>
  </div>
</section>

<% const hasActiveSubscription = subscription && (subscription.status === 'trialing' || subscription.status === 'active'); %>
<% const subscriptionStatus = subscription ? subscription.status : 'none'; %>

<section class="pro-payment">
  <div class="dash-panel">
    <header class="dash-panel__header">
      <h3><%= hasActiveSubscription ? 'Subscription Status' : 'Get Started' %></h3>
      <p><%= hasActiveSubscription ? 'Manage your Pro subscription' : 'Start your 14-day free trial today' %></p>
    </header>
    <div class="dash-panel__body">
      <% if (hasActiveSubscription) { %>
        <!-- Active Subscription / Trial Status -->
        <div class="pro-payment__status">
          <% if (isInTrial && trialDaysRemaining !== null) { %>
            <div class="pro-payment__status-item pro-payment__status-item--trial">
              <div class="pro-payment__status-icon">‚è±</div>
              <div class="pro-payment__status-content">
                <h4 class="pro-payment__status-title">Free Trial Active</h4>
                <p class="pro-payment__status-description">
                  Your 14-day free trial is active. <strong><%= trialDaysRemaining %> <%= trialDaysRemaining === 1 ? 'day' : 'days' %> remaining</strong>.
                </p>
                <p class="pro-payment__status-note">
                  After your trial ends, you'll be charged $9.99/month. Cancel anytime.
                </p>
              </div>
            </div>
          <% } else if (subscription.status === 'active') { %>
            <div class="pro-payment__status-item pro-payment__status-item--active">
              <div class="pro-payment__status-icon">‚úì</div>
              <div class="pro-payment__status-content">
                <h4 class="pro-payment__status-title">Pro Subscription Active</h4>
                <p class="pro-payment__status-description">
                  <% if (isCanceling) { %>
                    Your subscription will be canceled at the end of the current billing period.
                  <% } else { %>
                    Your subscription is active and you have access to all Pro features.
                  <% } %>
                </p>
                <% if (subscription.current_period_end) { %>
                  <% const periodEnd = new Date(subscription.current_period_end); %>
                  <p class="pro-payment__status-note">
                    Next billing date: <strong><%= periodEnd.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %></strong>
                  </p>
                <% } %>
              </div>
            </div>
          <% } %>

          <% if (subscription.status === 'past_due' || subscription.status === 'unpaid') { %>
            <div class="pro-payment__status-item pro-payment__status-item--warning">
              <div class="pro-payment__status-icon">‚ö†</div>
              <div class="pro-payment__status-content">
                <h4 class="pro-payment__status-title">Payment Required</h4>
                <p class="pro-payment__status-description">
                  There was an issue with your payment. Please update your payment method to continue your Pro subscription.
                </p>
              </div>
            </div>
          <% } %>

          <div class="form-actions" style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px;">
            <a href="/stripe/customer-portal" class="button button-primary" style="flex: 1; min-width: 200px; text-align: center;">
              Manage Billing
            </a>
            <a href="/dashboard/talent" class="button button-secondary" style="flex: 0 0 auto;">
              Return to Dashboard
            </a>
          </div>
        </div>
      <% } else { %>
        <!-- No Subscription - Start Trial -->
        <div class="pro-payment__start">
          <div class="pro-payment__trial-info">
            <div class="pro-payment__trial-badge">14-Day Free Trial</div>
            <p class="pro-payment__trial-description">
              Start your free trial today. No credit card required until the trial ends.
              After 14 days, you'll be charged $9.99/month. Cancel anytime, no questions asked.
            </p>
          </div>

          <div class="form-actions" style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px;">
            <button id="start-trial-btn" class="button button-primary button-block" style="flex: 1; min-width: 200px;">
              Start 14-Day Free Trial
            </button>
            <a href="/dashboard/talent" class="button button-secondary" style="flex: 0 0 auto;">
              Return to Dashboard
            </a>
          </div>

          <p class="pro-payment__security-note">
            üîí Secure checkout powered by Stripe. Your payment information is encrypted and secure.
          </p>
        </div>
      <% } %>
    </div>
  </div>
</section>

<script>
  // Initialize Stripe
  const stripePublishableKey = '<%= typeof stripePublishableKey !== "undefined" ? stripePublishableKey : "" %>';
  
  if (!stripePublishableKey) {
    console.error('[Pro Upgrade] Stripe publishable key not found');
  }

  // Handle Start Trial button click
  const startTrialBtn = document.getElementById('start-trial-btn');
  if (startTrialBtn) {
    startTrialBtn.addEventListener('click', async function() {
      // Disable button during processing
      startTrialBtn.disabled = true;
      startTrialBtn.textContent = 'Processing...';

      try {
        // Create checkout session
        const response = await fetch('/stripe/create-checkout-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to create checkout session');
        }

        // Redirect to Stripe Checkout
        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error('No checkout URL received');
        }
      } catch (error) {
        console.error('[Pro Upgrade] Error starting trial:', error);
        alert('There was an error starting your trial. Please try again or contact support.');
        
        // Re-enable button
        startTrialBtn.disabled = false;
        startTrialBtn.textContent = 'Start 14-Day Free Trial';
      }
    });
  }
</script>

<style>
  .pro-upgrade-hero {
    margin-bottom: 48px;
  }

  .pro-upgrade-hero__content {
    padding-top: 8px;
  }

  .pro-upgrade-hero__eyebrow {
    display: inline-block;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--accent-gold);
    margin-bottom: 12px;
  }

  .pro-upgrade-hero__title {
    font-family: 'Playfair Display', serif;
    font-size: 48px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 16px 0;
    line-height: 1.1;
    letter-spacing: -0.02em;
  }

  .pro-upgrade-hero__description {
    font-size: 16px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0;
    max-width: 600px;
  }

  .pro-features {
    margin-bottom: 40px;
  }

  .pro-features__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 24px;
  }

  .pro-feature {
    padding: 24px;
    background: var(--bg-surface-elevated);
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }

  .pro-feature__icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--accent-gold);
    color: #FFFFFF;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 16px;
  }

  .pro-feature__title {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 8px 0;
  }

  .pro-feature__description {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  .pro-pricing {
    margin-bottom: 40px;
  }

  .pro-pricing__card {
    text-align: center;
    padding: 32px;
  }

  .pro-pricing__amount {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 4px;
    margin-bottom: 16px;
  }

  .pro-pricing__currency {
    font-size: 24px;
    color: var(--text-secondary);
    font-weight: 500;
  }

  .pro-pricing__price {
    font-family: 'Playfair Display', serif;
    font-size: 64px;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1;
  }

  .pro-pricing__period {
    font-size: 18px;
    color: var(--text-secondary);
  }

  .pro-pricing__note {
    font-size: 14px;
    color: var(--text-tertiary);
    margin: 0;
  }

  .pro-payment {
    margin-bottom: 40px;
  }

  .pro-payment__notice {
    padding: 24px;
    background: var(--bg-surface-elevated);
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }

  .pro-payment__message {
    font-size: 15px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0 0 16px 0;
  }

  .pro-payment__message:last-child {
    margin-bottom: 0;
  }

  .pro-payment__message a {
    color: var(--accent-gold);
    text-decoration: none;
  }

  .pro-payment__message a:hover {
    text-decoration: underline;
  }

  .pro-payment__status {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .pro-payment__status-item {
    display: flex;
    gap: 16px;
    padding: 20px;
    background: var(--bg-surface-elevated);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    align-items: flex-start;
  }

  .pro-payment__status-item--trial {
    border-color: var(--accent-gold);
    background: rgba(201, 165, 90, 0.05);
  }

  .pro-payment__status-item--active {
    border-color: #10b981;
    background: rgba(16, 185, 129, 0.05);
  }

  .pro-payment__status-item--warning {
    border-color: #f59e0b;
    background: rgba(245, 158, 11, 0.05);
  }

  .pro-payment__status-icon {
    font-size: 24px;
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--bg-surface);
  }

  .pro-payment__status-item--trial .pro-payment__status-icon {
    background: var(--accent-gold);
    color: #FFFFFF;
  }

  .pro-payment__status-item--active .pro-payment__status-icon {
    background: #10b981;
    color: #FFFFFF;
  }

  .pro-payment__status-item--warning .pro-payment__status-icon {
    background: #f59e0b;
    color: #FFFFFF;
  }

  .pro-payment__status-content {
    flex: 1;
  }

  .pro-payment__status-title {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 8px 0;
  }

  .pro-payment__status-description {
    font-size: 15px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0 0 8px 0;
  }

  .pro-payment__status-note {
    font-size: 14px;
    color: var(--text-tertiary);
    margin: 0;
  }

  .pro-payment__start {
    text-align: center;
  }

  .pro-payment__trial-info {
    margin-bottom: 24px;
  }

  .pro-payment__trial-badge {
    display: inline-block;
    padding: 8px 16px;
    background: var(--accent-gold);
    color: #FFFFFF;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    border-radius: 6px;
    margin-bottom: 16px;
  }

  .pro-payment__trial-description {
    font-size: 15px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .pro-payment__security-note {
    font-size: 13px;
    color: var(--text-tertiary);
    margin: 16px 0 0 0;
    text-align: center;
  }

  #start-trial-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>

