<% 
  // This is a partial included in the main agency dashboard
  // Variables: profile, index, currentUser, appStatus, aiScore, aiTags
  const isClaimed = Boolean(profile.partner_agency_id);
  const isClaimedByMe = profile.partner_agency_id === currentUser.id;
  
  function normalizeImagePath(path) {
    if (!path) return '';
    if (path.startsWith('http://') || path.startsWith('https://')) return path;
    if (path.startsWith('/')) return path;
    return '/' + path;
  }
%>

<div class="agency-dashboard__card" 
     data-profile-id="<%= profile.id %>" 
     data-application-id="<%= profile.application_id || '' %>"
     data-status="<%= appStatus %>"
     draggable="true">
  
  <!-- Card Checkbox (for batch selection) -->
  <div class="agency-dashboard__card-checkbox">
    <input type="checkbox" class="agency-dashboard__select-checkbox" data-profile-id="<%= profile.id %>" id="card-select-<%= profile.id %>">
  </div>

  <!-- Card Image -->
  <div class="agency-dashboard__card-image">
    <% if (profile.hero_image_path || (profile.images && profile.images.length > 0)) { %>
      <img 
        src="<%= normalizeImagePath(profile.hero_image_path || profile.images[0].path) %>" 
        alt="<%= profile.first_name %> <%= profile.last_name %>"
        loading="lazy">
    <% } else { %>
      <div class="agency-dashboard__card-placeholder">
        <%= profile.first_name.charAt(0) %><%= profile.last_name.charAt(0) %>
      </div>
    <% } %>
    
    <!-- Badges Overlay -->
    <div class="agency-dashboard__card-badges">
      <% if (profile.is_pro) { %>
        <span class="agency-dashboard__badge agency-dashboard__badge--pro">STUDIO+</span>
      <% } %>
      <span class="agency-dashboard__badge agency-dashboard__badge--status agency-dashboard__badge--<%= appStatus %>">
        <%= appStatus.charAt(0).toUpperCase() + appStatus.slice(1) %>
      </span>
    </div>

    <!-- AI Match Score -->
    <div class="agency-dashboard__card-score">
      <div class="agency-dashboard__score-value"><%= aiScore %></div>
      <div class="agency-dashboard__score-label">Match</div>
    </div>
  </div>

  <!-- Card Content -->
  <div class="agency-dashboard__card-content">
    <div class="agency-dashboard__card-header">
      <h4 class="agency-dashboard__card-name">
        <%= profile.first_name %> <%= profile.last_name %>
      </h4>
      <div class="agency-dashboard__card-header-actions">
        <button class="agency-dashboard__card-notes-btn" data-application-id="<%= profile.application_id %>" data-profile-id="<%= profile.id %>" title="Notes & Tags">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </button>
        <button class="agency-dashboard__card-menu" data-profile-id="<%= profile.id %>" aria-label="More options">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="1"/>
            <circle cx="12" cy="5" r="1"/>
            <circle cx="12" cy="19" r="1"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="agency-dashboard__card-meta">
      <span class="agency-dashboard__card-location">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
          <circle cx="12" cy="10" r="3"/>
        </svg>
        <%= profile.city || 'Location TBD' %>
      </span>
      <span class="agency-dashboard__card-stats">
        <% if (profile.height_cm) { %><%= profile.height_cm %> cm<% } %>
        <% if (profile.measurements) { %> â€¢ <%= profile.measurements %><% } %>
      </span>
    </div>

    <!-- AI Tags -->
    <% if (aiTags.length > 0) { %>
      <div class="agency-dashboard__card-tags">
        <% aiTags.slice(0, 2).forEach(tag => { %>
          <span class="agency-dashboard__tag agency-dashboard__tag--<%= tag.color %>"><%= tag.label %></span>
        <% }); %>
      </div>
    <% } %>

    <!-- Custom Tags (from application_tags table) -->
    <% if (profile.application_tags && profile.application_tags.length > 0) { %>
      <div class="agency-dashboard__card-tags agency-dashboard__card-tags--custom">
        <% profile.application_tags.slice(0, 3).forEach(tag => { %>
          <span class="agency-dashboard__tag agency-dashboard__tag--custom" style="<%= tag.color ? 'background-color: ' + tag.color + '20; color: ' + tag.color + '; border-color: ' + tag.color + '40;' : '' %>">
            <%= tag.tag %>
          </span>
        <% }); %>
        <% if (profile.application_tags.length > 3) { %>
          <span class="agency-dashboard__tag agency-dashboard__tag--more">+<%= profile.application_tags.length - 3 %></span>
        <% } %>
      </div>
    <% } %>

    <!-- Notes Indicator -->
    <% if (profile.application_notes_count && profile.application_notes_count > 0) { %>
      <div class="agency-dashboard__card-notes-indicator" data-application-id="<%= profile.application_id %>">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <span><%= profile.application_notes_count %> note<%= profile.application_notes_count !== 1 ? 's' : '' %></span>
      </div>
    <% } %>

    <!-- Bio Preview -->
    <% if (profile.bio_curated) { %>
      <p class="agency-dashboard__card-bio">
        <%= profile.bio_curated.length > 100 ? profile.bio_curated.substring(0, 100) + '...' : profile.bio_curated %>
      </p>
    <% } %>

    <!-- Quick Actions -->
    <div class="agency-dashboard__card-actions">
      <button class="agency-dashboard__card-preview" data-profile-id="<%= profile.id %>" data-application-id="<%= profile.application_id %>">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        Preview
      </button>
      <div class="agency-dashboard__card-quick-actions">
        <% if (appStatus !== 'accepted' && profile.application_id) { %>
          <button 
            type="button" 
            class="agency-dashboard__quick-btn agency-dashboard__quick-btn--accept" 
            data-action="accept"
            data-application-id="<%= profile.application_id %>"
            title="Accept">
            Accept
          </button>
        <% } %>
        <% if (appStatus !== 'declined' && profile.application_id) { %>
          <button 
            type="button" 
            class="agency-dashboard__quick-btn agency-dashboard__quick-btn--decline" 
            data-action="decline"
            data-application-id="<%= profile.application_id %>"
            title="Decline">
            Decline
          </button>
        <% } %>
        <% if (appStatus !== 'archived' && profile.application_id) { %>
          <button 
            type="button" 
            class="agency-dashboard__quick-btn agency-dashboard__quick-btn--archive" 
            data-action="archive"
            data-application-id="<%= profile.application_id %>"
            title="Archive">
            Archive
          </button>
        <% } %>
      </div>
    </div>
  </div>
</div>

