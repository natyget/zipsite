<% const safeProfile=(typeof profile !=='undefined' && profile) ? profile : {}; const rawMedia=(typeof images
  !=='undefined' && images) ? images : []; const safeMedia=Array.isArray(rawMedia) ? rawMedia : []; const
  slug=safeProfile.slug || 'yourname' ; const effectiveShareUrl=(typeof shareUrl !=='undefined' ) ? shareUrl :
  `https://pholio.me/${slug}`; const safeCompleteness=(typeof completeness !=='undefined' ) ? completeness : {}; const
  editDefaults={ city: safeProfile.city || '' , height_cm: safeProfile.height_cm || '' , bio: safeProfile.bio_raw || '' }; const formValues=(typeof values !=='undefined' ) ?
  { ...editDefaults, ...values } : editDefaults; const _formErrors=(typeof formErrors !=='undefined' ) ? formErrors :
  {}; const valueFor=(key)=> formValues[key] || '';
  const fieldError = (key) => (_formErrors[key] && _formErrors[key].length) ? _formErrors[key][0] : null;
  const fieldHasError = (key) => Boolean(fieldError(key));

  // Helper function to normalize image paths
  function normalizeImagePath(imagePath) {
    if (!imagePath) return '';
    // Preserve external URLs
    if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
      return imagePath;
    }
    // Remove any ../ sequences and normalize
    let normalized = imagePath.replace(/\.\.\//g, '').replace(/\\/g, '/');
    // Ensure it starts with /
    if (!normalized.startsWith('/')) {
      normalized = '/' + normalized;
    }
    // If path contains /uploads/ but starts with /../, fix it
    if (normalized.includes('/uploads/')) {
      const uploadsIndex = normalized.indexOf('/uploads/');
      normalized = normalized.substring(uploadsIndex);
    }
    // If it doesn't start with /uploads/ and is a relative path, assume it's in uploads
    if (!normalized.startsWith('/uploads/') && !normalized.startsWith('http')) {
      // Extract filename if path contains one
      const parts = normalized.split('/');
      const filename = parts[parts.length - 1];
      if (filename && filename.includes('.')) {
        normalized = '/uploads/' + filename;
      }
    }
    return normalized;
  }

  // Get hero image
  const heroImage = safeProfile.hero_image_path || (safeMedia.length > 0 ? safeMedia[0].path : null);
  %>

  <!-- Hero Section with Talent Image -->
  <section class="dash-hero" id="overview" data-section="overview">
    <div class="dash-hero__image">
      <% if (heroImage) { %>
        <div class="dash-hero__image-placeholder">
          <div class="dash-hero__placeholder-shimmer"></div>
        </div>
        <img src="<%= normalizeImagePath(heroImage) %>"
          alt="<%= safeProfile.first_name %> <%= safeProfile.last_name %>"
          onload="this.classList.add('is-loaded')"
          onerror="this.classList.add('is-loaded')">
        <% } else { %>
          <div class="dash-hero__image-placeholder">
            Upload images to see your portfolio
          </div>
          <% } %>
    </div>

    <div class="dash-hero__copy">
      <div class="dash-hero__title-wrapper">
        <h1 class="dash-hero__title">
          <%= (safeProfile.first_name || 'Your' ) + ' ' + (safeProfile.last_name || 'Name' ) %>
        </h1>
        <% if (safeProfile.is_pro) { %>
          <span class="badge badge-pro">STUDIO+</span>
          <% } else { %>
            <span class="badge badge-free">Free</span>
            <% } %>
      </div>

      <p class="dash-hero__subtitle">
        <%= safeProfile.city || 'Add your primary city' %>
      </p>

      <div class="dash-hero__stats">
        <div class="dash-hero__stat">
          <span class="dash-hero__stat-label">Height</span>
          <span class="dash-hero__stat-value">
            <%= safeProfile.height_cm ? safeProfile.height_cm + ' cm' : '—' %>
          </span>
        </div>
        <div class="dash-hero__stat">
          <span class="dash-hero__stat-label">Measurements</span>
          <span class="dash-hero__stat-value">
            <%= (safeProfile.bust ? safeProfile.bust + '"' : '') + (safeProfile.waist ? '-' + safeProfile.waist + '"' : '') + (safeProfile.hips ? '-' + safeProfile.hips + '"' : '') || '—' %>
          </span>
        </div>
        <div class="dash-hero__stat">
          <span class="dash-hero__stat-label">Images</span>
          <span class="dash-hero__stat-value" id="hero-image-count">
            <%= safeMedia.length %>
          </span>
        </div>
        <% if (safeProfile.updated_at) { %>
          <div class="dash-hero__stat">
            <span class="dash-hero__stat-label">Last Updated</span>
            <span class="dash-hero__stat-value">
              <%= new Date(safeProfile.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
            </span>
          </div>
        <% } %>
        <% if (safeCompleteness && safeCompleteness.percentage !== undefined) { %>
          <div class="dash-hero__stat dash-hero__stat--completeness">
            <span class="dash-hero__stat-label">Profile</span>
            <span class="dash-hero__stat-value">
              <%= Math.round(safeCompleteness.percentage) %>%
            </span>
          </div>
        <% } %>
      </div>

      <div class="dash-hero__actions">
        <% if (typeof profile !== 'undefined' && profile && profile.id && safeProfile.slug) { %>
          <!-- Only show these buttons when profile exists -->
          <button type="button" class="button button-primary dash-hero__action" id="pdf-download-btn" data-slug="<%= slug %>" data-theme="<%= (typeof currentTheme !== 'undefined' ? currentTheme : safeProfile.pdf_theme) || 'classic-serif' %>" data-is-pro="<%= safeProfile.is_pro ? 'true' : 'false' %>">
            <span>Download Comp Card</span>
          </button>
          <% if (safeProfile.is_pro) { %>
            <a href="/dashboard/pdf-customizer" class="button button-secondary dash-hero__action">Customize PDF</a>
          <% } %>
          <a href="/portfolio/<%= slug %>" class="button button-secondary dash-hero__action" target="_blank" rel="noopener noreferrer">
            <span>View Portfolio</span>
          </a>
          <% if (!safeProfile.is_pro) { %>
            <a href="/pro/upgrade" class="button button-gold dash-hero__action dash-hero__action--upgrade">
              <span>Upgrade to Studio+</span>
            </a>
          <% } else { %>
            <!-- Discoverability Toggle (Studio+ only) -->
            <div class="dash-hero__discoverability" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
              <label class="discoverability-toggle" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                <input 
                  type="checkbox" 
                  id="discoverability-toggle" 
                  <%= safeProfile.is_discoverable ? 'checked' : '' %>
                  style="width: 20px; height: 20px; cursor: pointer;">
                <span style="color: #e2e8f0; font-size: 0.875rem;">
                  Make my profile discoverable to all partner agencies
                </span>
              </label>
              <p style="margin-top: 0.5rem; color: #94a3b8; font-size: 0.75rem;">
                When enabled, agencies can discover and invite you through Scout Talent
              </p>
            </div>
          <% } %>
        <% } else { %>
          <!-- Show message when no profile exists -->
          <p class="dash-hero__no-profile-message">Complete your profile below to unlock PDF downloads and portfolio features.</p>
        <% } %>
      </div>
    </div>
  </section>

  <!-- Main Dashboard Grid -->
  <div class="dash-grid">

    <!-- Left Column: Main Content -->
    <div class="dash-grid__column">

      <!-- Profile Details Form -->
      <section class="dash-panel" id="profile-details" data-section="profile-details">
        <header class="dash-panel__header">
          <h3>Profile Details</h3>
          <p>Your essential stats for agency rosters and comp cards</p>
        </header>
        <div class="dash-panel__body">
          <form method="post" action="/dashboard/talent" class="form-stacked">
            <div class="form-grid">
              <div class="form-field <%= fieldHasError('city') ? 'has-error' : '' %>">
                <label for="city">Primary City</label>
                <input id="city" name="city" type="text" autocomplete="address-level2" value="<%= valueFor('city') %>"
                  placeholder="Los Angeles, CA">
                <% if (fieldHasError('city')) { %>
                  <p class="form-field__error">
                    <%= fieldError('city') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('city_secondary') ? 'has-error' : '' %>">
                <label for="city_secondary">Secondary City <span class="form-label__optional">(optional)</span></label>
                <input id="city_secondary" name="city_secondary" type="text" autocomplete="address-level2" value="<%= valueFor('city_secondary') %>"
                  placeholder="New York, NY">
                <% if (fieldHasError('city_secondary')) { %>
                  <p class="form-field__error">
                    <%= fieldError('city_secondary') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('phone') ? 'has-error' : '' %>">
                <label for="phone">Phone</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" value="<%= valueFor('phone') %>"
                  placeholder="+1 (555) 123-4567">
                <% if (fieldHasError('phone')) { %>
                  <p class="form-field__error">
                    <%= fieldError('phone') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('height_cm') ? 'has-error' : '' %>">
                <label for="height_cm">Height (cm)</label>
                <input id="height_cm" name="height_cm" type="number" min="120" max="220"
                  value="<%= valueFor('height_cm') %>" placeholder="177">
                <% if (fieldHasError('height_cm')) { %>
                  <p class="form-field__error">
                    <%= fieldError('height_cm') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field <%= fieldHasError('bust') ? 'has-error' : '' %>">
                <label for="bust">Bust</label>
                <input id="bust" name="bust" type="number" min="20" max="60" step="0.5"
                  value="<%= valueFor('bust') %>" placeholder="32">
                <% if (fieldHasError('bust')) { %>
                  <p class="form-field__error">
                    <%= fieldError('bust') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('waist') ? 'has-error' : '' %>">
                <label for="waist">Waist</label>
                <input id="waist" name="waist" type="number" min="20" max="60" step="0.5"
                  value="<%= valueFor('waist') %>" placeholder="25">
                <% if (fieldHasError('waist')) { %>
                  <p class="form-field__error">
                    <%= fieldError('waist') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('hips') ? 'has-error' : '' %>">
                <label for="hips">Hips</label>
                <input id="hips" name="hips" type="number" min="20" max="60" step="0.5"
                  value="<%= valueFor('hips') %>" placeholder="35">
                <% if (fieldHasError('hips')) { %>
                  <p class="form-field__error">
                    <%= fieldError('hips') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field <%= fieldHasError('shoe_size') ? 'has-error' : '' %>">
                <label for="shoe_size">Shoe Size</label>
                <% 
                  const shoeSizeValue = valueFor('shoe_size');
                  const shoeSizeOptions = ['5 US', '5.5 US', '6 US', '6.5 US', '7 US', '7.5 US', '8 US', '8.5 US', '9 US', '9.5 US', '10 US', '10.5 US', '11 US', '11.5 US', '12 US', '13 US'];
                  const isShoeSizeOther = shoeSizeValue && !shoeSizeOptions.includes(shoeSizeValue);
                %>
                <select id="shoe_size" name="shoe_size">
                  <option value="">Select...</option>
                  <% shoeSizeOptions.forEach(opt => { %>
                    <option value="<%= opt %>" <%= shoeSizeValue === opt ? 'selected' : '' %>><%= opt %></option>
                  <% }); %>
                  <option value="Other" <%= isShoeSizeOther ? 'selected' : '' %>>Other</option>
                </select>
                <input type="text" id="shoe_size_other" name="shoe_size_other" value="<%= isShoeSizeOther ? shoeSizeValue : '' %>" placeholder="Enter shoe size" style="margin-top: 0.5rem; display: <%= isShoeSizeOther ? 'block' : 'none' %>;">
                <% if (fieldHasError('shoe_size')) { %>
                  <p class="form-field__error">
                    <%= fieldError('shoe_size') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('eye_color') ? 'has-error' : '' %>">
                <label for="eye_color">Eye Color</label>
                <% 
                  const eyeColorValue = valueFor('eye_color');
                  const eyeColorOptions = ['Brown', 'Blue', 'Green', 'Hazel', 'Gray', 'Amber', 'Other'];
                  const isEyeColorOther = eyeColorValue && !eyeColorOptions.includes(eyeColorValue);
                %>
                <select id="eye_color" name="eye_color">
                  <option value="">Select...</option>
                  <% eyeColorOptions.filter(opt => opt !== 'Other').forEach(opt => { %>
                    <option value="<%= opt %>" <%= eyeColorValue === opt ? 'selected' : '' %>><%= opt %></option>
                  <% }); %>
                  <option value="Other" <%= isEyeColorOther ? 'selected' : '' %>>Other</option>
                </select>
                <input type="text" id="eye_color_other" name="eye_color_other" value="<%= isEyeColorOther ? eyeColorValue : '' %>" placeholder="Enter eye color" style="margin-top: 0.5rem; display: <%= isEyeColorOther ? 'block' : 'none' %>;">
                <% if (fieldHasError('eye_color')) { %>
                  <p class="form-field__error">
                    <%= fieldError('eye_color') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field <%= fieldHasError('hair_color') ? 'has-error' : '' %>">
                <label for="hair_color">Hair Color</label>
                <% 
                  const hairColorValue = valueFor('hair_color');
                  const hairColorOptions = ['Black', 'Brown', 'Blonde', 'Red', 'Auburn', 'Gray', 'White', 'Other'];
                  const isHairColorOther = hairColorValue && !hairColorOptions.includes(hairColorValue);
                %>
                <select id="hair_color" name="hair_color">
                  <option value="">Select...</option>
                  <% hairColorOptions.filter(opt => opt !== 'Other').forEach(opt => { %>
                    <option value="<%= opt %>" <%= hairColorValue === opt ? 'selected' : '' %>><%= opt %></option>
                  <% }); %>
                  <option value="Other" <%= isHairColorOther ? 'selected' : '' %>>Other</option>
                </select>
                <input type="text" id="hair_color_other" name="hair_color_other" value="<%= isHairColorOther ? hairColorValue : '' %>" placeholder="Enter hair color" style="margin-top: 0.5rem; display: <%= isHairColorOther ? 'block' : 'none' %>;">
                <% if (fieldHasError('hair_color')) { %>
                  <p class="form-field__error">
                    <%= fieldError('hair_color') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('hair_length') ? 'has-error' : '' %>">
                <label for="hair_length">Hair Length</label>
                <select id="hair_length" name="hair_length">
                  <option value="">Select...</option>
                  <option value="Short" <%= valueFor('hair_length') === 'Short' ? 'selected' : '' %>>Short</option>
                  <option value="Medium" <%= valueFor('hair_length') === 'Medium' ? 'selected' : '' %>>Medium</option>
                  <option value="Long" <%= valueFor('hair_length') === 'Long' ? 'selected' : '' %>>Long</option>
                  <option value="Very Long" <%= valueFor('hair_length') === 'Very Long' ? 'selected' : '' %>>Very Long</option>
                </select>
                <% if (fieldHasError('hair_length')) { %>
                  <p class="form-field__error">
                    <%= fieldError('hair_length') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('skin_tone') ? 'has-error' : '' %>">
                <label for="skin_tone">Skin Tone</label>
                <% 
                  const skinToneValue = valueFor('skin_tone');
                  const skinToneOptions = ['Fair', 'Light', 'Medium', 'Olive', 'Tan', 'Brown', 'Dark', 'Other'];
                  const isSkinToneOther = skinToneValue && !skinToneOptions.includes(skinToneValue);
                %>
                <select id="skin_tone" name="skin_tone">
                  <option value="">Select...</option>
                  <% skinToneOptions.filter(opt => opt !== 'Other').forEach(opt => { %>
                    <option value="<%= opt %>" <%= skinToneValue === opt ? 'selected' : '' %>><%= opt %></option>
                  <% }); %>
                  <option value="Other" <%= isSkinToneOther ? 'selected' : '' %>>Other</option>
                </select>
                <input type="text" id="skin_tone_other" name="skin_tone_other" value="<%= isSkinToneOther ? skinToneValue : '' %>" placeholder="Enter skin tone" style="margin-top: 0.5rem; display: <%= isSkinToneOther ? 'block' : 'none' %>;">
                <% if (fieldHasError('skin_tone')) { %>
                  <p class="form-field__error">
                    <%= fieldError('skin_tone') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <!-- Personal Details Section -->
            <div class="form-section">
              <div class="form-section__header">
                <h4>Personal Details</h4>
                <p>Additional information about yourself</p>
              </div>
              
              <div class="form-grid">
                <div class="form-field <%= fieldHasError('gender') ? 'has-error' : '' %>">
                  <label for="gender">Gender</label>
                  <select id="gender" name="gender">
                    <option value="">Select...</option>
                    <option value="Male" <%= valueFor('gender') === 'Male' ? 'selected' : '' %>>Male</option>
                    <option value="Female" <%= valueFor('gender') === 'Female' ? 'selected' : '' %>>Female</option>
                    <option value="Non-binary" <%= valueFor('gender') === 'Non-binary' ? 'selected' : '' %>>Non-binary</option>
                    <option value="Other" <%= valueFor('gender') === 'Other' ? 'selected' : '' %>>Other</option>
                    <option value="Prefer not to say" <%= valueFor('gender') === 'Prefer not to say' ? 'selected' : '' %>>Prefer not to say</option>
                  </select>
                  <% if (fieldHasError('gender')) { %>
                    <p class="form-field__error">
                      <%= fieldError('gender') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('date_of_birth') ? 'has-error' : '' %>">
                  <label for="date_of_birth">Date of Birth</label>
                  <input id="date_of_birth" name="date_of_birth" type="date" value="<%= valueFor('date_of_birth') %>">
                  <% if (fieldHasError('date_of_birth')) { %>
                    <p class="form-field__error">
                      <%= fieldError('date_of_birth') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('age') ? 'has-error' : '' %>">
                  <label for="age">Age</label>
                  <input id="age" name="age" type="number" min="0" max="150" value="<%= valueFor('age') %>" readonly
                    style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="Auto-calculated">
                  <p class="form-field__help" style="font-size: 0.85rem; margin-top: 0.25rem;">
                    Automatically calculated from date of birth
                  </p>
                  <% if (fieldHasError('age')) { %>
                    <p class="form-field__error">
                      <%= fieldError('age') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldHasError('weight') || fieldHasError('weight_unit') ? 'has-error' : '' %>">
                  <label>Weight</label>
                  <div style="display: flex; gap: 0.5rem; align-items: stretch;">
                    <div style="flex: 1; display: flex; flex-direction: column;">
                      <input id="weight" name="weight" type="number" step="0.1" min="30" max="440"
                        value="<%= valueFor('weight') || (valueFor('weight_kg') ? valueFor('weight_kg') : valueFor('weight_lbs')) %>" placeholder="143">
                    </div>
                    <div style="width: auto; min-width: 90px; display: flex; flex-direction: column;">
                      <select id="weight_unit" name="weight_unit" style="height: 100%;">
                        <option value="lbs" <%= (!valueFor('weight_unit') && valueFor('weight_kg')) ? '' : (valueFor('weight_unit') === 'lbs' ? 'selected' : (!valueFor('weight_lbs') ? 'selected' : '')) %>>lbs</option>
                        <option value="kg" <%= valueFor('weight_unit') === 'kg' ? 'selected' : '' %>>kg</option>
                      </select>
                    </div>
                  </div>
                  <input type="hidden" id="weight_kg" name="weight_kg" value="<%= valueFor('weight_kg') %>">
                  <input type="hidden" id="weight_lbs" name="weight_lbs" value="<%= valueFor('weight_lbs') %>">
                  <% if (fieldHasError('weight') || fieldHasError('weight_unit')) { %>
                    <p class="form-field__error">
                      <%= fieldError('weight') || fieldError('weight_unit') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('dress_size') ? 'has-error' : '' %>" id="dress-size-field">
                  <label for="dress_size">Dress Size <span class="form-label__optional">(optional)</span></label>
                  <input id="dress_size" name="dress_size" type="text" value="<%= valueFor('dress_size') %>"
                    placeholder="6 US">
                  <% if (fieldHasError('dress_size')) { %>
                    <p class="form-field__error">
                      <%= fieldError('dress_size') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <!-- Legal & Background Section -->
              <div class="form-section" style="margin-top: 40px;">
                <div class="form-section__header">
                  <h4>Legal & Background</h4>
                  <p>Work eligibility and legal status</p>
                </div>
                
                <div class="form-grid">
                  <div class="form-field <%= fieldHasError('work_eligibility') ? 'has-error' : '' %>">
                    <label for="work_eligibility">Work Eligibility</label>
                    <select id="work_eligibility" name="work_eligibility">
                      <option value="">Select...</option>
                      <option value="Yes" <%= valueFor('work_eligibility') === 'Yes' ? 'selected' : '' %>>Yes</option>
                      <option value="No" <%= valueFor('work_eligibility') === 'No' ? 'selected' : '' %>>No</option>
                    </select>
                    <% if (fieldHasError('work_eligibility')) { %>
                      <p class="form-field__error">
                        <%= fieldError('work_eligibility') %>
                      </p>
                      <% } %>
                  </div>

                  <div class="form-field <%= fieldHasError('work_status') ? 'has-error' : '' %>">
                    <label for="work_status">Work Status</label>
                    <% 
                      const workStatusValue = valueFor('work_status', '');
                      const workStatusOptions = ['Citizen', 'PR', 'Visa', 'Other'];
                      const isWorkStatusOther = workStatusValue && !workStatusOptions.includes(workStatusValue);
                    %>
                    <select id="work_status" name="work_status">
                      <option value="">Select...</option>
                      <% workStatusOptions.filter(opt => opt !== 'Other').forEach(opt => { %>
                        <option value="<%= opt %>" <%= workStatusValue === opt ? 'selected' : '' %>><%= opt %></option>
                      <% }); %>
                      <option value="Other" <%= isWorkStatusOther ? 'selected' : '' %>>Other</option>
                    </select>
                    <input type="text" id="work_status_other" name="work_status_other" value="<%= isWorkStatusOther ? workStatusValue : '' %>" placeholder="Enter work status" style="margin-top: 0.5rem; display: <%= isWorkStatusOther ? 'block' : 'none' %>;">
                    <% if (fieldHasError('work_status')) { %>
                      <p class="form-field__error">
                        <%= fieldError('work_status') %>
                      </p>
                      <% } %>
                  </div>
                </div>

                <div class="form-grid">
                  <div class="form-field <%= fieldHasError('ethnicity') ? 'has-error' : '' %>">
                    <label for="ethnicity">Ethnicity <span class="form-label__optional">(optional)</span></label>
                    <input id="ethnicity" name="ethnicity" type="text" value="<%= valueFor('ethnicity') %>"
                      placeholder="Optional">
                    <% if (fieldHasError('ethnicity')) { %>
                      <p class="form-field__error">
                        <%= fieldError('ethnicity') %>
                      </p>
                      <% } %>
                  </div>

                  <div class="form-field <%= fieldHasError('union_membership') ? 'has-error' : '' %>">
                    <label for="union_membership">Union Membership <span class="form-label__optional">(optional)</span></label>
                    <input id="union_membership" name="union_membership" type="text" value="<%= valueFor('union_membership') %>"
                      placeholder="SAG-AFTRA, AEA, etc.">
                    <% if (fieldHasError('union_membership')) { %>
                      <p class="form-field__error">
                        <%= fieldError('union_membership') %>
                      </p>
                      <% } %>
                  </div>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldHasError('tattoos') ? 'has-error' : '' %>">
                  <label>
                    <input type="checkbox" name="tattoos" value="true" <%= valueFor('tattoos') === 'true' || valueFor('tattoos') === true ? 'checked' : '' %>>
                    <span>Has Tattoos</span>
                  </label>
                  <% if (fieldHasError('tattoos')) { %>
                    <p class="form-field__error">
                      <%= fieldError('tattoos') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('piercings') ? 'has-error' : '' %>">
                  <label>
                    <input type="checkbox" name="piercings" value="true" <%= valueFor('piercings') === 'true' || valueFor('piercings') === true ? 'checked' : '' %>>
                    <span>Has Piercings</span>
                  </label>
                  <% if (fieldHasError('piercings')) { %>
                    <p class="form-field__error">
                      <%= fieldError('piercings') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-field">
                <label>Comfort Level</label>
                <p class="form-field__help">Select all that apply</p>
                <% 
                  const comfortLevelsValue = valueFor('comfort_levels', '');
                  let comfortLevelsArray = [];
                  if (Array.isArray(comfortLevelsValue)) {
                    comfortLevelsArray = comfortLevelsValue;
                  } else if (typeof comfortLevelsValue === 'string') {
                    try {
                      comfortLevelsArray = JSON.parse(comfortLevelsValue);
                    } catch {
                      comfortLevelsArray = comfortLevelsValue ? comfortLevelsValue.split(',').map(c => c.trim()).filter(c => c) : [];
                    }
                  }
                  const hasComfortLevel = (val) => comfortLevelsArray.includes(val);
                  const comfortOptions = ['Swimwear', 'Lingerie', 'Implied Nudity', 'Not Comfortable'];
                %>
                <div class="checkbox-group">
                  <% comfortOptions.forEach(option => { %>
                    <label class="checkbox-label">
                      <input type="checkbox" name="comfort_levels" value="<%= option %>" <%= hasComfortLevel(option) ? 'checked' : '' %>>
                      <span><%= option %></span>
                    </label>
                  <% }); %>
                </div>
              </div>
            </div>

            <div class="form-field <%= fieldHasError('bio') ? 'has-error' : '' %>">
              <label for="bio">Editorial Bio</label>
              <textarea id="bio" name="bio" rows="5"
                placeholder="Experienced in runway, editorial, commercial, and beauty campaigns..."><%= valueFor('bio') %></textarea>
              <p class="form-field__help">
                Write naturally. Our AI will refine this into a polished editorial bio.
              </p>
              <% if (fieldHasError('bio')) { %>
                <p class="form-field__error">
                  <%= fieldError('bio') %>
                </p>
                <% } %>
            </div>

            <% if (safeProfile && safeProfile.bio_curated) { %>
              <div class="form-field--readonly">
                <label>AI-Refined Bio (Live on Portfolio)</label>
                <p class="form-field__static-text">
                  <%= safeProfile.bio_curated %>
                </p>
              </div>
              <% } %>

            <!-- Experience Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
              <div class="form-field">
                <label>Experience</label>
                <p class="form-field__help">Select all that apply</p>
                <div class="checkbox-group" id="experience-checkboxes">
                  <% 
                    const specialtiesValue = valueFor('specialties', '');
                    const experienceDetailsValue = valueFor('experience_details', '');
                    let experienceDetailsObj = {};
                    if (experienceDetailsValue) {
                      try {
                        experienceDetailsObj = typeof experienceDetailsValue === 'string' ? JSON.parse(experienceDetailsValue) : experienceDetailsValue;
                      } catch (e) {
                        experienceDetailsObj = {};
                      }
                    }
                    let specialtiesArray = [];
                    if (Array.isArray(specialtiesValue)) {
                      specialtiesArray = specialtiesValue;
                    } else if (typeof specialtiesValue === 'string') {
                      try {
                        specialtiesArray = JSON.parse(specialtiesValue);
                      } catch {
                        specialtiesArray = specialtiesValue ? specialtiesValue.split(',').map(s => s.trim()).filter(s => s) : [];
                      }
                    }
                    const hasSpecialty = (val) => specialtiesArray.includes(val);
                    const experienceOptions = ['Runway', 'Acting', 'Dancing', 'Music', 'Art', 'Content Creation'];
                  %>
                  <% experienceOptions.forEach(option => { %>
                    <label class="checkbox-label">
                      <input type="checkbox" name="specialties" value="<%= option %>" <%= hasSpecialty(option) ? 'checked' : '' %> data-experience="<%= option.toLowerCase().replace(/\s+/g, '-') %>">
                      <span><%= option %></span>
                    </label>
                  <% }); %>
                  <label class="checkbox-label">
                    <input type="checkbox" name="specialties" value="Other" <%= hasSpecialty('Other') ? 'checked' : '' %> data-experience="other">
                    <span>Other</span>
                  </label>
                </div>
                <div id="experience-details-container" style="margin-top: 1rem;"></div>
                <input type="hidden" id="experience_details" name="experience_details" value='<%= typeof experienceDetailsValue === "string" ? experienceDetailsValue : JSON.stringify(experienceDetailsObj) %>'>
              </div>
            </div>

            <!-- Experience & Availability Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
              <h4 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">Experience & Availability</h4>
              
              <div class="form-field">
                <label>Languages</label>
                <p class="form-field__help">Add languages you speak</p>
                <% 
                  const languagesValue = valueFor('languages', '');
                  let languagesArray = [];
                  if (Array.isArray(languagesValue)) {
                    languagesArray = languagesValue;
                  } else if (typeof languagesValue === 'string') {
                    try {
                      languagesArray = JSON.parse(languagesValue);
                    } catch {
                      languagesArray = languagesValue ? languagesValue.split(',').map(l => l.trim()).filter(l => l) : [];
                    }
                  }
                  const languageOptions = ['English', 'Spanish', 'French', 'Italian', 'German', 'Portuguese', 'Mandarin', 'Japanese', 'Korean'];
                  const selectedLanguages = languagesArray.filter(l => languageOptions.includes(l));
                  const otherLanguages = languagesArray.filter(l => !languageOptions.includes(l));
                %>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <select id="add-language-select" style="flex: 1;">
                    <option value="">Select a language...</option>
                    <% languageOptions.forEach(lang => { %>
                      <option value="<%= lang %>" <%= selectedLanguages.includes(lang) ? 'disabled' : '' %>><%= lang %></option>
                    <% }); %>
                    <option value="Other">Other</option>
                  </select>
                  <button type="button" id="add-language-btn" class="button button-secondary" style="width: auto; padding: 0.5rem 1rem;">Add</button>
                </div>
                <input type="text" id="language-other-input" name="language_other_input" placeholder="Enter custom language" style="margin-bottom: 0.5rem; display: none; width: 100%; padding: 0.5rem;">
                <div id="selected-languages-container" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                  <% selectedLanguages.forEach(lang => { %>
                    <span class="language-tag" data-language="<%= lang %>" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: #f0f0f0; border-radius: 4px; font-size: 0.9rem;">
                      <%= lang %>
                      <button type="button" class="remove-language" data-language="<%= lang %>" style="background: none; border: none; cursor: pointer; font-size: 1.2rem; line-height: 1; color: #666;">&times;</button>
                    </span>
                  <% }); %>
                  <% otherLanguages.forEach(lang => { %>
                    <span class="language-tag" data-language="<%= lang %>" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: #f0f0f0; border-radius: 4px; font-size: 0.9rem;">
                      <%= lang %>
                      <button type="button" class="remove-language" data-language="<%= lang %>" style="background: none; border: none; cursor: pointer; font-size: 1.2rem; line-height: 1; color: #666;">&times;</button>
                    </span>
                  <% }); %>
                </div>
                <input type="hidden" id="languages" name="languages" value='<%= JSON.stringify(languagesArray) %>'>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldHasError('availability_travel') ? 'has-error' : '' %>">
                  <label>
                    <input type="checkbox" name="availability_travel" value="true" <%= valueFor('availability_travel') === 'true' || valueFor('availability_travel') === true ? 'checked' : '' %>>
                    <span>Available for Travel</span>
                  </label>
                  <% if (fieldHasError('availability_travel')) { %>
                    <p class="form-field__error">
                      <%= fieldError('availability_travel') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('availability_schedule') ? 'has-error' : '' %>">
                  <label for="availability_schedule">Availability Schedule</label>
                  <select id="availability_schedule" name="availability_schedule">
                    <option value="">Select...</option>
                    <option value="Full-time" <%= valueFor('availability_schedule') === 'Full-time' ? 'selected' : '' %>>Full-time</option>
                    <option value="Part-time" <%= valueFor('availability_schedule') === 'Part-time' ? 'selected' : '' %>>Part-time</option>
                    <option value="Flexible" <%= valueFor('availability_schedule') === 'Flexible' ? 'selected' : '' %>>Flexible</option>
                    <option value="Weekends only" <%= valueFor('availability_schedule') === 'Weekends only' ? 'selected' : '' %>>Weekends only</option>
                  </select>
                  <% if (fieldHasError('availability_schedule')) { %>
                    <p class="form-field__error">
                      <%= fieldError('availability_schedule') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldHasError('experience_level') ? 'has-error' : '' %>">
                  <label for="experience_level">Experience Level</label>
                  <select id="experience_level" name="experience_level">
                    <option value="">Select...</option>
                    <option value="Beginner" <%= valueFor('experience_level') === 'Beginner' ? 'selected' : '' %>>Beginner</option>
                    <option value="Intermediate" <%= valueFor('experience_level') === 'Intermediate' ? 'selected' : '' %>>Intermediate</option>
                    <option value="Experienced" <%= valueFor('experience_level') === 'Experienced' ? 'selected' : '' %>>Experienced</option>
                    <option value="Professional" <%= valueFor('experience_level') === 'Professional' ? 'selected' : '' %>>Professional</option>
                  </select>
                  <% if (fieldHasError('experience_level')) { %>
                    <p class="form-field__error">
                      <%= fieldError('experience_level') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('training') ? 'has-error' : '' %>">
                  <label for="training">Training</label>
                  <textarea id="training" name="training" rows="3" value="<%= valueFor('training') %>"
                    placeholder="Formal training in editorial modeling and commercial acting."><%= valueFor('training') %></textarea>
                  <% if (fieldHasError('training')) { %>
                    <p class="form-field__error">
                      <%= fieldError('training') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-field <%= fieldHasError('portfolio_url') ? 'has-error' : '' %>">
                <label for="portfolio_url">Portfolio URL</label>
                <input id="portfolio_url" name="portfolio_url" type="url" value="<%= valueFor('portfolio_url') %>"
                  placeholder="https://yourportfolio.com">
                <% if (fieldHasError('portfolio_url')) { %>
                  <p class="form-field__error">
                    <%= fieldError('portfolio_url') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <!-- Social Media Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
              <h4 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">Social Media</h4>
              <p class="form-field__help" style="margin-bottom: 1rem; font-size: 0.9rem;">
                Free users: Handles display as text only. Studio+ users: Handles are clickable links.
              </p>
              
              <div class="form-grid">
                <div class="form-field <%= fieldHasError('instagram_handle') ? 'has-error' : '' %>">
                  <label for="instagram_handle">Instagram Handle</label>
                  <input id="instagram_handle" name="instagram_handle" type="text" value="<%= valueFor('instagram_handle') %>"
                    placeholder="@username or username">
                  <% if (fieldHasError('instagram_handle')) { %>
                    <p class="form-field__error">
                      <%= fieldError('instagram_handle') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('twitter_handle') ? 'has-error' : '' %>">
                  <label for="twitter_handle">Twitter/X Handle</label>
                  <input id="twitter_handle" name="twitter_handle" type="text" value="<%= valueFor('twitter_handle') %>"
                    placeholder="@username or username">
                  <% if (fieldHasError('twitter_handle')) { %>
                    <p class="form-field__error">
                      <%= fieldError('twitter_handle') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('tiktok_handle') ? 'has-error' : '' %>">
                  <label for="tiktok_handle">TikTok Handle</label>
                  <input id="tiktok_handle" name="tiktok_handle" type="text" value="<%= valueFor('tiktok_handle') %>"
                    placeholder="@username or username">
                  <% if (fieldHasError('tiktok_handle')) { %>
                    <p class="form-field__error">
                      <%= fieldError('tiktok_handle') %>
                    </p>
                    <% } %>
                </div>
              </div>
            </div>

            <!-- References & Emergency Contact Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
              <h4 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">References & Emergency Contact</h4>
              
              <div class="form-grid">
                <div class="form-field <%= fieldHasError('reference_name') ? 'has-error' : '' %>">
                  <label for="reference_name">Reference Name</label>
                  <input id="reference_name" name="reference_name" type="text" value="<%= valueFor('reference_name') %>"
                    placeholder="John Doe">
                  <% if (fieldHasError('reference_name')) { %>
                    <p class="form-field__error">
                      <%= fieldError('reference_name') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('reference_email') ? 'has-error' : '' %>">
                  <label for="reference_email">Reference Email</label>
                  <input id="reference_email" name="reference_email" type="email" value="<%= valueFor('reference_email') %>"
                    placeholder="john@example.com">
                  <% if (fieldHasError('reference_email')) { %>
                    <p class="form-field__error">
                      <%= fieldError('reference_email') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('reference_phone') ? 'has-error' : '' %>">
                  <label for="reference_phone">Reference Phone</label>
                  <input id="reference_phone" name="reference_phone" type="tel" value="<%= valueFor('reference_phone') %>"
                    placeholder="+1 (555) 123-4567">
                  <% if (fieldHasError('reference_phone')) { %>
                    <p class="form-field__error">
                      <%= fieldError('reference_phone') %>
                    </p>
                    <% } %>
                </div>
              </div>


              <div class="form-grid" style="margin-top: 1.5rem;">
                <div class="form-field <%= fieldHasError('emergency_contact_name') ? 'has-error' : '' %>">
                  <label for="emergency_contact_name">Emergency Contact Name</label>
                  <input id="emergency_contact_name" name="emergency_contact_name" type="text" value="<%= valueFor('emergency_contact_name') %>"
                    placeholder="Jane Doe">
                  <% if (fieldHasError('emergency_contact_name')) { %>
                    <p class="form-field__error">
                      <%= fieldError('emergency_contact_name') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('emergency_contact_phone') ? 'has-error' : '' %>">
                  <label for="emergency_contact_phone">Emergency Contact Phone</label>
                  <input id="emergency_contact_phone" name="emergency_contact_phone" type="tel" value="<%= valueFor('emergency_contact_phone') %>"
                    placeholder="+1 (555) 123-4567">
                  <% if (fieldHasError('emergency_contact_phone')) { %>
                    <p class="form-field__error">
                      <%= fieldError('emergency_contact_phone') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('emergency_contact_relationship') ? 'has-error' : '' %>">
                  <label for="emergency_contact_relationship">Emergency Contact Relationship</label>
                  <input id="emergency_contact_relationship" name="emergency_contact_relationship" type="text" value="<%= valueFor('emergency_contact_relationship') %>"
                    placeholder="Parent, Spouse, etc.">
                  <% if (fieldHasError('emergency_contact_relationship')) { %>
                    <p class="form-field__error">
                      <%= fieldError('emergency_contact_relationship') %>
                    </p>
                    <% } %>
                </div>
              </div>
            </div>

                <div class="form-actions">
                  <button class="button-primary" type="submit">Save Changes</button>
                </div>
          </form>
        </div>
      </section>

      <!-- My Applications Section -->
      <section class="dash-panel" id="my-applications" data-section="my-applications">
        <header class="dash-panel__header">
          <h2 class="dash-panel__title">My Applications</h2>
          <p class="dash-panel__subtitle">Track the status of your agency applications</p>
        </header>
        <div class="dash-panel__content">
          <div id="applications-container" class="applications-container">
            <div class="applications-loading" style="text-align: center; padding: 2rem;">
              <p>Loading applications...</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Portfolio Imagery -->
      <section class="dash-panel" id="portfolio-imagery" data-section="portfolio-imagery">
        <header class="dash-panel__header">
          <h3>Portfolio Imagery</h3>
          <p>Upload 6-12 high-quality images. The first image becomes your hero shot.</p>
        </header>
        <div class="dash-panel__body">
          <form action="/dashboard/talent/media" method="post" enctype="multipart/form-data" class="form-stacked"
            style="margin-bottom: 32px;" id="media-upload-form">
            <div class="form-field">
              <label for="media">Select Images</label>
              <div class="file-upload-wrapper">
                <input id="media" name="media" type="file" accept="image/jpeg,image/png,image/webp" multiple
                  class="file-upload-input">
                <label for="media" class="file-upload-label">
                  <span class="file-upload-icon">📷</span>
                  <span class="file-upload-text">
                    <span class="file-upload-text-primary">Choose images to upload</span>
                    <span class="file-upload-text-secondary">or drag and drop</span>
                  </span>
                </label>
                <div class="file-upload-preview" id="file-preview"></div>
              </div>
              <p class="form-field__help">
                JPEG, PNG, or WebP. Maximum 10MB per image. Up to 12 images.
              </p>
            </div>
            <div class="form-actions">
              <button class="button-primary" type="submit" id="upload-button">Upload Images</button>
            </div>
          </form>

          <% if (safeMedia.length) { %>
            <div class="media-grid" data-media-grid id="media-grid">
              <% safeMedia.forEach((image, index)=> { %>
                <% 
                  // Check if this is the hero image
                  const isHeroImage = heroImage && (normalizeImagePath(image.path) === normalizeImagePath(heroImage) || image.path === heroImage || image.path === safeProfile.hero_image_path);
                %>
                <article class="media-card" 
                         data-media-id="<%= image.id %>" 
                         data-sort="<%= image.sort || index + 1 %>"
                         draggable="true"
                         role="button"
                         tabindex="0"
                         aria-label="Drag to reorder image">
                  <div class="media-card__drag-handle" title="Drag to reorder">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="7" cy="5" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="13" cy="5" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="7" cy="10" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="13" cy="10" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="7" cy="15" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="13" cy="15" r="1.5" fill="currentColor" opacity="0.4"/>
                    </svg>
                  </div>
                  <div class="media-card__image-placeholder">
                    <div class="media-card__placeholder-shimmer"></div>
                  </div>
                  <img src="<%= normalizeImagePath(image.path) %>"
                    alt="<%= image.label || 'Portfolio image' %>" 
                    loading="lazy"
                    onload="this.classList.add('is-loaded')"
                    onerror="this.classList.add('is-loaded')">
                  <div class="media-card__controls">
                    <% if (isHeroImage) { %>
                      <span class="media-card__hero-badge" title="Hero Image">★</span>
                    <% } else { %>
                      <button class="media-card__set-hero" type="button" title="Set as Hero Image" data-image-id="<%= image.id %>" data-image-path="<%= normalizeImagePath(image.path) %>">Set Hero</button>
                    <% } %>
                    <button class="media-card__delete" type="button" title="Delete image" data-image-id="<%= image.id %>">&times;</button>
                  </div>
                </article>
                <% }); %>
            </div>
            <% } else { %>
              <div class="empty-state">
                <p>No images yet. Upload your first portfolio images to get started.</p>
              </div>
              <% } %>
        </div>
      </section>

      <!-- Analytics Section (Main Content) -->
      <section class="dash-panel" id="analytics" data-section="analytics">
          <header class="dash-panel__header">
            <h3>Portfolio Analytics</h3>
            <p>Track your portfolio views and PDF downloads</p>
          </header>
          <div class="dash-panel__body">
            <div class="analytics-loading" style="padding: 40px; text-align: center; color: var(--text-secondary);">
              <div style="margin-bottom: 16px;">Loading analytics...</div>
              <div style="font-size: 13px; color: var(--text-tertiary);">This may take a moment</div>
            </div>
            <div class="analytics-content" style="display: none;">
              <div class="analytics-grid">
                <div class="analytics-card">
                  <div class="analytics-card__header">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 12px;">
                      <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <h4 class="analytics-card__title">Total Views</h4>
                  </div>
                  <div class="analytics-card__value" id="analytics-views-total">—</div>
                  <div class="analytics-card__subtext" id="analytics-views-week">This week: —</div>
                </div>
                <div class="analytics-card">
                  <div class="analytics-card__header">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 12px;">
                      <path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M10 9H9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h4 class="analytics-card__title">Total Downloads</h4>
                  </div>
                  <div class="analytics-card__value" id="analytics-downloads-total">—</div>
                  <div class="analytics-card__subtext" id="analytics-downloads-week">This week: —</div>
                </div>
                <div class="analytics-card">
                  <div class="analytics-card__header">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 12px;">
                      <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h4 class="analytics-card__title">This Month</h4>
                  </div>
                  <div class="analytics-card__value" id="analytics-monthly-total">—</div>
                  <div class="analytics-card__subtext" id="analytics-monthly-breakdown">Views & Downloads</div>
                </div>
              </div>
              <div class="analytics-themes" style="margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--border-color);">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-secondary);">Downloads by Theme</h4>
                <div class="analytics-themes-list" id="analytics-themes-list">
                  <!-- Theme breakdown will be populated by JavaScript -->
                </div>
              </div>
            </div>
            <div class="analytics-error" style="display: none; padding: 40px; text-align: center; color: var(--text-tertiary);">
              <div style="margin-bottom: 8px; font-size: 14px;">Analytics unavailable</div>
              <div style="font-size: 13px; color: var(--text-tertiary);">Unable to load analytics data at this time</div>
            </div>
          </div>
        </section>
    </div>

    <!-- Right Column: Sidebar -->
    <div class="dash-grid__column dash-sidebar">
      <!-- Profile Status & Stats (Consolidated) -->
      <div class="dash-panel dash-panel--compact dash-sidebar__status">
        <header class="dash-panel__header">
          <h3>Profile Status</h3>
        </header>
        <div class="dash-panel__body">
          <!-- Progress Bar -->
          <% if (safeCompleteness && safeCompleteness.percentage !== undefined) { %>
            <div class="profile-progress">
              <div class="profile-progress__header">
                <span class="profile-progress__label">Profile Complete</span>
                <span class="profile-progress__percentage"><%= Math.round(safeCompleteness.percentage) %>%</span>
              </div>
              <div class="profile-progress__bar">
                <div class="profile-progress__fill" style="width: <%= safeCompleteness.percentage %>%"></div>
              </div>
            </div>
          <% } %>

          <!-- Quick Stats -->
          <div class="profile-quick-stats">
            <div class="profile-quick-stat">
              <span class="profile-quick-stat__value" id="sidebar-image-count"><%= safeMedia.length %></span>
              <span class="profile-quick-stat__label">Images</span>
            </div>
            <% if (safeProfile.updated_at) { %>
              <div class="profile-quick-stat">
                <span class="profile-quick-stat__value" style="font-size: 13px;">
                  <%= new Date(safeProfile.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
                </span>
                <span class="profile-quick-stat__label">Updated</span>
              </div>
            <% } %>
          </div>

          <!-- Completion Checklist -->
          <div class="completion-checklist">
            <div class="completion-item <%= safeCompleteness.basics ? 'is-complete' : '' %>">
              <span class="completion-item__icon"><%= safeCompleteness.basics ? '✓' : '○' %></span>
              <span class="completion-item__label">Profile Details</span>
            </div>
            <div class="completion-item <%= safeCompleteness.imagery ? 'is-complete' : '' %>">
              <span class="completion-item__icon"><%= safeCompleteness.imagery ? '✓' : '○' %></span>
              <span class="completion-item__label">2+ Images</span>
            </div>
            <div class="completion-item <%= safeCompleteness.hero ? 'is-complete' : '' %>">
              <span class="completion-item__icon"><%= safeCompleteness.hero ? '✓' : '○' %></span>
              <span class="completion-item__label">Hero Image</span>
            </div>
          </div>

          <!-- Share Portfolio (if profile exists) -->
          <% if (typeof profile !== 'undefined' && profile && profile.id && safeProfile.slug) { %>
            <div class="share-section">
              <label class="share-section__label">Share Portfolio</label>
              <div class="share-url-wrapper">
                <input type="text" class="share-url-input" value="<%= effectiveShareUrl %>" readonly data-share-url>
                <button type="button" class="share-copy-btn" data-copy-target="[data-share-url]" title="Copy link">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5.5 4.5V3.5C5.5 2.39543 6.39543 1.5 7.5 1.5H12.5C13.6046 1.5 14.5 2.39543 14.5 3.5V8.5C14.5 9.60457 13.6046 10.5 12.5 10.5H11.5M5.5 4.5H3.5C2.39543 4.5 1.5 5.39543 1.5 6.5V11.5C1.5 12.6046 2.39543 13.5 3.5 13.5H8.5C9.60457 13.5 10.5 12.6046 10.5 11.5V9.5M5.5 4.5C5.5 5.60457 6.39543 6.5 7.5 6.5H9.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          <% } else { %>
            <div class="empty-state-message">
              <p>Complete your profile below to unlock portfolio sharing and quick actions.</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Quick Analytics (Sidebar Summary) -->
      <div class="dash-panel dash-panel--compact dash-sidebar__analytics" id="analytics-sidebar">
          <header class="dash-panel__header">
            <h3>Quick Analytics</h3>
          </header>
          <div class="dash-panel__body">
            <div class="analytics-loading" style="padding: 16px; text-align: center; color: var(--text-secondary); font-size: 13px;">
              Loading...
            </div>
            <div class="analytics-content" style="display: none;">
              <div class="analytics-stat">
                <span class="analytics-stat__label">Views</span>
                <span class="analytics-stat__value" id="analytics-sidebar-views-total">—</span>
                <span class="analytics-stat__subtext" id="analytics-sidebar-views-week">—</span>
              </div>
              <div class="analytics-stat">
                <span class="analytics-stat__label">Downloads</span>
                <span class="analytics-stat__value" id="analytics-sidebar-downloads-total">—</span>
                <span class="analytics-stat__subtext" id="analytics-sidebar-downloads-week">—</span>
              </div>
            </div>
            <div class="analytics-error" style="display: none; padding: 16px; text-align: center; color: var(--text-tertiary); font-size: 13px;">
              Analytics unavailable
            </div>
          </div>
        </div>

      <!-- Activity Feed -->
      <% if (typeof profile !== 'undefined' && profile && profile.id) { %>
        <div class="dash-panel dash-panel--compact dash-sidebar__activity" id="activity-panel">
          <header class="dash-panel__header">
            <h3>Recent Activity</h3>
          </header>
          <div class="dash-panel__body">
            <div class="activity-loading" style="padding: 16px; text-align: center; color: var(--text-secondary);">
              Loading activity...
            </div>
            <div class="activity-feed" id="activity-feed" style="display: none;">
              <!-- Activities will be populated by JavaScript -->
            </div>
            <div class="activity-empty" style="display: none; padding: 16px; text-align: center; color: var(--text-tertiary); font-size: 13px;">
              No recent activity
            </div>
            <div class="activity-error" style="display: none; padding: 16px; text-align: center; color: var(--text-tertiary); font-size: 13px;">
              Activity unavailable
            </div>
          </div>
        </div>
      <% } %>

      <!-- Account Status -->
      <% if (!safeProfile.is_pro) { %>
        <div class="dash-panel dash-panel--compact dash-sidebar__upgrade">
          <header class="dash-panel__header">
            <h3>Upgrade to Studio+</h3>
          </header>
          <div class="dash-panel__body">
            <p class="form-field__help" style="margin-bottom: 16px;">
              Remove watermarks, unlock advanced features, and get priority support
            </p>
            <a href="/pro/upgrade" class="button button-gold button-block">
              Upgrade Now
            </a>
          </div>
        </div>
      <% } else { %>
        <div class="dash-panel dash-panel--compact">
          <header class="dash-panel__header">
            <h3>Studio+ Account</h3>
          </header>
          <div class="dash-panel__body">
            <p class="form-field__help">
              ✓ Watermark-free PDFs<br>
              ✓ Advanced analytics<br>
              ✓ Priority support
            </p>
          </div>
        </div>
      <% } %>
    </div>
  </div>

  <!-- PDF Theme Selector Modal -->
  <div class="pdf-theme-modal" id="pdf-theme-modal" hidden>
    <div class="pdf-theme-modal__backdrop"></div>
    <div class="pdf-theme-modal__content">
      <header class="pdf-theme-modal__header">
        <div class="pdf-theme-modal__header-content">
          <h2 class="pdf-theme-modal__title">Select PDF Theme</h2>
          <p class="pdf-theme-modal__subtitle">Choose a theme for your comp card PDF</p>
        </div>
        <button type="button" class="pdf-theme-modal__close" aria-label="Close">&times;</button>
      </header>
      <div class="pdf-theme-modal__body">
        <div class="pdf-theme-modal__tabs">
          <button type="button" class="pdf-theme-modal__tab pdf-theme-modal__tab--active" data-theme-filter="all">All Themes</button>
          <button type="button" class="pdf-theme-modal__tab" data-theme-filter="free">Free</button>
          <button type="button" class="pdf-theme-modal__tab" data-theme-filter="pro">Studio+</button>
        </div>
        <div class="pdf-theme-grid" id="pdf-theme-grid">
          <!-- Themes will be populated by JavaScript -->
        </div>
        <div class="pdf-theme-modal__preview" id="pdf-theme-preview" style="display: none;">
          <div class="pdf-theme-modal__preview-header">
            <h3 class="pdf-theme-modal__preview-title">Live Preview</h3>
          </div>
          <div class="pdf-theme-modal__preview-container">
            <iframe id="pdf-theme-preview-iframe" class="pdf-theme-modal__preview-iframe" title="Theme Preview" loading="lazy"></iframe>
          </div>
        </div>
      </div>
      <footer class="pdf-theme-modal__footer">
        <button type="button" class="button button-secondary" id="pdf-theme-cancel">Cancel</button>
        <% if (safeProfile.is_pro) { %>
          <a href="/dashboard/pdf-customizer" class="button button-secondary" id="pdf-theme-customize" style="display: none;">Customize</a>
        <% } %>
        <button type="button" class="button button-primary" id="pdf-theme-apply">Apply Theme</button>
        <a href="#" class="button button-primary" id="pdf-theme-download">Download PDF</a>
      </footer>
    </div>
  </div>
  
  <script>
    // Pass theme data to JavaScript
    <% if (typeof profile !== 'undefined' && profile && profile.id) { %>
      window.PDF_THEME_DATA = {
        allThemes: <%- JSON.stringify(typeof allThemes !== 'undefined' ? allThemes : {}) %>,
        freeThemes: <%- JSON.stringify(typeof freeThemes !== 'undefined' ? freeThemes : []) %>,
        proThemes: <%- JSON.stringify(typeof proThemes !== 'undefined' ? proThemes : []) %>,
        currentTheme: '<%= (typeof currentTheme !== 'undefined' ? currentTheme : safeProfile.pdf_theme) || 'classic-serif' %>',
        isPro: <%= safeProfile.is_pro ? 'true' : 'false' %>,
        profileSlug: '<%= slug %>',
        baseUrl: '<%= typeof baseUrl !== 'undefined' ? baseUrl : '' %>'
      };
    <% } else { %>
      // No profile exists - set empty data to prevent errors
      window.PDF_THEME_DATA = {
        allThemes: {},
        freeThemes: [],
        proThemes: [],
        currentTheme: 'classic-serif',
        isPro: false,
        profileSlug: '',
        baseUrl: '<%= typeof baseUrl !== 'undefined' ? baseUrl : '' %>'
      };
    <% } %>

    // Auto-calculate age from date of birth
    (function() {
      const dateOfBirthInput = document.getElementById('date_of_birth');
      const ageInput = document.getElementById('age');
      
      if (dateOfBirthInput && ageInput) {
        function calculateAge(dateString) {
          if (!dateString) return null;
          
          const birthDate = new Date(dateString);
          const today = new Date();
          let age = today.getFullYear() - birthDate.getFullYear();
          const monthDiff = today.getMonth() - birthDate.getMonth();
          
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
          }
          
          return age >= 0 ? age : null;
        }
        
        function updateAge() {
          const dateOfBirth = dateOfBirthInput.value;
          if (dateOfBirth) {
            const age = calculateAge(dateOfBirth);
            if (age !== null) {
              ageInput.value = age;
            } else {
              ageInput.value = '';
            }
          } else {
            ageInput.value = '';
          }
        }
        
        dateOfBirthInput.addEventListener('change', updateAge);
        dateOfBirthInput.addEventListener('input', updateAge);
        
        // Calculate age on page load if date of birth is already set
        if (dateOfBirthInput.value) {
          updateAge();
        }
      }
    })();

    // Load and display applications
    (function() {
      const applicationsContainer = document.getElementById('applications-container');
      if (!applicationsContainer) return;

      async function loadApplications() {
        try {
          const response = await fetch('/api/talent/applications');
          if (!response.ok) throw new Error('Failed to load applications');
          
          const applications = await response.json();
          renderApplications(applications);
        } catch (error) {
          console.error('Error loading applications:', error);
          applicationsContainer.innerHTML = '<div class="applications-error" style="text-align: center; padding: 2rem; color: #ef4444;"><p>Failed to load applications. Please refresh the page.</p></div>';
        }
      }

      function renderApplications(applications) {
        if (applications.length === 0) {
          applicationsContainer.innerHTML = '<div class="applications-empty" style="text-align: center; padding: 2rem;"><p>You haven\'t applied to any agencies yet.</p><p style="margin-top: 0.5rem; color: #64748b;">Use the <a href="/apply">application form</a> to get started.</p></div>';
          return;
        }

        const statusColors = {
          pending: '#f59e0b',
          accepted: '#10b981',
          declined: '#ef4444',
          archived: '#6b7280'
        };

        applicationsContainer.innerHTML = `
          <div class="applications-list">
            ${applications.map(app => `
              <div class="application-card" data-application-id="${app.id}">
                <div class="application-card__header">
                  <h3 class="application-card__agency">${app.agencyName || app.agencyEmail}</h3>
                  <span class="application-card__status application-card__status--${app.status}" style="background: ${statusColors[app.status] || '#6b7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
                    ${app.status.charAt(0).toUpperCase() + app.status.slice(1)}
                  </span>
                </div>
                <div class="application-card__meta">
                  <span>Applied: ${new Date(app.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                  ${app.invitedByAgency ? '<span style="color: #f59e0b;">• Invited by agency</span>' : ''}
                </div>
                ${app.status === 'declined' ? '<p style="margin-top: 0.75rem; color: #64748b; font-size: 0.875rem;">Upgrade to Studio+ to get discovered by our entire network of partner agencies.</p>' : ''}
              </div>
            `).join('')}
          </div>
        `;
      }

      // Load applications on page load
      loadApplications();

      // Poll for updates every 30 seconds
      setInterval(loadApplications, 30000);
    })();

    // Discoverability toggle handler
    (function() {
      const toggle = document.getElementById('discoverability-toggle');
      if (!toggle) return;

      toggle.addEventListener('change', async function() {
        const isDiscoverable = this.checked;
        const originalChecked = this.checked;

        // Optimistically update UI
        this.disabled = true;

        try {
          const response = await fetch('/api/talent/discoverability', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ isDiscoverable })
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || 'Failed to update discoverability');
          }

          const data = await response.json();
          if (data.success) {
            // Success - keep the toggle state
            console.log('Discoverability updated:', isDiscoverable);
          } else {
            throw new Error('Update failed');
          }
        } catch (error) {
          console.error('Error updating discoverability:', error);
          alert(`Failed to update discoverability: ${error.message}`);
          // Revert toggle
          this.checked = !originalChecked;
        } finally {
          this.disabled = false;
        }
      });
    })();
  </script>