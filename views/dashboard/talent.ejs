<% const safeProfile=(typeof profile !=='undefined' && profile) ? profile : {}; const rawMedia=(typeof images
  !=='undefined' && images) ? images : []; const safeMedia=Array.isArray(rawMedia) ? rawMedia : []; const
  slug=safeProfile.slug || 'yourname' ; const effectiveShareUrl=(typeof shareUrl !=='undefined' ) ? shareUrl :
  `https://zipsite.me/${slug}`; const safeCompleteness=(typeof completeness !=='undefined' ) ? completeness : {}; const
  editDefaults={ city: safeProfile.city || '' , height_cm: safeProfile.height_cm || '' , measurements:
  safeProfile.measurements || '' , bio: safeProfile.bio_raw || '' }; const formValues=(typeof values !=='undefined' ) ?
  { ...editDefaults, ...values } : editDefaults; const _formErrors=(typeof formErrors !=='undefined' ) ? formErrors :
  {}; const valueFor=(key)=> formValues[key] || '';
  const fieldError = (key) => (_formErrors[key] && _formErrors[key].length) ? _formErrors[key][0] : null;
  const fieldHasError = (key) => Boolean(fieldError(key));

  // Helper function to normalize image paths
  function normalizeImagePath(imagePath) {
    if (!imagePath) return '';
    // Preserve external URLs
    if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
      return imagePath;
    }
    // Remove any ../ sequences and normalize
    let normalized = imagePath.replace(/\.\.\//g, '').replace(/\\/g, '/');
    // Ensure it starts with /
    if (!normalized.startsWith('/')) {
      normalized = '/' + normalized;
    }
    // If path contains /uploads/ but starts with /../, fix it
    if (normalized.includes('/uploads/')) {
      const uploadsIndex = normalized.indexOf('/uploads/');
      normalized = normalized.substring(uploadsIndex);
    }
    // If it doesn't start with /uploads/ and is a relative path, assume it's in uploads
    if (!normalized.startsWith('/uploads/') && !normalized.startsWith('http')) {
      // Extract filename if path contains one
      const parts = normalized.split('/');
      const filename = parts[parts.length - 1];
      if (filename && filename.includes('.')) {
        normalized = '/uploads/' + filename;
      }
    }
    return normalized;
  }

  // Get hero image
  const heroImage = safeProfile.hero_image_path || (safeMedia.length > 0 ? safeMedia[0].path : null);
  %>

  <!-- Hero Section with Talent Image -->
  <section class="dash-hero" id="overview" data-section="overview">
    <div class="dash-hero__image">
      <% if (heroImage) { %>
        <div class="dash-hero__image-placeholder">
          <div class="dash-hero__placeholder-shimmer"></div>
        </div>
        <img src="<%= normalizeImagePath(heroImage) %>"
          alt="<%= safeProfile.first_name %> <%= safeProfile.last_name %>"
          onload="this.classList.add('is-loaded')"
          onerror="this.classList.add('is-loaded')">
        <% } else { %>
          <div class="dash-hero__image-placeholder">
            Upload images to see your portfolio
          </div>
          <% } %>
    </div>

    <div class="dash-hero__copy">
      <div class="dash-hero__title-wrapper">
        <h1 class="dash-hero__title">
          <%= (safeProfile.first_name || 'Your' ) + ' ' + (safeProfile.last_name || 'Name' ) %>
        </h1>
        <% if (safeProfile.is_pro) { %>
          <span class="badge badge-pro">PRO</span>
          <% } else { %>
            <span class="badge badge-free">Free</span>
            <% } %>
      </div>

      <p class="dash-hero__subtitle">
        <%= safeProfile.city || 'Add your primary city' %>
      </p>

      <div class="dash-hero__stats">
        <div class="dash-hero__stat">
          <span class="dash-hero__stat-label">Height</span>
          <span class="dash-hero__stat-value">
            <%= safeProfile.height_cm ? safeProfile.height_cm + ' cm' : '‚Äî' %>
          </span>
        </div>
        <div class="dash-hero__stat">
          <span class="dash-hero__stat-label">Measurements</span>
          <span class="dash-hero__stat-value">
            <%= safeProfile.measurements || '‚Äî' %>
          </span>
        </div>
        <div class="dash-hero__stat">
          <span class="dash-hero__stat-label">Images</span>
          <span class="dash-hero__stat-value" id="hero-image-count">
            <%= safeMedia.length %>
          </span>
        </div>
        <% if (safeProfile.updated_at) { %>
          <div class="dash-hero__stat">
            <span class="dash-hero__stat-label">Last Updated</span>
            <span class="dash-hero__stat-value">
              <%= new Date(safeProfile.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
            </span>
          </div>
        <% } %>
        <% if (safeCompleteness && safeCompleteness.percentage !== undefined) { %>
          <div class="dash-hero__stat dash-hero__stat--completeness">
            <span class="dash-hero__stat-label">Profile</span>
            <span class="dash-hero__stat-value">
              <%= Math.round(safeCompleteness.percentage) %>%
            </span>
          </div>
        <% } %>
      </div>

      <div class="dash-hero__actions">
        <% if (typeof profile !== 'undefined' && profile && profile.id && safeProfile.slug) { %>
          <!-- Only show these buttons when profile exists -->
          <button type="button" class="button button-primary dash-hero__action" id="pdf-download-btn" data-slug="<%= slug %>" data-theme="<%= (typeof currentTheme !== 'undefined' ? currentTheme : safeProfile.pdf_theme) || 'classic-serif' %>" data-is-pro="<%= safeProfile.is_pro ? 'true' : 'false' %>">
            <span>Download Comp Card</span>
          </button>
          <% if (safeProfile.is_pro) { %>
            <a href="/dashboard/pdf-customizer" class="button button-secondary dash-hero__action">Customize PDF</a>
          <% } %>
          <a href="/portfolio/<%= slug %>" class="button button-secondary dash-hero__action" target="_blank" rel="noopener noreferrer">
            <span>View Portfolio</span>
          </a>
          <% if (!safeProfile.is_pro) { %>
            <a href="/pro/upgrade" class="button button-gold dash-hero__action dash-hero__action--upgrade">
              <span>Upgrade to Pro</span>
            </a>
          <% } %>
        <% } else { %>
          <!-- Show message when no profile exists -->
          <p class="dash-hero__no-profile-message">Complete your profile below to unlock PDF downloads and portfolio features.</p>
        <% } %>
      </div>
    </div>
  </section>

  <!-- Section Navigation -->
  <nav class="dash-nav" id="dash-nav">
    <div class="dash-nav__inner">
      <a href="#overview" class="dash-nav__link dash-nav__link--active" data-section="overview">
        <span class="dash-nav__icon">üìä</span>
        <span class="dash-nav__text">Overview</span>
      </a>
      <a href="#profile-details" class="dash-nav__link" data-section="profile-details">
        <span class="dash-nav__icon">‚úèÔ∏è</span>
        <span class="dash-nav__text">Profile Details</span>
      </a>
      <a href="#portfolio-imagery" class="dash-nav__link" data-section="portfolio-imagery">
        <span class="dash-nav__icon">üì∑</span>
        <span class="dash-nav__text">Portfolio Imagery</span>
      </a>
      <a href="#analytics" class="dash-nav__link" data-section="analytics">
        <span class="dash-nav__icon">üìà</span>
        <span class="dash-nav__text">Analytics</span>
      </a>
    </div>
  </nav>

  <!-- Main Dashboard Grid -->
  <div class="dash-grid">

    <!-- Left Column: Main Content -->
    <div class="dash-grid__column">

      <!-- Profile Details Form -->
      <div class="dash-panel" id="profile-details" data-section="profile-details">
        <header class="dash-panel__header">
          <h3>Profile Details</h3>
          <p>Your essential stats for agency rosters and comp cards</p>
        </header>
        <div class="dash-panel__body">
          <form method="post" action="/dashboard/talent" class="form-stacked">
            <div class="form-grid">
              <div class="form-field <%= fieldHasError('city') ? 'has-error' : '' %>">
                <label for="city">City</label>
                <input id="city" name="city" type="text" autocomplete="address-level2" value="<%= valueFor('city') %>"
                  placeholder="Los Angeles, CA">
                <% if (fieldHasError('city')) { %>
                  <p class="form-field__error">
                    <%= fieldError('city') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('phone') ? 'has-error' : '' %>">
                <label for="phone">Phone</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" value="<%= valueFor('phone') %>"
                  placeholder="+1 (555) 123-4567">
                <% if (fieldHasError('phone')) { %>
                  <p class="form-field__error">
                    <%= fieldError('phone') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('height_cm') ? 'has-error' : '' %>">
                <label for="height_cm">Height (cm)</label>
                <input id="height_cm" name="height_cm" type="number" min="120" max="220"
                  value="<%= valueFor('height_cm') %>" placeholder="177">
                <% if (fieldHasError('height_cm')) { %>
                  <p class="form-field__error">
                    <%= fieldError('height_cm') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field <%= fieldHasError('bust') ? 'has-error' : '' %>">
                <label for="bust">Bust</label>
                <input id="bust" name="bust" type="number" min="20" max="60" step="0.5"
                  value="<%= valueFor('bust') %>" placeholder="32">
                <% if (fieldHasError('bust')) { %>
                  <p class="form-field__error">
                    <%= fieldError('bust') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('waist') ? 'has-error' : '' %>">
                <label for="waist">Waist</label>
                <input id="waist" name="waist" type="number" min="20" max="60" step="0.5"
                  value="<%= valueFor('waist') %>" placeholder="25">
                <% if (fieldHasError('waist')) { %>
                  <p class="form-field__error">
                    <%= fieldError('waist') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('hips') ? 'has-error' : '' %>">
                <label for="hips">Hips</label>
                <input id="hips" name="hips" type="number" min="20" max="60" step="0.5"
                  value="<%= valueFor('hips') %>" placeholder="35">
                <% if (fieldHasError('hips')) { %>
                  <p class="form-field__error">
                    <%= fieldError('hips') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field <%= fieldHasError('measurements') ? 'has-error' : '' %>">
                <label for="measurements">Measurements (B-W-H)</label>
                <input id="measurements" name="measurements" type="text" value="<%= valueFor('measurements') %>"
                  placeholder="32-25-35">
                <% if (fieldHasError('measurements')) { %>
                  <p class="form-field__error">
                    <%= fieldError('measurements') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('shoe_size') ? 'has-error' : '' %>">
                <label for="shoe_size">Shoe Size</label>
                <input id="shoe_size" name="shoe_size" type="text" value="<%= valueFor('shoe_size') %>"
                  placeholder="9 US">
                <% if (fieldHasError('shoe_size')) { %>
                  <p class="form-field__error">
                    <%= fieldError('shoe_size') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('eye_color') ? 'has-error' : '' %>">
                <label for="eye_color">Eye Color</label>
                <input id="eye_color" name="eye_color" type="text" value="<%= valueFor('eye_color') %>"
                  placeholder="Brown">
                <% if (fieldHasError('eye_color')) { %>
                  <p class="form-field__error">
                    <%= fieldError('eye_color') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field <%= fieldHasError('hair_color') ? 'has-error' : '' %>">
                <label for="hair_color">Hair Color</label>
                <input id="hair_color" name="hair_color" type="text" value="<%= valueFor('hair_color') %>"
                  placeholder="Blonde">
                <% if (fieldHasError('hair_color')) { %>
                  <p class="form-field__error">
                    <%= fieldError('hair_color') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('hair_length') ? 'has-error' : '' %>">
                <label for="hair_length">Hair Length</label>
                <select id="hair_length" name="hair_length">
                  <option value="">Select...</option>
                  <option value="Short" <%= valueFor('hair_length') === 'Short' ? 'selected' : '' %>>Short</option>
                  <option value="Medium" <%= valueFor('hair_length') === 'Medium' ? 'selected' : '' %>>Medium</option>
                  <option value="Long" <%= valueFor('hair_length') === 'Long' ? 'selected' : '' %>>Long</option>
                  <option value="Very Long" <%= valueFor('hair_length') === 'Very Long' ? 'selected' : '' %>>Very Long</option>
                </select>
                <% if (fieldHasError('hair_length')) { %>
                  <p class="form-field__error">
                    <%= fieldError('hair_length') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-field <%= fieldHasError('skin_tone') ? 'has-error' : '' %>">
                <label for="skin_tone">Skin Tone</label>
                <input id="skin_tone" name="skin_tone" type="text" value="<%= valueFor('skin_tone') %>"
                  placeholder="Fair, Medium, Olive, etc.">
                <% if (fieldHasError('skin_tone')) { %>
                  <p class="form-field__error">
                    <%= fieldError('skin_tone') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <!-- Personal Details Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
              <h4 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">Personal Details</h4>
              
              <div class="form-grid">
                <div class="form-field <%= fieldHasError('gender') ? 'has-error' : '' %>">
                  <label for="gender">Gender</label>
                  <select id="gender" name="gender">
                    <option value="">Select...</option>
                    <option value="Male" <%= valueFor('gender') === 'Male' ? 'selected' : '' %>>Male</option>
                    <option value="Female" <%= valueFor('gender') === 'Female' ? 'selected' : '' %>>Female</option>
                    <option value="Non-binary" <%= valueFor('gender') === 'Non-binary' ? 'selected' : '' %>>Non-binary</option>
                    <option value="Other" <%= valueFor('gender') === 'Other' ? 'selected' : '' %>>Other</option>
                    <option value="Prefer not to say" <%= valueFor('gender') === 'Prefer not to say' ? 'selected' : '' %>>Prefer not to say</option>
                  </select>
                  <% if (fieldHasError('gender')) { %>
                    <p class="form-field__error">
                      <%= fieldError('gender') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('date_of_birth') ? 'has-error' : '' %>">
                  <label for="date_of_birth">Date of Birth</label>
                  <input id="date_of_birth" name="date_of_birth" type="date" value="<%= valueFor('date_of_birth') %>">
                  <% if (fieldHasError('date_of_birth')) { %>
                    <p class="form-field__error">
                      <%= fieldError('date_of_birth') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('age') ? 'has-error' : '' %>">
                  <label for="age">Age</label>
                  <input id="age" name="age" type="number" min="0" max="150" value="<%= valueFor('age') %>" readonly
                    style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="Auto-calculated">
                  <p class="form-field__help" style="font-size: 0.85rem; margin-top: 0.25rem;">
                    Automatically calculated from date of birth
                  </p>
                  <% if (fieldHasError('age')) { %>
                    <p class="form-field__error">
                      <%= fieldError('age') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldHasError('weight_kg') ? 'has-error' : '' %>">
                  <label for="weight_kg">Weight (kg)</label>
                  <input id="weight_kg" name="weight_kg" type="number" step="0.1" min="30" max="200"
                    value="<%= valueFor('weight_kg') %>" placeholder="65">
                  <% if (fieldHasError('weight_kg')) { %>
                    <p class="form-field__error">
                      <%= fieldError('weight_kg') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('weight_lbs') ? 'has-error' : '' %>">
                  <label for="weight_lbs">Weight (lbs)</label>
                  <input id="weight_lbs" name="weight_lbs" type="number" step="0.1" min="66" max="440"
                    value="<%= valueFor('weight_lbs') %>" placeholder="143">
                  <% if (fieldHasError('weight_lbs')) { %>
                    <p class="form-field__error">
                      <%= fieldError('weight_lbs') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('dress_size') ? 'has-error' : '' %>">
                  <label for="dress_size">Dress Size</label>
                  <input id="dress_size" name="dress_size" type="text" value="<%= valueFor('dress_size') %>"
                    placeholder="6 US">
                  <% if (fieldHasError('dress_size')) { %>
                    <p class="form-field__error">
                      <%= fieldError('dress_size') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldHasError('nationality') ? 'has-error' : '' %>">
                  <label for="nationality">Nationality</label>
                  <input id="nationality" name="nationality" type="text" value="<%= valueFor('nationality') %>"
                    placeholder="American">
                  <% if (fieldHasError('nationality')) { %>
                    <p class="form-field__error">
                      <%= fieldError('nationality') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('ethnicity') ? 'has-error' : '' %>">
                  <label for="ethnicity">Ethnicity</label>
                  <input id="ethnicity" name="ethnicity" type="text" value="<%= valueFor('ethnicity') %>"
                    placeholder="Optional">
                  <% if (fieldHasError('ethnicity')) { %>
                    <p class="form-field__error">
                      <%= fieldError('ethnicity') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('union_membership') ? 'has-error' : '' %>">
                  <label for="union_membership">Union Membership</label>
                  <input id="union_membership" name="union_membership" type="text" value="<%= valueFor('union_membership') %>"
                    placeholder="SAG-AFTRA, AEA, etc.">
                  <% if (fieldHasError('union_membership')) { %>
                    <p class="form-field__error">
                      <%= fieldError('union_membership') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldHasError('tattoos') ? 'has-error' : '' %>">
                  <label>
                    <input type="checkbox" name="tattoos" value="true" <%= valueFor('tattoos') === 'true' || valueFor('tattoos') === true ? 'checked' : '' %>>
                    <span>Has Tattoos</span>
                  </label>
                  <% if (fieldHasError('tattoos')) { %>
                    <p class="form-field__error">
                      <%= fieldError('tattoos') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('piercings') ? 'has-error' : '' %>">
                  <label>
                    <input type="checkbox" name="piercings" value="true" <%= valueFor('piercings') === 'true' || valueFor('piercings') === true ? 'checked' : '' %>>
                    <span>Has Piercings</span>
                  </label>
                  <% if (fieldHasError('piercings')) { %>
                    <p class="form-field__error">
                      <%= fieldError('piercings') %>
                    </p>
                    <% } %>
                </div>
              </div>
            </div>

            <div class="form-field <%= fieldHasError('bio') ? 'has-error' : '' %>">
              <label for="bio">Editorial Bio</label>
              <textarea id="bio" name="bio" rows="5"
                placeholder="Experienced in runway, editorial, commercial, and beauty campaigns..."><%= valueFor('bio') %></textarea>
              <p class="form-field__help">
                Write naturally. Our AI will refine this into a polished editorial bio.
              </p>
              <% if (fieldHasError('bio')) { %>
                <p class="form-field__error">
                  <%= fieldError('bio') %>
                </p>
                <% } %>
            </div>

            <% if (safeProfile && safeProfile.bio_curated) { %>
              <div class="form-field--readonly">
                <label>AI-Refined Bio (Live on Portfolio)</label>
                <p class="form-field__static-text">
                  <%= safeProfile.bio_curated %>
                </p>
              </div>
              <% } %>

            <!-- Specialties Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
              <div class="form-field">
                <label>Specialties / Categories</label>
                <p class="form-field__help">Select all that apply</p>
                <div class="checkbox-group">
                  <% 
                    const specialtiesValue = valueFor('specialties', '');
                    let specialtiesArray = [];
                    if (Array.isArray(specialtiesValue)) {
                      specialtiesArray = specialtiesValue;
                    } else if (typeof specialtiesValue === 'string') {
                      try {
                        specialtiesArray = JSON.parse(specialtiesValue);
                      } catch {
                        specialtiesArray = specialtiesValue ? specialtiesValue.split(',').map(s => s.trim()).filter(s => s) : [];
                      }
                    }
                    const hasSpecialty = (val) => specialtiesArray.includes(val);
                  %>
                  <label class="checkbox-label">
                    <input type="checkbox" name="specialties" value="Editorial" <%= hasSpecialty('Editorial') ? 'checked' : '' %>>
                    <span>Editorial</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="specialties" value="Commercial" <%= hasSpecialty('Commercial') ? 'checked' : '' %>>
                    <span>Commercial</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="specialties" value="Runway" <%= hasSpecialty('Runway') ? 'checked' : '' %>>
                    <span>Runway</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="specialties" value="Fitness" <%= hasSpecialty('Fitness') ? 'checked' : '' %>>
                    <span>Fitness</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="specialties" value="Parts" <%= hasSpecialty('Parts') ? 'checked' : '' %>>
                    <span>Parts (Hands, Feet, etc.)</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="specialties" value="Other" <%= hasSpecialty('Other') ? 'checked' : '' %>>
                    <span>Other</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Experience & Availability Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
              <h4 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">Experience & Availability</h4>
              
              <div class="form-field">
                <label>Languages</label>
                <p class="form-field__help">Select all languages you speak</p>
                <div class="checkbox-group">
                  <% 
                    const languagesValue = valueFor('languages', '');
                    let languagesArray = [];
                    if (Array.isArray(languagesValue)) {
                      languagesArray = languagesValue;
                    } else if (typeof languagesValue === 'string') {
                      try {
                        languagesArray = JSON.parse(languagesValue);
                      } catch {
                        languagesArray = languagesValue ? languagesValue.split(',').map(l => l.trim()).filter(l => l) : [];
                      }
                    }
                    const hasLanguage = (val) => languagesArray.includes(val);
                  %>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="English" <%= hasLanguage('English') ? 'checked' : '' %>>
                    <span>English</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="Spanish" <%= hasLanguage('Spanish') ? 'checked' : '' %>>
                    <span>Spanish</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="French" <%= hasLanguage('French') ? 'checked' : '' %>>
                    <span>French</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="Italian" <%= hasLanguage('Italian') ? 'checked' : '' %>>
                    <span>Italian</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="German" <%= hasLanguage('German') ? 'checked' : '' %>>
                    <span>German</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="Portuguese" <%= hasLanguage('Portuguese') ? 'checked' : '' %>>
                    <span>Portuguese</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="Mandarin" <%= hasLanguage('Mandarin') ? 'checked' : '' %>>
                    <span>Mandarin</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="Japanese" <%= hasLanguage('Japanese') ? 'checked' : '' %>>
                    <span>Japanese</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="Korean" <%= hasLanguage('Korean') ? 'checked' : '' %>>
                    <span>Korean</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="languages" value="Other" <%= hasLanguage('Other') ? 'checked' : '' %>>
                    <span>Other</span>
                  </label>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldHasError('availability_travel') ? 'has-error' : '' %>">
                  <label>
                    <input type="checkbox" name="availability_travel" value="true" <%= valueFor('availability_travel') === 'true' || valueFor('availability_travel') === true ? 'checked' : '' %>>
                    <span>Available for Travel</span>
                  </label>
                  <% if (fieldHasError('availability_travel')) { %>
                    <p class="form-field__error">
                      <%= fieldError('availability_travel') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('availability_schedule') ? 'has-error' : '' %>">
                  <label for="availability_schedule">Availability Schedule</label>
                  <select id="availability_schedule" name="availability_schedule">
                    <option value="">Select...</option>
                    <option value="Full-time" <%= valueFor('availability_schedule') === 'Full-time' ? 'selected' : '' %>>Full-time</option>
                    <option value="Part-time" <%= valueFor('availability_schedule') === 'Part-time' ? 'selected' : '' %>>Part-time</option>
                    <option value="Flexible" <%= valueFor('availability_schedule') === 'Flexible' ? 'selected' : '' %>>Flexible</option>
                    <option value="Weekends only" <%= valueFor('availability_schedule') === 'Weekends only' ? 'selected' : '' %>>Weekends only</option>
                  </select>
                  <% if (fieldHasError('availability_schedule')) { %>
                    <p class="form-field__error">
                      <%= fieldError('availability_schedule') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field <%= fieldHasError('experience_level') ? 'has-error' : '' %>">
                  <label for="experience_level">Experience Level</label>
                  <select id="experience_level" name="experience_level">
                    <option value="">Select...</option>
                    <option value="Beginner" <%= valueFor('experience_level') === 'Beginner' ? 'selected' : '' %>>Beginner</option>
                    <option value="Intermediate" <%= valueFor('experience_level') === 'Intermediate' ? 'selected' : '' %>>Intermediate</option>
                    <option value="Experienced" <%= valueFor('experience_level') === 'Experienced' ? 'selected' : '' %>>Experienced</option>
                    <option value="Professional" <%= valueFor('experience_level') === 'Professional' ? 'selected' : '' %>>Professional</option>
                  </select>
                  <% if (fieldHasError('experience_level')) { %>
                    <p class="form-field__error">
                      <%= fieldError('experience_level') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('training') ? 'has-error' : '' %>">
                  <label for="training">Training</label>
                  <textarea id="training" name="training" rows="3" value="<%= valueFor('training') %>"
                    placeholder="Formal training in editorial modeling and commercial acting."><%= valueFor('training') %></textarea>
                  <% if (fieldHasError('training')) { %>
                    <p class="form-field__error">
                      <%= fieldError('training') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-field <%= fieldHasError('portfolio_url') ? 'has-error' : '' %>">
                <label for="portfolio_url">Portfolio URL</label>
                <input id="portfolio_url" name="portfolio_url" type="url" value="<%= valueFor('portfolio_url') %>"
                  placeholder="https://yourportfolio.com">
                <% if (fieldHasError('portfolio_url')) { %>
                  <p class="form-field__error">
                    <%= fieldError('portfolio_url') %>
                  </p>
                  <% } %>
              </div>
            </div>

            <!-- Social Media Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
              <h4 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">Social Media</h4>
              <p class="form-field__help" style="margin-bottom: 1rem; font-size: 0.9rem;">
                Free users: Handles display as text only. Pro users: Handles are clickable links.
              </p>
              
              <div class="form-grid">
                <div class="form-field <%= fieldHasError('instagram_handle') ? 'has-error' : '' %>">
                  <label for="instagram_handle">Instagram Handle</label>
                  <input id="instagram_handle" name="instagram_handle" type="text" value="<%= valueFor('instagram_handle') %>"
                    placeholder="@username or username">
                  <% if (fieldHasError('instagram_handle')) { %>
                    <p class="form-field__error">
                      <%= fieldError('instagram_handle') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('twitter_handle') ? 'has-error' : '' %>">
                  <label for="twitter_handle">Twitter/X Handle</label>
                  <input id="twitter_handle" name="twitter_handle" type="text" value="<%= valueFor('twitter_handle') %>"
                    placeholder="@username or username">
                  <% if (fieldHasError('twitter_handle')) { %>
                    <p class="form-field__error">
                      <%= fieldError('twitter_handle') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('tiktok_handle') ? 'has-error' : '' %>">
                  <label for="tiktok_handle">TikTok Handle</label>
                  <input id="tiktok_handle" name="tiktok_handle" type="text" value="<%= valueFor('tiktok_handle') %>"
                    placeholder="@username or username">
                  <% if (fieldHasError('tiktok_handle')) { %>
                    <p class="form-field__error">
                      <%= fieldError('tiktok_handle') %>
                    </p>
                    <% } %>
                </div>
              </div>
            </div>

            <!-- References & Emergency Contact Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
              <h4 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">References & Emergency Contact</h4>
              
              <div class="form-grid">
                <div class="form-field <%= fieldHasError('reference_name') ? 'has-error' : '' %>">
                  <label for="reference_name">Reference Name</label>
                  <input id="reference_name" name="reference_name" type="text" value="<%= valueFor('reference_name') %>"
                    placeholder="John Doe">
                  <% if (fieldHasError('reference_name')) { %>
                    <p class="form-field__error">
                      <%= fieldError('reference_name') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('reference_email') ? 'has-error' : '' %>">
                  <label for="reference_email">Reference Email</label>
                  <input id="reference_email" name="reference_email" type="email" value="<%= valueFor('reference_email') %>"
                    placeholder="john@example.com">
                  <% if (fieldHasError('reference_email')) { %>
                    <p class="form-field__error">
                      <%= fieldError('reference_email') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('reference_phone') ? 'has-error' : '' %>">
                  <label for="reference_phone">Reference Phone</label>
                  <input id="reference_phone" name="reference_phone" type="tel" value="<%= valueFor('reference_phone') %>"
                    placeholder="+1 (555) 123-4567">
                  <% if (fieldHasError('reference_phone')) { %>
                    <p class="form-field__error">
                      <%= fieldError('reference_phone') %>
                    </p>
                    <% } %>
                </div>
              </div>

              <div class="form-field <%= fieldHasError('reference_relationship') ? 'has-error' : '' %>">
                <label for="reference_relationship">Reference Relationship</label>
                <input id="reference_relationship" name="reference_relationship" type="text" value="<%= valueFor('reference_relationship') %>"
                  placeholder="Agent, Manager, etc.">
                <% if (fieldHasError('reference_relationship')) { %>
                  <p class="form-field__error">
                    <%= fieldError('reference_relationship') %>
                  </p>
                  <% } %>
              </div>

              <div class="form-grid" style="margin-top: 1.5rem;">
                <div class="form-field <%= fieldHasError('emergency_contact_name') ? 'has-error' : '' %>">
                  <label for="emergency_contact_name">Emergency Contact Name</label>
                  <input id="emergency_contact_name" name="emergency_contact_name" type="text" value="<%= valueFor('emergency_contact_name') %>"
                    placeholder="Jane Doe">
                  <% if (fieldHasError('emergency_contact_name')) { %>
                    <p class="form-field__error">
                      <%= fieldError('emergency_contact_name') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('emergency_contact_phone') ? 'has-error' : '' %>">
                  <label for="emergency_contact_phone">Emergency Contact Phone</label>
                  <input id="emergency_contact_phone" name="emergency_contact_phone" type="tel" value="<%= valueFor('emergency_contact_phone') %>"
                    placeholder="+1 (555) 123-4567">
                  <% if (fieldHasError('emergency_contact_phone')) { %>
                    <p class="form-field__error">
                      <%= fieldError('emergency_contact_phone') %>
                    </p>
                    <% } %>
                </div>

                <div class="form-field <%= fieldHasError('emergency_contact_relationship') ? 'has-error' : '' %>">
                  <label for="emergency_contact_relationship">Emergency Contact Relationship</label>
                  <input id="emergency_contact_relationship" name="emergency_contact_relationship" type="text" value="<%= valueFor('emergency_contact_relationship') %>"
                    placeholder="Parent, Spouse, etc.">
                  <% if (fieldHasError('emergency_contact_relationship')) { %>
                    <p class="form-field__error">
                      <%= fieldError('emergency_contact_relationship') %>
                    </p>
                    <% } %>
                </div>
              </div>
            </div>

                <div class="form-actions">
                  <button class="button-primary" type="submit">Save Changes</button>
                </div>
          </form>
        </div>
      </div>

      <!-- Portfolio Imagery -->
      <div class="dash-panel" id="portfolio-imagery" data-section="portfolio-imagery">
        <header class="dash-panel__header">
          <h3>Portfolio Imagery</h3>
          <p>Upload 6-12 high-quality images. The first image becomes your hero shot.</p>
        </header>
        <div class="dash-panel__body">
          <form action="/dashboard/talent/media" method="post" enctype="multipart/form-data" class="form-stacked"
            style="margin-bottom: 32px;" id="media-upload-form">
            <div class="form-field">
              <label for="media">Select Images</label>
              <div class="file-upload-wrapper">
                <input id="media" name="media" type="file" accept="image/jpeg,image/png,image/webp" multiple
                  class="file-upload-input">
                <label for="media" class="file-upload-label">
                  <span class="file-upload-icon">üì∑</span>
                  <span class="file-upload-text">
                    <span class="file-upload-text-primary">Choose images to upload</span>
                    <span class="file-upload-text-secondary">or drag and drop</span>
                  </span>
                </label>
                <div class="file-upload-preview" id="file-preview"></div>
              </div>
              <p class="form-field__help">
                JPEG, PNG, or WebP. Maximum 10MB per image. Up to 12 images.
              </p>
            </div>
            <div class="form-actions">
              <button class="button-primary" type="submit" id="upload-button">Upload Images</button>
            </div>
          </form>

          <% if (safeMedia.length) { %>
            <div class="media-grid" data-media-grid id="media-grid">
              <% safeMedia.forEach((image, index)=> { %>
                <% 
                  // Check if this is the hero image
                  const isHeroImage = heroImage && (normalizeImagePath(image.path) === normalizeImagePath(heroImage) || image.path === heroImage || image.path === safeProfile.hero_image_path);
                %>
                <article class="media-card" 
                         data-media-id="<%= image.id %>" 
                         data-sort="<%= image.sort || index + 1 %>"
                         draggable="true"
                         role="button"
                         tabindex="0"
                         aria-label="Drag to reorder image">
                  <div class="media-card__drag-handle" title="Drag to reorder">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="7" cy="5" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="13" cy="5" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="7" cy="10" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="13" cy="10" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="7" cy="15" r="1.5" fill="currentColor" opacity="0.4"/>
                      <circle cx="13" cy="15" r="1.5" fill="currentColor" opacity="0.4"/>
                    </svg>
                  </div>
                  <div class="media-card__image-placeholder">
                    <div class="media-card__placeholder-shimmer"></div>
                  </div>
                  <img src="<%= normalizeImagePath(image.path) %>"
                    alt="<%= image.label || 'Portfolio image' %>" 
                    loading="lazy"
                    onload="this.classList.add('is-loaded')"
                    onerror="this.classList.add('is-loaded')">
                  <div class="media-card__controls">
                    <% if (isHeroImage) { %>
                      <span class="media-card__hero-badge" title="Hero Image">‚òÖ</span>
                    <% } else { %>
                      <button class="media-card__set-hero" type="button" title="Set as Hero Image" data-image-id="<%= image.id %>" data-image-path="<%= normalizeImagePath(image.path) %>">Set Hero</button>
                    <% } %>
                    <button class="media-card__delete" type="button" title="Delete image" data-image-id="<%= image.id %>">&times;</button>
                  </div>
                </article>
                <% }); %>
            </div>
            <% } else { %>
              <div class="empty-state">
                <p>No images yet. Upload your first portfolio images to get started.</p>
              </div>
              <% } %>
        </div>
      </div>
    </div>

    <!-- Right Column: Quick Actions Sidebar -->
    <div class="dash-grid__column dash-sidebar">
      <!-- Quick Stats -->
      <div class="dash-panel dash-panel--compact dash-sidebar__stats">
        <header class="dash-panel__header">
          <h3>Quick Stats</h3>
        </header>
        <div class="dash-panel__body">
          <div class="dash-sidebar__stat">
            <span class="dash-sidebar__stat-label">Images</span>
            <span class="dash-sidebar__stat-value" id="sidebar-image-count"><%= safeMedia.length %></span>
          </div>
          <% if (safeCompleteness && safeCompleteness.percentage !== undefined) { %>
            <div class="dash-sidebar__stat">
              <span class="dash-sidebar__stat-label">Profile</span>
              <span class="dash-sidebar__stat-value"><%= Math.round(safeCompleteness.percentage) %>%</span>
            </div>
          <% } %>
          <% if (safeProfile.updated_at) { %>
            <div class="dash-sidebar__stat">
              <span class="dash-sidebar__stat-label">Last Updated</span>
              <span class="dash-sidebar__stat-value" style="font-size: 12px;">
                <%= new Date(safeProfile.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
              </span>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="dash-panel dash-panel--compact dash-sidebar__actions">
        <header class="dash-panel__header">
          <h3>Quick Actions</h3>
        </header>
        <div class="dash-panel__body">
          <% if (typeof profile !== 'undefined' && profile && profile.id && safeProfile.slug) { %>
            <div class="dash-sidebar__action-buttons">
              <button type="button" class="button button-primary dash-sidebar__action-btn" id="sidebar-pdf-download-btn" data-slug="<%= slug %>" data-theme="<%= (typeof currentTheme !== 'undefined' ? currentTheme : safeProfile.pdf_theme) || 'classic-serif' %>" data-is-pro="<%= safeProfile.is_pro ? 'true' : 'false' %>">
                <span>üìÑ</span>
                <span>Download PDF</span>
              </button>
              <a href="/portfolio/<%= slug %>" class="button button-secondary dash-sidebar__action-btn" target="_blank" rel="noopener noreferrer">
                <span>üëÅÔ∏è</span>
                <span>View Portfolio</span>
              </a>
              <button type="button" class="button button-secondary dash-sidebar__action-btn" data-copy-target="[data-share-url]">
                <span>üîó</span>
                <span>Share Link</span>
              </button>
              <% if (safeProfile.is_pro) { %>
                <a href="/dashboard/pdf-customizer" class="button button-secondary dash-sidebar__action-btn">
                  <span>üé®</span>
                  <span>Customize PDF</span>
                </a>
              <% } %>
            </div>
          <% } else { %>
            <p class="form-field__help" style="margin-bottom: 16px; text-align: center;">
              Complete your profile to unlock quick actions
            </p>
          <% } %>
        </div>
      </div>

      <!-- Profile Status -->
      <div class="dash-panel dash-panel--compact">
        <header class="dash-panel__header">
          <h3>Profile Status</h3>
        </header>
        <div class="dash-panel__body">
          <p class="form-field__help" style="margin-bottom: 16px;">
            Complete all requirements to activate your profile for agencies
          </p>
          <div class="completion-chips">
            <span class="chip <%= safeCompleteness.basics ? 'is-complete' : '' %>">
              Profile Details
            </span>
            <span class="chip <%= safeCompleteness.imagery ? 'is-complete' : '' %>">
              2+ Images
            </span>
            <span class="chip <%= safeCompleteness.hero ? 'is-complete' : '' %>">
              Hero Image
            </span>
          </div>
        </div>
      </div>

      <!-- Share Portfolio -->
      <div class="dash-panel dash-panel--compact">
        <header class="dash-panel__header">
          <h3>Share Portfolio</h3>
        </header>
        <div class="dash-panel__body">
          <div class="share-url" data-share-url>
            <%= effectiveShareUrl %>
          </div>
        </div>
      </div>

      <!-- Portfolio Analytics -->
      <% if (typeof profile !== 'undefined' && profile && profile.id) { %>
        <div class="dash-panel dash-panel--compact dash-sidebar__analytics" id="analytics" data-section="analytics">
          <header class="dash-panel__header">
            <h3>Portfolio Analytics</h3>
          </header>
          <div class="dash-panel__body">
            <div class="analytics-loading" style="padding: 16px; text-align: center; color: var(--text-secondary);">
              Loading analytics...
            </div>
            <div class="analytics-content" style="display: none;">
              <div class="analytics-stat">
                <span class="analytics-stat__label">Views</span>
                <span class="analytics-stat__value" id="analytics-views-total">‚Äî</span>
                <span class="analytics-stat__subtext" id="analytics-views-week">‚Äî</span>
              </div>
              <div class="analytics-stat">
                <span class="analytics-stat__label">Downloads</span>
                <span class="analytics-stat__value" id="analytics-downloads-total">‚Äî</span>
                <span class="analytics-stat__subtext" id="analytics-downloads-week">‚Äî</span>
              </div>
            </div>
            <div class="analytics-error" style="display: none; padding: 16px; text-align: center; color: var(--text-tertiary); font-size: 13px;">
              Analytics unavailable
            </div>
          </div>
        </div>
      <% } %>

      <!-- Activity Feed -->
      <% if (typeof profile !== 'undefined' && profile && profile.id) { %>
        <div class="dash-panel dash-panel--compact dash-sidebar__activity" id="activity-panel">
          <header class="dash-panel__header">
            <h3>Recent Activity</h3>
          </header>
          <div class="dash-panel__body">
            <div class="activity-loading" style="padding: 16px; text-align: center; color: var(--text-secondary);">
              Loading activity...
            </div>
            <div class="activity-feed" id="activity-feed" style="display: none;">
              <!-- Activities will be populated by JavaScript -->
            </div>
            <div class="activity-empty" style="display: none; padding: 16px; text-align: center; color: var(--text-tertiary); font-size: 13px;">
              No recent activity
            </div>
            <div class="activity-error" style="display: none; padding: 16px; text-align: center; color: var(--text-tertiary); font-size: 13px;">
              Activity unavailable
            </div>
          </div>
        </div>
      <% } %>

      <!-- Account Status -->
      <% if (!safeProfile.is_pro) { %>
        <div class="dash-panel dash-panel--compact dash-sidebar__upgrade">
          <header class="dash-panel__header">
            <h3>Upgrade to Pro</h3>
          </header>
          <div class="dash-panel__body">
            <p class="form-field__help" style="margin-bottom: 16px;">
              Remove watermarks, unlock advanced features, and get priority support
            </p>
            <a href="/pro/upgrade" class="button button-gold button-block">
              Upgrade Now
            </a>
          </div>
        </div>
      <% } else { %>
        <div class="dash-panel dash-panel--compact">
          <header class="dash-panel__header">
            <h3>Pro Account</h3>
          </header>
          <div class="dash-panel__body">
            <p class="form-field__help">
              ‚úì Watermark-free PDFs<br>
              ‚úì Advanced analytics<br>
              ‚úì Priority support
            </p>
          </div>
        </div>
      <% } %>
    </div>
  </div>

  <!-- PDF Theme Selector Modal -->
  <div class="pdf-theme-modal" id="pdf-theme-modal" hidden>
    <div class="pdf-theme-modal__backdrop"></div>
    <div class="pdf-theme-modal__content">
      <header class="pdf-theme-modal__header">
        <div class="pdf-theme-modal__header-content">
          <h2 class="pdf-theme-modal__title">Select PDF Theme</h2>
          <p class="pdf-theme-modal__subtitle">Choose a theme for your comp card PDF</p>
        </div>
        <button type="button" class="pdf-theme-modal__close" aria-label="Close">&times;</button>
      </header>
      <div class="pdf-theme-modal__body">
        <div class="pdf-theme-modal__tabs">
          <button type="button" class="pdf-theme-modal__tab pdf-theme-modal__tab--active" data-theme-filter="all">All Themes</button>
          <button type="button" class="pdf-theme-modal__tab" data-theme-filter="free">Free</button>
          <button type="button" class="pdf-theme-modal__tab" data-theme-filter="pro">Pro</button>
        </div>
        <div class="pdf-theme-grid" id="pdf-theme-grid">
          <!-- Themes will be populated by JavaScript -->
        </div>
        <div class="pdf-theme-modal__preview" id="pdf-theme-preview" style="display: none;">
          <div class="pdf-theme-modal__preview-header">
            <h3 class="pdf-theme-modal__preview-title">Live Preview</h3>
          </div>
          <div class="pdf-theme-modal__preview-container">
            <iframe id="pdf-theme-preview-iframe" class="pdf-theme-modal__preview-iframe" title="Theme Preview" loading="lazy"></iframe>
          </div>
        </div>
      </div>
      <footer class="pdf-theme-modal__footer">
        <button type="button" class="button button-secondary" id="pdf-theme-cancel">Cancel</button>
        <% if (safeProfile.is_pro) { %>
          <a href="/dashboard/pdf-customizer" class="button button-secondary" id="pdf-theme-customize" style="display: none;">Customize</a>
        <% } %>
        <button type="button" class="button button-primary" id="pdf-theme-apply">Apply Theme</button>
        <a href="#" class="button button-primary" id="pdf-theme-download">Download PDF</a>
      </footer>
    </div>
  </div>
  
  <script>
    // Pass theme data to JavaScript
    <% if (typeof profile !== 'undefined' && profile && profile.id) { %>
      window.PDF_THEME_DATA = {
        allThemes: <%- JSON.stringify(typeof allThemes !== 'undefined' ? allThemes : {}) %>,
        freeThemes: <%- JSON.stringify(typeof freeThemes !== 'undefined' ? freeThemes : []) %>,
        proThemes: <%- JSON.stringify(typeof proThemes !== 'undefined' ? proThemes : []) %>,
        currentTheme: '<%= (typeof currentTheme !== 'undefined' ? currentTheme : safeProfile.pdf_theme) || 'classic-serif' %>',
        isPro: <%= safeProfile.is_pro ? 'true' : 'false' %>,
        profileSlug: '<%= slug %>',
        baseUrl: '<%= typeof baseUrl !== 'undefined' ? baseUrl : '' %>'
      };
    <% } else { %>
      // No profile exists - set empty data to prevent errors
      window.PDF_THEME_DATA = {
        allThemes: {},
        freeThemes: [],
        proThemes: [],
        currentTheme: 'classic-serif',
        isPro: false,
        profileSlug: '',
        baseUrl: '<%= typeof baseUrl !== 'undefined' ? baseUrl : '' %>'
      };
    <% } %>

    // Auto-calculate age from date of birth
    (function() {
      const dateOfBirthInput = document.getElementById('date_of_birth');
      const ageInput = document.getElementById('age');
      
      if (dateOfBirthInput && ageInput) {
        function calculateAge(dateString) {
          if (!dateString) return null;
          
          const birthDate = new Date(dateString);
          const today = new Date();
          let age = today.getFullYear() - birthDate.getFullYear();
          const monthDiff = today.getMonth() - birthDate.getMonth();
          
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
          }
          
          return age >= 0 ? age : null;
        }
        
        function updateAge() {
          const dateOfBirth = dateOfBirthInput.value;
          if (dateOfBirth) {
            const age = calculateAge(dateOfBirth);
            if (age !== null) {
              ageInput.value = age;
            } else {
              ageInput.value = '';
            }
          } else {
            ageInput.value = '';
          }
        }
        
        dateOfBirthInput.addEventListener('change', updateAge);
        dateOfBirthInput.addEventListener('input', updateAge);
        
        // Calculate age on page load if date of birth is already set
        if (dateOfBirthInput.value) {
          updateAge();
        }
      }
    })();
  </script>