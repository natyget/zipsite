<% 
  const safeProfiles = (typeof profiles !== 'undefined' && profiles) ? profiles : [];
  const safeFilters = (typeof filters !== 'undefined') ? filters : {};
  const safeCommissionsTotal = (typeof commissionsTotal !== 'undefined') ? commissionsTotal : '0.00';
  const safeLatestCommissions = (typeof latestCommissions !== 'undefined' && latestCommissions) ? latestCommissions : [];
  const currentUser = (typeof user !== 'undefined' && user) ? user : {};
  const safeStats = (typeof stats !== 'undefined') ? stats : {
    total: 0,
    pending: 0,
    accepted: 0,
    declined: 0,
    archived: 0,
    newToday: 0,
    newThisWeek: 0
  };

  // Helper to normalize image paths
  function normalizeImagePath(path) {
    if (!path) return '';
    if (path.startsWith('http://') || path.startsWith('https://')) return path;
    if (path.startsWith('/')) return path;
    return '/' + path;
  }

  // Group profiles by application status for Kanban board
  const profilesByStatus = {
    pending: [],
    'under-review': [],
    accepted: [],
    archived: []
  };

  safeProfiles.forEach(profile => {
    const appStatus = profile.application_status || 'pending';
    if (appStatus === 'pending' || !appStatus) {
      profilesByStatus.pending.push(profile);
    } else if (appStatus === 'accepted') {
      profilesByStatus.accepted.push(profile);
    } else if (appStatus === 'archived') {
      profilesByStatus.archived.push(profile);
    } else {
      profilesByStatus['under-review'].push(profile);
    }
  });
%>

<!-- Agency Dashboard - Premium AI Studio -->
<div class="agency-dashboard" id="agency-dashboard">
  
  <!-- Agency Hero Section -->
  <section class="agency-hero" id="agency-overview">
    <div class="agency-hero__content">
      <div class="agency-hero__main">
        <div class="agency-hero__header">
          <div class="agency-hero__logo">
            <% if (currentUser && currentUser.agency_name) { %>
              <div class="agency-hero__logo-placeholder">
                <%= currentUser.agency_name.charAt(0).toUpperCase() %>
              </div>
            <% } else { %>
              <div class="agency-hero__logo-placeholder">A</div>
            <% } %>
          </div>
          <div class="agency-hero__info">
            <div class="agency-hero__title-wrapper">
              <h1 class="agency-hero__title">
                <% if (currentUser && currentUser.agency_name) { %>
                  <%= currentUser.agency_name %>
                <% } else { %>
                  Partner Agency
                <% } %>
              </h1>
              <span class="agency-hero__badge agency-hero__badge--verified">Verified Partner</span>
            </div>
            <p class="agency-hero__subtitle">
              <% if (currentUser && currentUser.email) { %>
                <%= currentUser.email %>
              <% } else { %>
                Agency Dashboard
              <% } %>
            </p>
            <div class="agency-hero__meta">
              <% if (currentUser && currentUser.agency_location) { %>
                <div class="agency-hero__meta-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  <span><%= currentUser.agency_location %></span>
                </div>
              <% } %>
              <% if (currentUser && currentUser.agency_website) { %>
                <div class="agency-hero__meta-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                    <polyline points="15 3 21 3 21 9"/>
                    <line x1="10" y1="14" x2="21" y2="3"/>
                  </svg>
                  <a href="<%= currentUser.agency_website.startsWith('http') ? currentUser.agency_website : 'https://' + currentUser.agency_website %>" target="_blank" rel="noopener"><%= currentUser.agency_website %></a>
                </div>
              <% } %>
              <div class="agency-hero__meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span>Partner Since <%= currentUser && currentUser.created_at ? new Date(currentUser.created_at).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : '2024' %></span>
              </div>
            </div>
          </div>
        </div>

        <div class="agency-hero__stats">
          <div class="agency-hero__stat">
            <span class="agency-hero__stat-value"><%= safeStats.total %></span>
            <span class="agency-hero__stat-label">Total Applications</span>
          </div>
          <div class="agency-hero__stat">
            <span class="agency-hero__stat-value"><%= safeStats.accepted %></span>
            <span class="agency-hero__stat-label">Accepted Talent</span>
          </div>
          <div class="agency-hero__stat">
            <span class="agency-hero__stat-value"><%= safeStats.pending %></span>
            <span class="agency-hero__stat-label">Pending Review</span>
          </div>
          <div class="agency-hero__stat">
            <span class="agency-hero__stat-value">$<%= safeCommissionsTotal %></span>
            <span class="agency-hero__stat-label">Total Commissions</span>
          </div>
        </div>
      </div>

      <div class="agency-hero__actions">
        <button class="agency-hero__action agency-hero__action--primary" id="export-data-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <span>Export Data</span>
        </button>
        <button class="agency-hero__action agency-hero__action--secondary" id="settings-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/>
          </svg>
          <span>Settings</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Agency Information Panel -->
  <section class="agency-info-panel">
    <div class="agency-info-panel__content">
      <div class="agency-info-panel__header">
        <h2 class="agency-info-panel__title">Agency Overview</h2>
        <p class="agency-info-panel__subtitle">Your partnership dashboard at a glance</p>
      </div>
      <div class="agency-info-panel__grid">
        <div class="agency-info-panel__card">
          <div class="agency-info-panel__icon">üìä</div>
          <div class="agency-info-panel__card-content">
            <h3 class="agency-info-panel__card-title">Application Activity</h3>
            <p class="agency-info-panel__card-text">
              <%= safeStats.newToday %> new applications today, <%= safeStats.newThisWeek %> this week
            </p>
          </div>
        </div>
        <div class="agency-info-panel__card">
          <div class="agency-info-panel__icon">‚≠ê</div>
          <div class="agency-info-panel__card-content">
            <h3 class="agency-info-panel__card-title">Accepted Talent</h3>
            <p class="agency-info-panel__card-text">
              <%= safeStats.accepted %> talent profiles in your roster
            </p>
          </div>
        </div>
        <div class="agency-info-panel__card">
          <div class="agency-info-panel__icon">üíº</div>
          <div class="agency-info-panel__card-content">
            <h3 class="agency-info-panel__card-title">Partnership Status</h3>
            <p class="agency-info-panel__card-text">
              Verified partner agency with full access to talent applications
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Dashboard Header -->
  <section class="agency-dashboard__header" id="applications">
    <div class="agency-dashboard__header-content">
      <div class="agency-dashboard__header-main">
        <span class="agency-dashboard__eyebrow">Talent Management</span>
        <h1 class="agency-dashboard__title">Applications</h1>
        <p class="agency-dashboard__subtitle">Review and manage incoming talent applications with AI-powered insights</p>
      </div>
      
      <!-- View Mode Switcher -->
      <div class="agency-dashboard__view-switcher">
        <button class="agency-dashboard__view-btn agency-dashboard__view-btn--active" data-view="pipeline" title="Pipeline View">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7" rx="1"/>
            <rect x="14" y="3" width="7" height="7" rx="1"/>
            <rect x="3" y="14" width="7" height="7" rx="1"/>
            <rect x="14" y="14" width="7" height="7" rx="1"/>
          </svg>
          <span>Pipeline</span>
        </button>
        <button class="agency-dashboard__view-btn" data-view="gallery" title="Gallery View">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M3 9h18M9 3v18"/>
          </svg>
          <span>Gallery</span>
        </button>
        <button class="agency-dashboard__view-btn" data-view="list" title="List View">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="8" y1="6" x2="21" y2="6"/>
            <line x1="8" y1="12" x2="21" y2="12"/>
            <line x1="8" y1="18" x2="21" y2="18"/>
            <line x1="3" y1="6" x2="3.01" y2="6"/>
            <line x1="3" y1="12" x2="3.01" y2="12"/>
            <line x1="3" y1="18" x2="3.01" y2="18"/>
          </svg>
          <span>List</span>
        </button>
        <button class="agency-dashboard__view-btn" data-view="table" title="Table View">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0H5a2 2 0 0 1-2-2V9m6 12h10a2 2 0 0 0 2-2V9M9 3h6"/>
          </svg>
          <span>Table</span>
        </button>
      </div>
    </div>

    <!-- Editorial Dashboard Stats -->
    <div class="agency-dashboard__stats">
      <div class="agency-dashboard__stat-card agency-dashboard__stat-card--new-today">
        <div class="agency-dashboard__stat-icon">üì•</div>
        <div class="agency-dashboard__stat-content">
          <div class="agency-dashboard__stat-value"><%= safeStats.newToday %></div>
          <div class="agency-dashboard__stat-label">New Applications Today</div>
        </div>
      </div>
      <div class="agency-dashboard__stat-card agency-dashboard__stat-card--highlight">
        <div class="agency-dashboard__stat-icon">‚è≥</div>
        <div class="agency-dashboard__stat-content">
          <div class="agency-dashboard__stat-value"><%= safeStats.pending %></div>
          <div class="agency-dashboard__stat-label">Awaiting Review</div>
        </div>
      </div>
      <div class="agency-dashboard__stat-card">
        <div class="agency-dashboard__stat-icon">‚úÖ</div>
        <div class="agency-dashboard__stat-content">
          <div class="agency-dashboard__stat-value"><%= safeStats.accepted %></div>
          <div class="agency-dashboard__stat-label">Accepted</div>
        </div>
      </div>
      <div class="agency-dashboard__stat-card">
        <div class="agency-dashboard__stat-icon">üí∞</div>
        <div class="agency-dashboard__stat-content">
          <div class="agency-dashboard__stat-value">$<%= safeCommissionsTotal %></div>
          <div class="agency-dashboard__stat-label">Total Commissions</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Intelligent Filtering & Search -->
  <section class="agency-dashboard__filters">
    <div class="agency-dashboard__filters-main">
      <!-- Search Bar -->
      <div class="agency-dashboard__search">
        <svg class="agency-dashboard__search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input 
          type="search" 
          class="agency-dashboard__search-input" 
          id="agency-search"
          placeholder="Search by name, city, or describe what you're looking for..."
          value="<%= safeFilters.search || '' %>"
          autocomplete="off">
        <button class="agency-dashboard__search-clear" id="clear-search" style="display: none;">√ó</button>
          </div>

      <!-- Filter Chips -->
      <div class="agency-dashboard__filter-chips" id="filter-chips">
        <% if (safeFilters.city) { %>
          <span class="agency-dashboard__filter-chip" data-filter="city" data-value="<%= safeFilters.city %>">
            City: <%= safeFilters.city %>
            <button class="agency-dashboard__filter-chip-remove">√ó</button>
          </span>
        <% } %>
        <% if (safeFilters.min_height || safeFilters.max_height) { %>
          <span class="agency-dashboard__filter-chip" data-filter="height">
            Height: <%= safeFilters.min_height || 'Any' %> - <%= safeFilters.max_height || 'Any' %> cm
            <button class="agency-dashboard__filter-chip-remove">√ó</button>
          </span>
        <% } %>
        <% if (safeFilters.status && safeFilters.status !== 'all') { %>
          <span class="agency-dashboard__filter-chip" data-filter="status" data-value="<%= safeFilters.status %>">
            Status: <%= safeFilters.status.charAt(0).toUpperCase() + safeFilters.status.slice(1) %>
            <button class="agency-dashboard__filter-chip-remove">√ó</button>
          </span>
        <% } %>
      </div>
          </div>

    <!-- Advanced Filters Toggle -->
    <div class="agency-dashboard__filters-advanced">
      <button class="agency-dashboard__filters-toggle" id="toggle-advanced-filters">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
        </svg>
        <span>Advanced Filters</span>
      </button>
      
      <div class="agency-dashboard__filters-panel" id="advanced-filters-panel" style="display: none;">
        <form method="get" action="/dashboard/agency" class="agency-dashboard__filters-form" id="filters-form">
          <div class="agency-dashboard__filters-grid">
          <div class="form-field">
              <label for="filter-city">City</label>
              <input id="filter-city" name="city" type="text" placeholder="Any city" value="<%= safeFilters.city || '' %>">
          </div>
          <div class="form-field">
              <label for="filter-min-height">Min Height (cm)</label>
              <input id="filter-min-height" name="min_height" type="number" min="120" max="220" placeholder="160" value="<%= safeFilters.min_height || '' %>">
          </div>
          <div class="form-field">
              <label for="filter-max-height">Max Height (cm)</label>
              <input id="filter-max-height" name="max_height" type="number" min="120" max="220" placeholder="190" value="<%= safeFilters.max_height || '' %>">
          </div>
          <div class="form-field">
              <label for="filter-status">Status</label>
              <select id="filter-status" name="status">
                <option value="all" <%= safeFilters.status === 'all' || !safeFilters.status ? 'selected' : '' %>>All Applications</option>
                <option value="pending" <%= safeFilters.status === 'pending' ? 'selected' : '' %>>Pending</option>
                <option value="accepted" <%= safeFilters.status === 'accepted' ? 'selected' : '' %>>Accepted</option>
                <option value="archived" <%= safeFilters.status === 'archived' ? 'selected' : '' %>>Archived</option>
                <option value="declined" <%= safeFilters.status === 'declined' ? 'selected' : '' %>>Declined</option>
            </select>
          </div>
          <div class="form-field">
              <label for="filter-sort">Sort By</label>
              <select id="filter-sort" name="sort">
                <option value="az" <%= safeFilters.sort === 'az' ? 'selected' : '' %>>A‚ÄìZ (Last name)</option>
                <option value="city" <%= safeFilters.sort === 'city' ? 'selected' : '' %>>City</option>
                <option value="newest" <%= safeFilters.sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                <option value="oldest" <%= safeFilters.sort === 'oldest' ? 'selected' : '' %>>Oldest First</option>
            </select>
          </div>
        </div>
          <div class="agency-dashboard__filters-actions">
          <button type="submit" class="button-primary">Apply Filters</button>
          <a href="/dashboard/agency" class="button-secondary">Clear All</a>
        </div>
      </form>
      </div>
    </div>

    <!-- Batch Actions Bar (hidden by default) -->
    <div class="agency-dashboard__batch-actions" id="batch-actions" style="display: none;">
      <div class="agency-dashboard__batch-info">
        <span id="batch-count">0</span> selected
      </div>
      <div class="agency-dashboard__batch-buttons">
        <button class="agency-dashboard__batch-btn" data-action="accept" id="batch-accept">Accept Selected</button>
        <button class="agency-dashboard__batch-btn" data-action="decline" id="batch-decline">Decline Selected</button>
        <button class="agency-dashboard__batch-btn" data-action="archive" id="batch-archive">Archive Selected</button>
        <button class="agency-dashboard__batch-btn agency-dashboard__batch-btn--cancel" id="batch-cancel">Cancel</button>
      </div>
    </div>
  </section>

  <!-- Main Content Area - View Modes -->
  <section class="agency-dashboard__content">
    
    <!-- Pipeline View (Kanban Board) - Default -->
    <div class="agency-dashboard__view agency-dashboard__view--pipeline" id="view-pipeline">
      <div class="agency-dashboard__kanban">
        
        <!-- New Applications Column -->
        <div class="agency-dashboard__kanban-column" data-status="pending">
          <div class="agency-dashboard__kanban-header">
            <h3 class="agency-dashboard__kanban-title">New Applications</h3>
            <span class="agency-dashboard__kanban-count"><%= profilesByStatus.pending.length %></span>
      </div>
          <div class="agency-dashboard__kanban-cards" data-column="pending">
            <% profilesByStatus.pending.forEach((profile, index) => { 
              const appStatus = profile.application_status || 'pending';
              const aiScore = Math.floor(Math.random() * 30) + 70;
              const aiTags = [];
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('editorial')) {
                aiTags.push({ label: 'Editorial Potential', color: 'purple' });
              }
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('commercial')) {
                aiTags.push({ label: 'Commercial Ready', color: 'blue' });
              }
              if (profile.height_cm && profile.height_cm >= 175) {
                aiTags.push({ label: 'Runway Fit', color: 'green' });
              }
            %>
              <%- include('partials/application-card', { profile, index, currentUser, appStatus, aiScore, aiTags }) %>
            <% }); %>
            <% if (profilesByStatus.pending.length === 0) { %>
              <div class="agency-dashboard__empty-column">
                <p>No new applications</p>
                    </div>
                    <% } %>
          </div>
        </div>

        <!-- Under Review Column -->
        <div class="agency-dashboard__kanban-column" data-status="under-review">
          <div class="agency-dashboard__kanban-header">
            <h3 class="agency-dashboard__kanban-title">Under Review</h3>
            <span class="agency-dashboard__kanban-count"><%= profilesByStatus['under-review'].length %></span>
          </div>
          <div class="agency-dashboard__kanban-cards" data-column="under-review">
            <% profilesByStatus['under-review'].forEach((profile, index) => { 
              const appStatus = profile.application_status || 'pending';
              const aiScore = Math.floor(Math.random() * 30) + 70;
              const aiTags = [];
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('editorial')) {
                aiTags.push({ label: 'Editorial Potential', color: 'purple' });
              }
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('commercial')) {
                aiTags.push({ label: 'Commercial Ready', color: 'blue' });
              }
              if (profile.height_cm && profile.height_cm >= 175) {
                aiTags.push({ label: 'Runway Fit', color: 'green' });
              }
            %>
              <%- include('partials/application-card', { profile, index, currentUser, appStatus, aiScore, aiTags }) %>
            <% }); %>
            <% if (profilesByStatus['under-review'].length === 0) { %>
              <div class="agency-dashboard__empty-column">
                <p>No applications under review</p>
              </div>
                                      <% } %>
                      </div>
              </div>

        <!-- Accepted Column -->
        <div class="agency-dashboard__kanban-column" data-status="accepted">
          <div class="agency-dashboard__kanban-header">
            <h3 class="agency-dashboard__kanban-title">Accepted</h3>
            <span class="agency-dashboard__kanban-count"><%= profilesByStatus.accepted.length %></span>
          </div>
          <div class="agency-dashboard__kanban-cards" data-column="accepted">
            <% profilesByStatus.accepted.forEach((profile, index) => { 
              const appStatus = profile.application_status || 'pending';
              const aiScore = Math.floor(Math.random() * 30) + 70;
              const aiTags = [];
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('editorial')) {
                aiTags.push({ label: 'Editorial Potential', color: 'purple' });
              }
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('commercial')) {
                aiTags.push({ label: 'Commercial Ready', color: 'blue' });
              }
              if (profile.height_cm && profile.height_cm >= 175) {
                aiTags.push({ label: 'Runway Fit', color: 'green' });
              }
            %>
              <%- include('partials/application-card', { profile, index, currentUser, appStatus, aiScore, aiTags }) %>
            <% }); %>
            <% if (profilesByStatus.accepted.length === 0) { %>
              <div class="agency-dashboard__empty-column">
                <p>No accepted applications</p>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Archived Column -->
        <div class="agency-dashboard__kanban-column" data-status="archived">
          <div class="agency-dashboard__kanban-header">
            <h3 class="agency-dashboard__kanban-title">Archived</h3>
            <span class="agency-dashboard__kanban-count"><%= profilesByStatus.archived.length %></span>
          </div>
          <div class="agency-dashboard__kanban-cards" data-column="archived">
            <% profilesByStatus.archived.forEach((profile, index) => { 
              const appStatus = profile.application_status || 'pending';
              const aiScore = Math.floor(Math.random() * 30) + 70;
              const aiTags = [];
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('editorial')) {
                aiTags.push({ label: 'Editorial Potential', color: 'purple' });
              }
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('commercial')) {
                aiTags.push({ label: 'Commercial Ready', color: 'blue' });
              }
              if (profile.height_cm && profile.height_cm >= 175) {
                aiTags.push({ label: 'Runway Fit', color: 'green' });
              }
            %>
              <%- include('partials/application-card', { profile, index, currentUser, appStatus, aiScore, aiTags }) %>
            <% }); %>
            <% if (profilesByStatus.archived.length === 0) { %>
              <div class="agency-dashboard__empty-column">
                <p>No archived applications</p>
              </div>
            <% } %>
          </div>
        </div>

      </div>
    </div>

    <!-- Gallery View -->
    <div class="agency-dashboard__view agency-dashboard__view--gallery" id="view-gallery" style="display: none;">
      <div class="agency-dashboard__gallery-grid">
        <% safeProfiles.forEach((profile, index) => { %>
          <div class="agency-dashboard__gallery-card" data-profile-id="<%= profile.id %>">
            <div class="agency-dashboard__gallery-image">
              <% if (profile.hero_image_path || (profile.images && profile.images.length > 0)) { %>
                <img 
                  src="<%= normalizeImagePath(profile.hero_image_path || profile.images[0].path) %>" 
                  alt="<%= profile.first_name %> <%= profile.last_name %>"
                  loading="lazy">
              <% } else { %>
                <div class="agency-dashboard__gallery-placeholder">
                  <%= profile.first_name.charAt(0) %><%= profile.last_name.charAt(0) %>
                </div>
              <% } %>
              <div class="agency-dashboard__gallery-overlay">
                <div class="agency-dashboard__gallery-actions">
                  <button class="agency-dashboard__gallery-preview" data-profile-id="<%= profile.id %>">Preview</button>
                </div>
              </div>
            </div>
            <div class="agency-dashboard__gallery-info">
              <h4 class="agency-dashboard__gallery-name"><%= profile.first_name %> <%= profile.last_name %></h4>
              <p class="agency-dashboard__gallery-location"><%= profile.city || 'Location TBD' %></p>
            </div>
          </div>
        <% }); %>
        <% if (safeProfiles.length === 0) { %>
          <div class="agency-dashboard__empty-state">
            <p>No applications found</p>
          </div>
        <% } %>
      </div>
    </div>

    <!-- List View -->
    <div class="agency-dashboard__view agency-dashboard__view--list" id="view-list" style="display: none;">
      <div class="agency-dashboard__list">
        <% safeProfiles.forEach((profile, index) => { %>
          <div class="agency-dashboard__list-item" data-profile-id="<%= profile.id %>">
            <div class="agency-dashboard__list-checkbox">
              <input type="checkbox" class="agency-dashboard__select-checkbox" data-profile-id="<%= profile.id %>" id="select-<%= profile.id %>">
            </div>
            <div class="agency-dashboard__list-image">
              <% if (profile.hero_image_path || (profile.images && profile.images.length > 0)) { %>
                <img 
                  src="<%= normalizeImagePath(profile.hero_image_path || profile.images[0].path) %>" 
                  alt="<%= profile.first_name %> <%= profile.last_name %>"
                  loading="lazy">
              <% } else { %>
                <div class="agency-dashboard__list-placeholder">
                  <%= profile.first_name.charAt(0) %><%= profile.last_name.charAt(0) %>
                </div>
              <% } %>
            </div>
            <div class="agency-dashboard__list-content">
              <h4 class="agency-dashboard__list-name"><%= profile.first_name %> <%= profile.last_name %></h4>
              <p class="agency-dashboard__list-meta">
                  <%= profile.city || 'Location TBD' %>
                    <% if (profile.height_cm) { %> ‚Ä¢ <%= profile.height_cm %> cm<% } %>
                <% if (profile.measurements) { %> ‚Ä¢ <%= profile.measurements %><% } %>
                </p>
                <% if (profile.bio_curated) { %>
                <p class="agency-dashboard__list-bio"><%= profile.bio_curated.length > 150 ? profile.bio_curated.substring(0, 150) + '...' : profile.bio_curated %></p>
                  <% } %>
            </div>
            <div class="agency-dashboard__list-actions">
              <button class="agency-dashboard__list-preview" data-profile-id="<%= profile.id %>">Preview</button>
              <div class="agency-dashboard__list-quick-actions">
                <% const appStatus = profile.application_status || 'pending'; %>
                <% if (appStatus !== 'accepted') { %>
                  <form method="post" action="/dashboard/agency/application/accept" class="agency-dashboard__quick-form">
                            <input type="hidden" name="profile_id" value="<%= profile.id %>">
                    <button type="submit" class="agency-dashboard__quick-btn agency-dashboard__quick-btn--accept">Accept</button>
                          </form>
                          <% } %>
                <% if (appStatus !== 'declined') { %>
                  <form method="post" action="/dashboard/agency/application/decline" class="agency-dashboard__quick-form">
                                <input type="hidden" name="profile_id" value="<%= profile.id %>">
                    <button type="submit" class="agency-dashboard__quick-btn agency-dashboard__quick-btn--decline">Decline</button>
                        </form>
                        <% } %>
                    </div>
              </div>
          </div>
            <% }); %>
        <% if (safeProfiles.length === 0) { %>
          <div class="agency-dashboard__empty-state">
            <p>No applications found</p>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Table View -->
    <div class="agency-dashboard__view agency-dashboard__view--table" id="view-table" style="display: none;">
      <div class="agency-dashboard__table-wrapper">
        <table class="agency-dashboard__table">
              <thead>
                <tr>
              <th>
                <input type="checkbox" id="select-all" class="agency-dashboard__select-all">
              </th>
              <th>Name</th>
              <th>Location</th>
              <th>Height</th>
              <th>Measurements</th>
              <th>Status</th>
              <th>Actions</th>
                </tr>
              </thead>
              <tbody>
            <% safeProfiles.forEach((profile) => { %>
              <tr class="agency-dashboard__table-row" data-profile-id="<%= profile.id %>">
                <td>
                  <input type="checkbox" class="agency-dashboard__select-checkbox" data-profile-id="<%= profile.id %>">
                    </td>
                <td>
                  <div class="agency-dashboard__table-name">
                    <% if (profile.hero_image_path || (profile.images && profile.images.length > 0)) { %>
                      <img 
                        src="<%= normalizeImagePath(profile.hero_image_path || profile.images[0].path) %>" 
                        alt="<%= profile.first_name %> <%= profile.last_name %>"
                        class="agency-dashboard__table-avatar"
                        loading="lazy">
                    <% } %>
                    <span><%= profile.first_name %> <%= profile.last_name %></span>
                  </div>
                    </td>
                <td><%= profile.city || '‚Äî' %></td>
                <td><%= profile.height_cm ? profile.height_cm + ' cm' : '‚Äî' %></td>
                <td><%= profile.measurements || '‚Äî' %></td>
                <td>
                  <% const appStatus = profile.application_status || 'pending'; %>
                  <span class="agency-dashboard__status-badge agency-dashboard__status-badge--<%= appStatus %>">
                    <%= appStatus.charAt(0).toUpperCase() + appStatus.slice(1) %>
                  </span>
                    </td>
                    <td>
                  <div class="agency-dashboard__table-actions">
                    <button class="agency-dashboard__table-preview" data-profile-id="<%= profile.id %>">Preview</button>
                    <% if (appStatus !== 'accepted') { %>
                      <form method="post" action="/dashboard/agency/application/accept" class="agency-dashboard__quick-form">
                        <input type="hidden" name="profile_id" value="<%= profile.id %>">
                        <button type="submit" class="agency-dashboard__table-btn agency-dashboard__table-btn--accept">Accept</button>
                      </form>
                    <% } %>
                    <% if (appStatus !== 'declined') { %>
                      <form method="post" action="/dashboard/agency/application/decline" class="agency-dashboard__quick-form">
                        <input type="hidden" name="profile_id" value="<%= profile.id %>">
                        <button type="submit" class="agency-dashboard__table-btn agency-dashboard__table-btn--decline">Decline</button>
                      </form>
                    <% } %>
                  </div>
                    </td>
                  </tr>
                  <% }); %>
            <% if (safeProfiles.length === 0) { %>
              <tr>
                <td colspan="7" class="agency-dashboard__empty-state">
                  <p>No applications found</p>
                </td>
              </tr>
            <% } %>
              </tbody>
            </table>
          </div>
        </div>

  </section>
      </div>




<script>
  // Pass data to JavaScript
  window.AGENCY_DASHBOARD_DATA = {
    profiles: <%- JSON.stringify(safeProfiles.map(p => ({
      id: p.id,
      slug: p.slug,
      first_name: p.first_name,
      last_name: p.last_name,
      city: p.city,
      height_cm: p.height_cm,
      measurements: p.measurements,
      bio_curated: p.bio_curated,
      hero_image_path: p.hero_image_path,
      application_status: p.application_status || 'pending',
      application_id: p.application_id,
      images: (p.images || []).map(img => ({ id: img.id, path: img.path, label: img.label }))
    }))) %>,
    stats: <%- JSON.stringify(safeStats) %>,
    filters: <%- JSON.stringify(safeFilters) %>
  };
</script>
<script src="/scripts/agency-dashboard.js?v=<%= Date.now() %>" defer></script>
