<% 
  const safeProfiles = (typeof profiles !== 'undefined' && profiles) ? profiles : [];
  const safeFilters = (typeof filters !== 'undefined') ? filters : {};
  const safeCommissionsTotal = (typeof commissionsTotal !== 'undefined') ? commissionsTotal : '0.00';
  const safeLatestCommissions = (typeof latestCommissions !== 'undefined' && latestCommissions) ? latestCommissions : [];
  const currentUser = (typeof user !== 'undefined' && user) ? user : {};
  const safeBoards = (typeof boards !== 'undefined' && boards) ? boards : [];
  const safeStats = (typeof stats !== 'undefined') ? stats : {
    total: 0,
    pending: 0,
    accepted: 0,
    declined: 0,
    archived: 0,
    newToday: 0,
    newThisWeek: 0
  };

  // Brand color with fallback
  const brandColor = (currentUser && currentUser.agency_brand_color) ? currentUser.agency_brand_color : '#C9A55A';
  
  // Helper to convert hex to RGB
  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : { r: 201, g: 165, b: 90 }; // Default gold
  }
  
  const brandRgb = hexToRgb(brandColor);
  const brandRgbDark = {
    r: Math.max(0, Math.floor(brandRgb.r * 0.8)),
    g: Math.max(0, Math.floor(brandRgb.g * 0.8)),
    b: Math.max(0, Math.floor(brandRgb.b * 0.8))
  };

  // Helper to normalize image paths
  function normalizeImagePath(path) {
    if (!path) return '';
    if (path.startsWith('http://') || path.startsWith('https://')) return path;
    if (path.startsWith('/')) return path;
    return '/' + path;
  }

  // Group profiles by application status for Kanban board
  const profilesByStatus = {
    new: [],
    pending: [],
    'under-review': [],
    accepted: [],
    declined: [],
    archived: []
  };

  safeProfiles.forEach(profile => {
    const appStatus = profile.application_status || 'pending';
    const viewedAt = profile.viewed_at || null;
    
    // New: no viewed_at and status='pending' or null
    if ((!appStatus || appStatus === 'pending') && !viewedAt) {
      profilesByStatus.new.push(profile);
    } else if (appStatus === 'accepted') {
      profilesByStatus.accepted.push(profile);
    } else if (appStatus === 'declined') {
      profilesByStatus.declined.push(profile);
    } else if (appStatus === 'archived') {
      profilesByStatus.archived.push(profile);
    } else if ((!appStatus || appStatus === 'pending') && viewedAt) {
      // Under Review: viewed_at is set but not accepted/declined
      profilesByStatus['under-review'].push(profile);
    } else {
      // Fallback to pending
      profilesByStatus.pending.push(profile);
    }
  });
%>

<!-- Agency Dashboard - Premium AI Studio -->
<style>
  :root {
    --agency-brand-color: <%= brandColor %>;
    --agency-brand-color-light: rgba(<%= brandRgb.r %>, <%= brandRgb.g %>, <%= brandRgb.b %>, 0.1);
    --agency-brand-color-dark: rgb(<%= brandRgbDark.r %>, <%= brandRgbDark.g %>, <%= brandRgbDark.b %>);
  }
</style>
<div class="agency-dashboard" id="agency-dashboard">

  <!-- Mobile Header -->
  <div class="agency-mobile-header">
    <button class="agency-mobile-header__menu-btn" id="mobile-menu-trigger" aria-label="Open menu">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    <span class="agency-mobile-header__title">Pholio.</span>
  </div>

  <%- include('../partials/agency/sidebar', { brandColor, currentUser, safeStats, page }) %>

  <!-- Main Content Area -->
  <main class="agency-dashboard__main">

    <% if (typeof page === 'undefined' || page === 'overview') { %>
      <!-- Overview Page: Only greeting, stats, quick actions, recent applicants -->
      <%- include('../partials/agency/overview', { currentUser, safeStats, safeBoards, profiles }) %>
    <% } else if (page === 'applicants') { %>
      <!-- My Applicants Page -->
      <%- include('../partials/agency/inbox-header', { safeStats, pipelineCounts, filters }) %>
      <%- include('../partials/agency/applicants-filter-drawer', { safeBoards }) %>
      <div class="applicants-views-container">
        <%- include('../partials/agency/kanban', { profilesByStatus, currentUser }) %>
        <%- include('../partials/agency/gallery', { safeProfiles, currentUser }) %>
        <%- include('../partials/agency/list', { safeProfiles, currentUser }) %>
        <%- include('../partials/agency/table', { safeProfiles, currentUser }) %>
      </div>
    <% } else if (page === 'discover') { %>
      <!-- Discover Page -->
      <%- include('../partials/agency/discover-header') %>
      <%- include('../partials/agency/discover-trending', { safeProfiles, currentUser }) %>
      <%- include('../partials/agency/discover-filter-chips', { safeFilters }) %>
      <div class="discover-main-content">
        <div class="discover-views-container">
          <%- include('../partials/agency/scout', { safeProfiles, currentUser }) %>
          <%- include('../partials/agency/scout-list', { safeProfiles, currentUser }) %>
          <% if (safeProfiles.length === 0) { %>
            <div class="agency-dashboard__empty-state discover-view discover-view--active">
              <div class="agency-dashboard__empty-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="m21 21-4.35-4.35"/>
                </svg>
              </div>
              <h3 class="agency-dashboard__empty-title">No talent found</h3>
              <p class="agency-dashboard__empty-text">Try adjusting your filters to see more results.</p>
              <button class="agency-dashboard__empty-action" id="scout-reset-filters-btn">Clear Filters</button>
            </div>
          <% } %>
        </div>
      </div>
    <% } else if (page === 'boards') { %>
      <!-- Boards Page -->
      <%- include('../partials/agency/boards-header', { safeBoards, currentUser }) %>
      <%- include('../partials/agency/boards-page', { safeBoards, currentUser }) %>
    <% } else if (page === 'analytics') { %>
      <!-- Analytics Page -->
      <%- include('../partials/agency/analytics-header') %>
      <%- include('../partials/agency/analytics', { safeStats }) %>
    <% } %>

  </main>

  <%- include('../partials/agency/command-palette') %>
  <%- include('../partials/agency/application-detail-drawer') %>
  <%- include('../partials/agency/board-editor-modal') %>
  <%- include('../partials/agency/talent-preview-modal') %>

</div>

<!-- Pass data to client-side script -->
<script>
  window.AGENCY_DASHBOARD_DATA = {
    profiles: <%- JSON.stringify(safeProfiles) %>,
    stats: <%- JSON.stringify(safeStats) %>,
    boards: <%- JSON.stringify(safeBoards) %>,
    currentUser: <%- JSON.stringify(currentUser) %>
  };
</script>

<script src="/scripts/toast.js"></script>
<!-- Modular Dashboard Scripts -->
<script src="/scripts/dashboard/core.js"></script>
<script src="/scripts/dashboard/overview.js"></script>
<script src="/scripts/dashboard/applicants.js"></script>
<script src="/scripts/dashboard/discover.js"></script>
<script src="/scripts/dashboard/boards.js"></script>
<script src="/scripts/dashboard/analytics.js"></script>
<!-- Legacy script removed -->
