<% 
  const safeProfiles = (typeof profiles !== 'undefined' && profiles) ? profiles : [];
  const safeFilters = (typeof filters !== 'undefined') ? filters : {};
  const safeCommissionsTotal = (typeof commissionsTotal !== 'undefined') ? commissionsTotal : '0.00';
  const safeLatestCommissions = (typeof latestCommissions !== 'undefined' && latestCommissions) ? latestCommissions : [];
  const currentUser = (typeof user !== 'undefined' && user) ? user : {};
  const safeBoards = (typeof boards !== 'undefined' && boards) ? boards : [];
  const safeStats = (typeof stats !== 'undefined') ? stats : {
    total: 0,
    pending: 0,
    accepted: 0,
    declined: 0,
    archived: 0,
    newToday: 0,
    newThisWeek: 0
  };

  // Brand color with fallback
  const brandColor = (currentUser && currentUser.agency_brand_color) ? currentUser.agency_brand_color : '#C9A55A';
  
  // Helper to convert hex to RGB
  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : { r: 201, g: 165, b: 90 }; // Default gold
  }
  
  const brandRgb = hexToRgb(brandColor);
  const brandRgbDark = {
    r: Math.max(0, Math.floor(brandRgb.r * 0.8)),
    g: Math.max(0, Math.floor(brandRgb.g * 0.8)),
    b: Math.max(0, Math.floor(brandRgb.b * 0.8))
  };

  // Helper to normalize image paths
  function normalizeImagePath(path) {
    if (!path) return '';
    if (path.startsWith('http://') || path.startsWith('https://')) return path;
    if (path.startsWith('/')) return path;
    return '/' + path;
  }

  // Group profiles by application status for Kanban board
  const profilesByStatus = {
    pending: [],
    'under-review': [],
    accepted: [],
    archived: []
  };

  safeProfiles.forEach(profile => {
    const appStatus = profile.application_status || 'pending';
    if (appStatus === 'pending' || !appStatus) {
      profilesByStatus.pending.push(profile);
    } else if (appStatus === 'accepted') {
      profilesByStatus.accepted.push(profile);
    } else if (appStatus === 'archived') {
      profilesByStatus.archived.push(profile);
    } else {
      profilesByStatus['under-review'].push(profile);
    }
  });
%>

<!-- Agency Dashboard - Premium AI Studio -->
<style>
  :root {
    --agency-brand-color: <%= brandColor %>;
    --agency-brand-color-light: rgba(<%= brandRgb.r %>, <%= brandRgb.g %>, <%= brandRgb.b %>, 0.1);
    --agency-brand-color-dark: rgb(<%= brandRgbDark.r %>, <%= brandRgbDark.g %>, <%= brandRgbDark.b %>);
  }
</style>
<div class="agency-dashboard" id="agency-dashboard">

  <%- include('../partials/agency/sidebar', { brandColor, currentUser, safeStats, page }) %>

  <!-- Main Content Area -->
  <main class="agency-dashboard__main">

    <% if (typeof page === 'undefined' || page === 'overview') { %>
      <!-- Overview Page: Only greeting, stats, quick actions, recent applicants -->
      <%- include('../partials/agency/overview', { currentUser, safeStats, safeBoards, profiles }) %>
    <% } else if (page === 'applicants') { %>
      <!-- My Applicants Page -->
      <%- include('../partials/agency/inbox-header', { safeStats }) %>
      <%- include('../partials/agency/header', { safeStats, view: 'applicants' }) %>
      <%- include('../partials/agency/filters', { safeBoards, safeFilters, page }) %>
      <%- include('../partials/agency/kanban', { profilesByStatus, currentUser }) %>
      <%- include('../partials/agency/gallery', { safeProfiles, currentUser }) %>
      <%- include('../partials/agency/list', { safeProfiles, currentUser }) %>
      <%- include('../partials/agency/table', { safeProfiles, currentUser }) %>
    <% } else if (page === 'discover') { %>
      <!-- Discover Page -->
      <%- include('../partials/agency/discover-header') %>
      <div class="agency-dashboard__scout-container">
        <%- include('../partials/agency/scout-filters', { safeFilters }) %>
        <%- include('../partials/agency/scout', { safeProfiles, currentUser }) %>
      </div>
    <% } else if (page === 'boards') { %>
      <!-- Boards Page -->
      <%- include('../partials/agency/boards-header', { safeBoards, currentUser }) %>
      <%- include('../partials/agency/boards-page', { safeBoards, currentUser }) %>
    <% } else if (page === 'analytics') { %>
      <!-- Analytics Page -->
      <%- include('../partials/agency/analytics-header') %>
      <%- include('../partials/agency/analytics', { safeStats }) %>
    <% } %>

  </main>

  <%- include('../partials/agency/command-palette') %>
  <%- include('../partials/agency/application-detail-drawer') %>
  <%- include('../partials/agency/board-editor-modal') %>

</div>

<!-- Pass data to client-side script -->
<script>
  window.AGENCY_DASHBOARD_DATA = {
    profiles: <%- JSON.stringify(safeProfiles) %>,
    stats: <%- JSON.stringify(safeStats) %>,
    boards: <%- JSON.stringify(safeBoards) %>,
    currentUser: <%- JSON.stringify(currentUser) %>
  };
</script>

<script src="/scripts/agency-dashboard.js"></script>
