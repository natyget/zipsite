<% 
  const safeProfiles = (typeof profiles !== 'undefined' && profiles) ? profiles : [];
  const safeFilters = (typeof filters !== 'undefined') ? filters : {};
  const safeCommissionsTotal = (typeof commissionsTotal !== 'undefined') ? commissionsTotal : '0.00';
  const safeLatestCommissions = (typeof latestCommissions !== 'undefined' && latestCommissions) ? latestCommissions : [];
  const currentUser = (typeof user !== 'undefined' && user) ? user : {};
  const safeBoards = (typeof boards !== 'undefined' && boards) ? boards : [];
  const safeStats = (typeof stats !== 'undefined') ? stats : {
    total: 0,
    pending: 0,
    accepted: 0,
    declined: 0,
    archived: 0,
    newToday: 0,
    newThisWeek: 0
  };

  // Brand color with fallback
  const brandColor = (currentUser && currentUser.agency_brand_color) ? currentUser.agency_brand_color : '#C9A55A';
  
  // Helper to convert hex to RGB
  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : { r: 201, g: 165, b: 90 }; // Default gold
  }
  
  const brandRgb = hexToRgb(brandColor);
  const brandRgbDark = {
    r: Math.max(0, Math.floor(brandRgb.r * 0.8)),
    g: Math.max(0, Math.floor(brandRgb.g * 0.8)),
    b: Math.max(0, Math.floor(brandRgb.b * 0.8))
  };

  // Helper to normalize image paths
  function normalizeImagePath(path) {
    if (!path) return '';
    if (path.startsWith('http://') || path.startsWith('https://')) return path;
    if (path.startsWith('/')) return path;
    return '/' + path;
  }

  // Group profiles by application status for Kanban board
  const profilesByStatus = {
    pending: [],
    'under-review': [],
    accepted: [],
    archived: []
  };

  safeProfiles.forEach(profile => {
    const appStatus = profile.application_status || 'pending';
    if (appStatus === 'pending' || !appStatus) {
      profilesByStatus.pending.push(profile);
    } else if (appStatus === 'accepted') {
      profilesByStatus.accepted.push(profile);
    } else if (appStatus === 'archived') {
      profilesByStatus.archived.push(profile);
    } else {
      profilesByStatus['under-review'].push(profile);
    }
  });
%>

<!-- Agency Dashboard - Premium AI Studio -->
<style>
  :root {
    --agency-brand-color: <%= brandColor %>;
    --agency-brand-color-light: rgba(<%= brandRgb.r %>, <%= brandRgb.g %>, <%= brandRgb.b %>, 0.1);
    --agency-brand-color-dark: rgb(<%= brandRgbDark.r %>, <%= brandRgbDark.g %>, <%= brandRgbDark.b %>);
  }
</style>
<div class="agency-dashboard" id="agency-dashboard">

  <!-- Agency Hero Section -->
  <section class="agency-hero" id="agency-overview">
    <div class="agency-hero__content">
      <div class="agency-hero__main">
        <div class="agency-hero__header">
          <div class="agency-hero__logo">
            <% if (currentUser && currentUser.agency_name) { %>
              <div class="agency-hero__logo-placeholder">
                <%= currentUser.agency_name.charAt(0).toUpperCase() %>
              </div>
            <% } else { %>
              <div class="agency-hero__logo-placeholder">A</div>
            <% } %>
          </div>
          <div class="agency-hero__info">
            <div class="agency-hero__title-wrapper">
              <h1 class="agency-hero__title">
        <% if (currentUser && currentUser.agency_name) { %>
          <%= currentUser.agency_name %>
        <% } else { %>
                  Partner Agency
        <% } %>
              </h1>
              <span class="agency-hero__badge agency-hero__badge--verified">Verified Partner</span>
            </div>
            <p class="agency-hero__subtitle">
              <% if (currentUser && currentUser.email) { %>
                <%= currentUser.email %>
              <% } else { %>
                Agency Dashboard
              <% } %>
            </p>
            <div class="agency-hero__meta">
              <% if (currentUser && currentUser.agency_location) { %>
                <div class="agency-hero__meta-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  <span><%= currentUser.agency_location %></span>
                </div>
              <% } %>
              <% if (currentUser && currentUser.agency_website) { %>
                <div class="agency-hero__meta-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                    <polyline points="15 3 21 3 21 9"/>
                    <line x1="10" y1="14" x2="21" y2="3"/>
                  </svg>
                  <a href="<%= currentUser.agency_website.startsWith('http') ? currentUser.agency_website : 'https://' + currentUser.agency_website %>" target="_blank" rel="noopener"><%= currentUser.agency_website %></a>
                </div>
              <% } %>
              <div class="agency-hero__meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span>Partner Since <%= currentUser && currentUser.created_at ? new Date(currentUser.created_at).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : '2024' %></span>
              </div>
            </div>
          </div>
    </div>

    <div class="agency-hero__stats">
          <div class="agency-hero__stat">
            <span class="agency-hero__stat-value"><%= safeStats.total %></span>
            <span class="agency-hero__stat-label">Total Applications</span>
          </div>
          <div class="agency-hero__stat">
            <span class="agency-hero__stat-value"><%= safeStats.accepted %></span>
            <span class="agency-hero__stat-label">Accepted Talent</span>
          </div>
          <div class="agency-hero__stat">
            <span class="agency-hero__stat-value"><%= safeStats.pending %></span>
            <span class="agency-hero__stat-label">Pending Review</span>
          </div>
        </div>
      </div>

      <div class="agency-hero__actions">
        <button class="agency-hero__action agency-hero__action--primary" id="export-data-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <span>Export Data</span>
        </button>
        <button class="agency-hero__action agency-hero__action--secondary" id="settings-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/>
          </svg>
          <span>Settings</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Agency Information Panel -->
  <section class="agency-info-panel">
    <div class="agency-info-panel__content">
      <div class="agency-info-panel__header">
        <h2 class="agency-info-panel__title">Agency Overview</h2>
        <p class="agency-info-panel__subtitle">Your partnership dashboard at a glance</p>
      </div>
      <div class="agency-info-panel__grid">
        <div class="agency-info-panel__card">
          <div class="agency-info-panel__icon">üìä</div>
          <div class="agency-info-panel__card-content">
            <h3 class="agency-info-panel__card-title">Application Activity</h3>
            <p class="agency-info-panel__card-text">
              <%= safeStats.newToday %> new applications today, <%= safeStats.newThisWeek %> this week
        </p>
      </div>
        </div>
        <div class="agency-info-panel__card">
          <div class="agency-info-panel__icon">‚≠ê</div>
          <div class="agency-info-panel__card-content">
            <h3 class="agency-info-panel__card-title">Accepted Talent</h3>
            <p class="agency-info-panel__card-text">
              <%= safeStats.accepted %> talent profiles in your roster
            </p>
          </div>
        </div>
        <div class="agency-info-panel__card">
          <div class="agency-info-panel__icon">üíº</div>
          <div class="agency-info-panel__card-content">
            <h3 class="agency-info-panel__card-title">Partnership Status</h3>
            <p class="agency-info-panel__card-text">
              Verified partner agency with full access to talent applications
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Agency Profile Management Accordion -->
  <section class="agency-profile-accordion">
    <div class="agency-profile-accordion__container">
      <div class="agency-profile-accordion__item">
        <button class="agency-profile-accordion__header" data-accordion="profile">
          <div class="agency-profile-accordion__header-content">
            <h3 class="agency-profile-accordion__title">Agency Profile</h3>
            <p class="agency-profile-accordion__subtitle">Manage your agency information and branding</p>
          </div>
          <svg class="agency-profile-accordion__chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <div class="agency-profile-accordion__content" data-content="profile">
          <form class="agency-profile-form" id="agency-profile-form">
            <div class="agency-profile-form__grid">
              <div class="agency-profile-form__field">
                <label for="agency-name">Agency Name</label>
                <input 
                  type="text" 
                  id="agency-name" 
                  name="agency_name" 
                  value="<%= currentUser && currentUser.agency_name ? currentUser.agency_name : '' %>"
                  placeholder="True Modeling Agency"
                  class="agency-profile-form__input">
          </div>
              <div class="agency-profile-form__field">
                <label for="agency-location">Location</label>
                <input 
                  type="text" 
                  id="agency-location" 
                  name="agency_location" 
                  value="<%= currentUser && currentUser.agency_location ? currentUser.agency_location : '' %>"
                  placeholder="New York, NY"
                  class="agency-profile-form__input">
          </div>
              <div class="agency-profile-form__field">
                <label for="agency-website">Website</label>
                <input 
                  type="url" 
                  id="agency-website" 
                  name="agency_website" 
                  value="<%= currentUser && currentUser.agency_website ? currentUser.agency_website : '' %>"
                  placeholder="https://www.example.com"
                  class="agency-profile-form__input">
          </div>
              <div class="agency-profile-form__field agency-profile-form__field--full">
                <label for="agency-description">Description</label>
                <textarea 
                  id="agency-description" 
                  name="agency_description" 
                  rows="3"
                  placeholder="Brief description of your agency..."
                  class="agency-profile-form__textarea"><%= currentUser && currentUser.agency_description ? currentUser.agency_description : '' %></textarea>
              </div>
            </div>
            <div class="agency-profile-form__actions">
              <button type="submit" class="agency-profile-form__btn agency-profile-form__btn--primary">
                <span>Save Changes</span>
                <svg class="agency-profile-form__btn-spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
              </button>
            </div>
            <div class="agency-profile-form__message" id="agency-profile-message" role="alert" aria-live="polite"></div>
          </form>
        </div>
          </div>

      <div class="agency-profile-accordion__item">
        <button class="agency-profile-accordion__header" data-accordion="branding">
          <div class="agency-profile-accordion__header-content">
            <h3 class="agency-profile-accordion__title">Branding</h3>
            <p class="agency-profile-accordion__subtitle">Customize your agency logo and brand colors</p>
          </div>
          <svg class="agency-profile-accordion__chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <div class="agency-profile-accordion__content" data-content="branding">
          <form class="agency-profile-form" id="agency-branding-form">
            <div class="agency-profile-form__grid">
              <div class="agency-profile-form__field agency-profile-form__field--full">
                <label for="agency-logo">Agency Logo</label>
                <div class="agency-profile-form__logo-wrapper">
                  <% if (currentUser && currentUser.agency_logo_path) { %>
                    <div class="agency-profile-form__logo-preview">
                      <img src="<%= currentUser.agency_logo_path.startsWith('http') ? currentUser.agency_logo_path : '/' + currentUser.agency_logo_path %>" alt="Agency Logo" id="logo-preview-img">
                      <button type="button" class="agency-profile-form__logo-remove" id="remove-logo-btn">Remove</button>
                    </div>
                  <% } else { %>
                    <div class="agency-profile-form__logo-placeholder" id="logo-placeholder">
                      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                      </svg>
                      <p>No logo uploaded</p>
                    </div>
                  <% } %>
                  <input 
                    type="file" 
                    id="agency-logo" 
                    name="agency_logo" 
                    accept="image/*"
                    class="agency-profile-form__file-input">
                  <label for="agency-logo" class="agency-profile-form__file-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="17 8 12 3 7 8"/>
                      <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload Logo
                  </label>
                </div>
                <p class="agency-profile-form__help">Recommended: 200x200px, PNG or JPG, max 2MB</p>
              </div>
              <div class="agency-profile-form__field">
                <label for="agency-brand-color">Brand Color</label>
                <div class="agency-profile-form__color-wrapper">
                  <input 
                    type="color" 
                    id="agency-brand-color" 
                    name="agency_brand_color" 
                    value="<%= currentUser && currentUser.agency_brand_color ? currentUser.agency_brand_color : '#C9A55A' %>"
                    class="agency-profile-form__color-input">
                  <input 
                    type="text" 
                    value="<%= currentUser && currentUser.agency_brand_color ? currentUser.agency_brand_color : '#C9A55A' %>"
                    class="agency-profile-form__color-text"
                    id="agency-brand-color-text"
                    placeholder="#C9A55A">
                </div>
                <p class="agency-profile-form__help">Used for branding elements throughout the dashboard</p>
              </div>
            </div>
            <div class="agency-profile-form__actions">
              <button type="submit" class="agency-profile-form__btn agency-profile-form__btn--primary">
                <span>Save Branding</span>
                <svg class="agency-profile-form__btn-spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
              </button>
            </div>
            <div class="agency-profile-form__message" id="agency-branding-message" role="alert" aria-live="polite"></div>
          </form>
        </div>
          </div>

      <div class="agency-profile-accordion__item">
        <button class="agency-profile-accordion__header" data-accordion="settings">
          <div class="agency-profile-accordion__header-content">
            <h3 class="agency-profile-accordion__title">Settings</h3>
            <p class="agency-profile-accordion__subtitle">Configure your dashboard preferences</p>
          </div>
          <svg class="agency-profile-accordion__chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <div class="agency-profile-accordion__content" data-content="settings">
          <form class="agency-profile-form" id="agency-settings-form">
            <div class="agency-profile-form__grid">
              <div class="agency-profile-form__field agency-profile-form__field--full">
                <label>Notification Preferences</label>
                <div class="agency-profile-form__checkbox-group">
                  <label class="agency-profile-form__checkbox-label">
                    <input 
                      type="checkbox" 
                      name="notify_new_applications" 
                      value="1"
                      <%= currentUser && currentUser.notify_new_applications !== false ? 'checked' : '' %>
                      class="agency-profile-form__checkbox">
                    <span>Email me when new applications are submitted</span>
                  </label>
                  <label class="agency-profile-form__checkbox-label">
                    <input 
                      type="checkbox" 
                      name="notify_status_changes" 
                      value="1"
                      <%= currentUser && currentUser.notify_status_changes !== false ? 'checked' : '' %>
                      class="agency-profile-form__checkbox">
                    <span>Email me when application status changes</span>
                  </label>
                </div>
              </div>
              <div class="agency-profile-form__field">
                <label for="default-view">Default View</label>
                <select id="default-view" name="default_view" class="agency-profile-form__select">
                  <option value="pipeline" <%= currentUser && currentUser.default_view === 'pipeline' ? 'selected' : '' %>>Pipeline (Kanban)</option>
                  <option value="gallery" <%= currentUser && currentUser.default_view === 'gallery' ? 'selected' : '' %>>Gallery</option>
                  <option value="list" <%= currentUser && currentUser.default_view === 'list' ? 'selected' : '' %>>List</option>
                  <option value="table" <%= currentUser && currentUser.default_view === 'table' ? 'selected' : '' %>>Table</option>
            </select>
          </div>
        </div>
            <div class="agency-profile-form__actions">
              <button type="submit" class="agency-profile-form__btn agency-profile-form__btn--primary">
                <span>Save Settings</span>
                <svg class="agency-profile-form__btn-spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
              </button>
        </div>
            <div class="agency-profile-form__message" id="agency-settings-message" role="alert" aria-live="polite"></div>
      </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Boards / Divisions Accordion -->
  <section class="agency-profile-accordion">
    <div class="agency-profile-accordion__container">
      <div class="agency-profile-accordion__item">
        <button class="agency-profile-accordion__header" data-accordion="boards">
          <div class="agency-profile-accordion__header-content">
            <h3 class="agency-profile-accordion__title">Boards / Divisions</h3>
            <span class="agency-profile-accordion__status">
              <%= safeBoards.length %> <%= safeBoards.length === 1 ? 'board' : 'boards' %>
            </span>
          </div>
          <svg class="agency-profile-accordion__chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <div class="agency-profile-accordion__content" data-content="boards">
          <div class="boards-management">
            <div class="boards-management__header">
              <h4 class="boards-management__title">Manage Your Boards</h4>
              <p class="boards-management__subtitle">Create boards to organize applications by division, type, or requirements</p>
              <button class="boards-management__create-btn" id="create-board-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Create New Board
              </button>
            </div>
            <div class="boards-management__list" id="boards-list">
              <% if (safeBoards.length === 0) { %>
                <div class="boards-management__empty">
                  <p>No boards yet. Create your first board to organize applications by division or requirements.</p>
      </div>
      <% } else { %>
                <% safeBoards.forEach((board) => { %>
                  <div class="boards-management__card" data-board-id="<%= board.id %>">
                    <div class="boards-management__card-header">
                      <div class="boards-management__card-info">
                        <h5 class="boards-management__card-name"><%= board.name %></h5>
                        <% if (board.description) { %>
                          <p class="boards-management__card-description"><%= board.description %></p>
                        <% } %>
                        <div class="boards-management__card-meta">
                          <span class="boards-management__card-status <%= board.is_active ? 'boards-management__card-status--active' : 'boards-management__card-status--inactive' %>">
                            <%= board.is_active ? 'Active' : 'Inactive' %>
                          </span>
                          <span class="boards-management__card-count"><%= board.application_count || 0 %> applications</span>
                    </div>
                      </div>
                      <div class="boards-management__card-actions">
                        <button class="boards-management__card-action" data-action="edit" data-board-id="<%= board.id %>" title="Edit Board" aria-label="Edit Board">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                          </svg>
                        </button>
                        <button class="boards-management__card-action" data-action="duplicate" data-board-id="<%= board.id %>" title="Duplicate Board" aria-label="Duplicate Board">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                          </svg>
                        </button>
                        <button class="boards-management__card-action" data-action="toggle" data-board-id="<%= board.id %>" title="<%= board.is_active ? 'Deactivate' : 'Activate' %> Board" aria-label="<%= board.is_active ? 'Deactivate' : 'Activate' %> Board">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <%= board.is_active ? '<path d="M18 6L6 18M6 6l12 12"/>' : '<path d="M20 6L9 17l-5-5"/>' %>
                          </svg>
                        </button>
                        <button class="boards-management__card-action boards-management__card-action--danger" data-action="delete" data-board-id="<%= board.id %>" title="Delete Board" aria-label="Delete Board">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                <% }); %>
                                      <% } %>
                      </div>
              </div>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Tab Navigation -->
  <section class="agency-dashboard__tabs">
    <div class="agency-dashboard__tabs-container">
      <a 
        href="/dashboard/agency?view=applicants" 
        class="agency-dashboard__tab <%= (typeof view === 'undefined' || view === 'applicants') ? 'agency-dashboard__tab--active' : '' %>"
        data-tab="applicants"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <span>My Applicants</span>
        <% if (safeStats.pending > 0) { %>
          <span class="agency-dashboard__tab-badge"><%= safeStats.pending %></span>
                              <% } %>
      </a>
      <a 
        href="/dashboard/agency?view=scout" 
        class="agency-dashboard__tab <%= (typeof view !== 'undefined' && view === 'scout') ? 'agency-dashboard__tab--active' : '' %>"
        data-tab="scout"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
        <span>Scout Talent</span>
      </a>
    </div>
  </section>

  <!-- Dashboard Header -->
  <section class="agency-dashboard__header" id="applications">
    <div class="agency-dashboard__header-content">
      <div class="agency-dashboard__header-main">
        <% if (typeof view !== 'undefined' && view === 'scout') { %>
          <span class="agency-dashboard__eyebrow">Talent Discovery</span>
          <h1 class="agency-dashboard__title">Scout Talent</h1>
          <p class="agency-dashboard__subtitle">Discover and invite talented models from our global network</p>
        <% } else { %>
          <span class="agency-dashboard__eyebrow">Talent Management</span>
          <h1 class="agency-dashboard__title">My Applicants</h1>
          <p class="agency-dashboard__subtitle">Review and manage incoming talent applications with AI-powered insights</p>
                  <% } %>
      </div>
      
      <!-- View Mode Switcher -->
      <div class="agency-dashboard__view-switcher">
        <button class="agency-dashboard__view-btn agency-dashboard__view-btn--active" data-view="pipeline" title="Pipeline View">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7" rx="1"/>
            <rect x="14" y="3" width="7" height="7" rx="1"/>
            <rect x="3" y="14" width="7" height="7" rx="1"/>
            <rect x="14" y="14" width="7" height="7" rx="1"/>
          </svg>
          <span>Pipeline</span>
                            </button>
        <button class="agency-dashboard__view-btn" data-view="gallery" title="Gallery View">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M3 9h18M9 3v18"/>
          </svg>
          <span>Gallery</span>
                                </button>
        <button class="agency-dashboard__view-btn" data-view="list" title="List View">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="8" y1="6" x2="21" y2="6"/>
            <line x1="8" y1="12" x2="21" y2="12"/>
            <line x1="8" y1="18" x2="21" y2="18"/>
            <line x1="3" y1="6" x2="3.01" y2="6"/>
            <line x1="3" y1="12" x2="3.01" y2="12"/>
            <line x1="3" y1="18" x2="3.01" y2="18"/>
          </svg>
          <span>List</span>
                                    </button>
        <button class="agency-dashboard__view-btn" data-view="table" title="Table View">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0H5a2 2 0 0 1-2-2V9m6 12h10a2 2 0 0 0 2-2V9M9 3h6"/>
          </svg>
          <span>Table</span>
                                      </button>
      </div>
                      </div>

    <!-- Editorial Dashboard Stats -->
    <div class="agency-dashboard__stats">
      <div class="agency-dashboard__stat-card agency-dashboard__stat-card--new-today">
        <div class="agency-dashboard__stat-icon">üì•</div>
        <div class="agency-dashboard__stat-content">
          <div class="agency-dashboard__stat-value"><%= safeStats.newToday %></div>
          <div class="agency-dashboard__stat-label">New Applications Today</div>
                    </div>
              </div>
      <div class="agency-dashboard__stat-card agency-dashboard__stat-card--highlight">
        <div class="agency-dashboard__stat-icon">‚è≥</div>
        <div class="agency-dashboard__stat-content">
          <div class="agency-dashboard__stat-value"><%= safeStats.pending %></div>
          <div class="agency-dashboard__stat-label">Awaiting Review</div>
        </div>
      </div>
      <div class="agency-dashboard__stat-card">
        <div class="agency-dashboard__stat-icon">‚úÖ</div>
        <div class="agency-dashboard__stat-content">
          <div class="agency-dashboard__stat-value"><%= safeStats.accepted %></div>
          <div class="agency-dashboard__stat-label">Accepted</div>
          </div>
        </div>
      </div>
    </section>

  <!-- Analytics Section -->
  <section class="agency-dashboard__analytics" id="analytics">
    <div class="agency-dashboard__analytics-container">
      <div class="agency-dashboard__analytics-header">
        <h2 class="agency-dashboard__analytics-title">Analytics & Insights</h2>
        <p class="agency-dashboard__analytics-subtitle">Track your application pipeline and performance metrics</p>
      </div>

      <div class="agency-dashboard__analytics-content">
        <!-- Loading State -->
        <div class="agency-dashboard__analytics-loading" id="analytics-loading">
          <div style="text-align: center; padding: 3rem;">
            <div style="margin-bottom: 1rem; color: var(--agency-text-secondary);">Loading analytics...</div>
            <div style="font-size: 0.875rem; color: var(--agency-text-tertiary);">This may take a moment</div>
          </div>
        </div>

        <!-- Error State -->
        <div class="agency-dashboard__analytics-error" id="analytics-error" style="display: none;">
          <div style="text-align: center; padding: 3rem; color: var(--agency-text-tertiary);">
            <div style="margin-bottom: 0.5rem; font-size: 0.875rem;">Analytics unavailable</div>
            <div style="font-size: 0.8125rem;">Unable to load analytics data at this time</div>
          </div>
        </div>

        <!-- Analytics Content -->
        <div class="agency-dashboard__analytics-main" id="analytics-content" style="display: none;">
          <!-- Key Metrics Grid -->
          <div class="agency-dashboard__analytics-grid">
            <div class="agency-dashboard__analytics-card">
              <div class="agency-dashboard__analytics-card-header">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <h3 class="agency-dashboard__analytics-card-title">Total Applications</h3>
              </div>
              <div class="agency-dashboard__analytics-card-value" id="analytics-total">‚Äî</div>
              <div class="agency-dashboard__analytics-card-subtext" id="analytics-total-subtext">All time</div>
            </div>

            <div class="agency-dashboard__analytics-card">
              <div class="agency-dashboard__analytics-card-header">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <h3 class="agency-dashboard__analytics-card-title">Acceptance Rate</h3>
              </div>
              <div class="agency-dashboard__analytics-card-value" id="analytics-acceptance-rate">‚Äî</div>
              <div class="agency-dashboard__analytics-card-subtext" id="analytics-acceptance-subtext">Of processed applications</div>
            </div>

            <div class="agency-dashboard__analytics-card">
              <div class="agency-dashboard__analytics-card-header">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                  <path d="M2 17l10 5 10-5"/>
                  <path d="M2 12l10 5 10-5"/>
                </svg>
                <h3 class="agency-dashboard__analytics-card-title">This Month</h3>
              </div>
              <div class="agency-dashboard__analytics-card-value" id="analytics-this-month">‚Äî</div>
              <div class="agency-dashboard__analytics-card-subtext" id="analytics-month-subtext">New applications</div>
            </div>

            <div class="agency-dashboard__analytics-card">
              <div class="agency-dashboard__analytics-card-header">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M2 12L12 2l10 10M12 2v20"/>
                </svg>
                <h3 class="agency-dashboard__analytics-card-title">Avg Match Score</h3>
              </div>
              <div class="agency-dashboard__analytics-card-value" id="analytics-avg-score">‚Äî</div>
              <div class="agency-dashboard__analytics-card-subtext" id="analytics-score-subtext">Across all boards</div>
            </div>
          </div>

          <!-- Status Breakdown -->
          <div class="agency-dashboard__analytics-section">
            <h3 class="agency-dashboard__analytics-section-title">Applications by Status</h3>
            <div class="agency-dashboard__analytics-status-grid" id="analytics-status-grid">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <!-- Match Score Distribution -->
          <div class="agency-dashboard__analytics-section">
            <h3 class="agency-dashboard__analytics-section-title">Match Score Distribution</h3>
            <div class="agency-dashboard__analytics-scores" id="analytics-scores">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <!-- Applications by Board -->
          <div class="agency-dashboard__analytics-section">
            <h3 class="agency-dashboard__analytics-section-title">Applications by Board</h3>
            <div class="agency-dashboard__analytics-boards" id="analytics-boards">
              <!-- Populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Intelligent Filtering & Search -->
  <section class="agency-dashboard__filters">
    <div class="agency-dashboard__filters-main">
      <!-- Search Bar -->
      <div class="agency-dashboard__search">
        <svg class="agency-dashboard__search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input 
          type="search" 
          class="agency-dashboard__search-input" 
          id="agency-search"
          placeholder="Search by name, city, or describe what you're looking for..."
          value="<%= safeFilters.search || '' %>"
          autocomplete="off">
        <button class="agency-dashboard__search-clear" id="clear-search" style="display: none;">√ó</button>
          </div>

      <!-- Filter Chips -->
      <div class="agency-dashboard__filter-chips" id="filter-chips">
        <% if (safeFilters.board_id) { %>
          <% 
            const selectedBoard = safeBoards.find(b => b.id === safeFilters.board_id);
            if (selectedBoard) {
          %>
          <span class="agency-dashboard__filter-chip" data-filter="board_id" data-value="<%= safeFilters.board_id %>">
            Board: <%= selectedBoard.name %>
            <button class="agency-dashboard__filter-chip-remove">√ó</button>
          </span>
          <% } %>
        <% } %>
        <% if (safeFilters.city) { %>
          <span class="agency-dashboard__filter-chip" data-filter="city" data-value="<%= safeFilters.city %>">
            City: <%= safeFilters.city %>
            <button class="agency-dashboard__filter-chip-remove">√ó</button>
          </span>
        <% } %>
        <% if (safeFilters.min_height || safeFilters.max_height) { %>
          <span class="agency-dashboard__filter-chip" data-filter="height">
            Height: <%= safeFilters.min_height || 'Any' %> - <%= safeFilters.max_height || 'Any' %> cm
            <button class="agency-dashboard__filter-chip-remove">√ó</button>
          </span>
        <% } %>
        <% if ((typeof view === 'undefined' || view === 'applicants') && safeFilters.status && safeFilters.status !== 'all') { %>
          <span class="agency-dashboard__filter-chip" data-filter="status" data-value="<%= safeFilters.status %>">
            Status: <%= safeFilters.status.charAt(0).toUpperCase() + safeFilters.status.slice(1) %>
            <button class="agency-dashboard__filter-chip-remove">√ó</button>
          </span>
        <% } %>
      </div>
          </div>

    <!-- Advanced Filters Toggle -->
    <div class="agency-dashboard__filters-advanced">
      <button class="agency-dashboard__filters-toggle" id="toggle-advanced-filters">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
        </svg>
        <span>Advanced Filters</span>
      </button>
      
      <div class="agency-dashboard__filters-panel" id="advanced-filters-panel" style="display: none;">
        <form method="get" action="/dashboard/agency" class="agency-dashboard__filters-form" id="filters-form">
          <% if (typeof view !== 'undefined' && view === 'scout') { %>
            <input type="hidden" name="view" value="scout">
          <% } %>
          <div class="agency-dashboard__filters-grid">
          <% if (typeof view === 'undefined' || view === 'applicants') { %>
          <div class="form-field">
              <label for="filter-board">Board / Division</label>
              <select id="filter-board" name="board_id" class="agency-dashboard__filter-select">
                <option value="">All Boards</option>
                <% safeBoards.forEach((board) => { %>
                  <option value="<%= board.id %>" <%= safeFilters.board_id === board.id ? 'selected' : '' %>>
                    <%= board.name %>
                  </option>
                <% }); %>
              </select>
          </div>
          <% } %>
          <div class="form-field">
              <label for="filter-city">City</label>
              <input id="filter-city" name="city" type="text" placeholder="Any city" value="<%= safeFilters.city || '' %>">
          </div>
          <div class="form-field">
              <label for="filter-min-height">Min Height (cm)</label>
              <input id="filter-min-height" name="min_height" type="number" min="120" max="220" placeholder="160" value="<%= safeFilters.min_height || '' %>">
          </div>
          <div class="form-field">
              <label for="filter-max-height">Max Height (cm)</label>
              <input id="filter-max-height" name="max_height" type="number" min="120" max="220" placeholder="190" value="<%= safeFilters.max_height || '' %>">
          </div>
          <% if (typeof view === 'undefined' || view === 'applicants') { %>
          <div class="form-field">
              <label for="filter-status">Status</label>
              <select id="filter-status" name="status">
                <option value="all" <%= safeFilters.status === 'all' || !safeFilters.status ? 'selected' : '' %>>All Applications</option>
                <option value="pending" <%= safeFilters.status === 'pending' ? 'selected' : '' %>>Pending</option>
                <option value="accepted" <%= safeFilters.status === 'accepted' ? 'selected' : '' %>>Accepted</option>
                <option value="archived" <%= safeFilters.status === 'archived' ? 'selected' : '' %>>Archived</option>
                <option value="declined" <%= safeFilters.status === 'declined' ? 'selected' : '' %>>Declined</option>
            </select>
          </div>
          <% } %>
          <div class="form-field">
              <label for="filter-sort">Sort By</label>
              <select id="filter-sort" name="sort">
                <% if (safeFilters.board_id) { %>
                  <option value="match_score" <%= safeFilters.sort === 'match_score' ? 'selected' : '' %>>Match Score (Highest First)</option>
                <% } %>
                <option value="az" <%= safeFilters.sort === 'az' ? 'selected' : '' %>>A‚ÄìZ (Last name)</option>
                <option value="city" <%= safeFilters.sort === 'city' ? 'selected' : '' %>>City</option>
                <option value="newest" <%= safeFilters.sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                <option value="oldest" <%= safeFilters.sort === 'oldest' ? 'selected' : '' %>>Oldest First</option>
            </select>
          </div>
        </div>
          <div class="agency-dashboard__filters-actions">
          <button type="submit" class="button-primary">Apply Filters</button>
          <a href="/dashboard/agency<%= (typeof view !== 'undefined' && view === 'scout') ? '?view=scout' : '' %>" class="button-secondary">Clear All</a>
        </div>
      </form>
      </div>
    </div>

    <!-- Batch Actions Bar (hidden by default, only for My Applicants view) -->
    <% if (typeof view === 'undefined' || view === 'applicants') { %>
    <div class="agency-dashboard__batch-actions" id="batch-actions" style="display: none;">
      <div class="agency-dashboard__batch-info">
        <span id="batch-count">0</span> selected
      </div>
      <div class="agency-dashboard__batch-buttons">
        <button class="agency-dashboard__batch-btn" data-action="accept" id="batch-accept">Accept Selected</button>
        <button class="agency-dashboard__batch-btn" data-action="decline" id="batch-decline">Decline Selected</button>
        <button class="agency-dashboard__batch-btn" data-action="archive" id="batch-archive">Archive Selected</button>
        <button class="agency-dashboard__batch-btn agency-dashboard__batch-btn--cancel" id="batch-cancel">Cancel</button>
      </div>
    </div>
    <% } %>
  </section>

  <!-- Main Content Area - View Modes -->
  <section class="agency-dashboard__content">
    <% if (typeof view !== 'undefined' && view === 'scout') { %>
      <!-- Scout Talent View -->
      <div class="agency-dashboard__scout-grid">
        <% safeProfiles.forEach((profile, index) => { %>
          <div class="agency-dashboard__scout-card" data-profile-id="<%= profile.id %>">
            <div class="agency-dashboard__scout-image">
              <% if (profile.hero_image_path || (profile.images && profile.images.length > 0)) { %>
                <img 
                  src="<%= normalizeImagePath(profile.hero_image_path || (profile.images && profile.images[0] ? profile.images[0].path : '')) %>" 
                  alt="<%= profile.first_name %> <%= profile.last_name %>"
                  loading="lazy">
              <% } else { %>
                <div class="agency-dashboard__scout-placeholder">
                  <%= (profile.first_name || 'T').charAt(0).toUpperCase() %><%= (profile.last_name || 'T').charAt(0).toUpperCase() %>
                </div>
              <% } %>
            </div>
            <div class="agency-dashboard__scout-info">
              <h3 class="agency-dashboard__scout-name">
                <a href="/portfolio/<%= profile.slug %>" target="_blank">
                  <%= profile.first_name %> <%= profile.last_name %>
                </a>
              </h3>
              <p class="agency-dashboard__scout-details">
                <%= profile.city || 'Location not specified' %> ‚Ä¢ 
                <%= profile.height_cm ? profile.height_cm + ' cm' : 'Height not specified' %>
                <% if (profile.measurements) { %>
                  ‚Ä¢ <%= profile.measurements %>
                <% } %>
              </p>
              <button 
                class="agency-dashboard__scout-invite-btn" 
                data-profile-id="<%= profile.id %>"
                data-profile-name="<%= profile.first_name %> <%= profile.last_name %>"
              >
                Invite to Apply
              </button>
            </div>
          </div>
        <% }); %>
        <% if (safeProfiles.length === 0) { %>
          <div class="agency-dashboard__empty-state">
            <p>No discoverable talent found. Try adjusting your filters.</p>
          </div>
        <% } %>
      </div>
    <% } else { %>
      <!-- My Applicants View (Kanban Board) -->
      <div class="agency-dashboard__view agency-dashboard__view--pipeline" id="view-pipeline">
        <div class="agency-dashboard__kanban">
        
        <!-- New Applications Column -->
        <div class="agency-dashboard__kanban-column" data-status="pending">
          <div class="agency-dashboard__kanban-header">
            <h3 class="agency-dashboard__kanban-title">New Applications</h3>
            <span class="agency-dashboard__kanban-count"><%= profilesByStatus.pending.length %></span>
      </div>
          <div class="agency-dashboard__kanban-cards" data-column="pending">
            <% profilesByStatus.pending.forEach((profile, index) => { 
              const appStatus = profile.application_status || 'pending';
              const aiScore = Math.floor(Math.random() * 30) + 70;
              const aiTags = [];
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('editorial')) {
                aiTags.push({ label: 'Editorial Potential', color: 'purple' });
              }
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('commercial')) {
                aiTags.push({ label: 'Commercial Ready', color: 'blue' });
              }
              if (profile.height_cm && profile.height_cm >= 175) {
                aiTags.push({ label: 'Runway Fit', color: 'green' });
              }
            %>
              <%- include('partials/application-card', { profile, index, currentUser, appStatus, aiScore, aiTags }) %>
            <% }); %>
            <% if (profilesByStatus.pending.length === 0) { %>
              <div class="agency-dashboard__empty-column">
                <p>No new applications</p>
                    </div>
                    <% } %>
          </div>
        </div>

        <!-- Under Review Column -->
        <div class="agency-dashboard__kanban-column" data-status="under-review">
          <div class="agency-dashboard__kanban-header">
            <h3 class="agency-dashboard__kanban-title">Under Review</h3>
            <span class="agency-dashboard__kanban-count"><%= profilesByStatus['under-review'].length %></span>
          </div>
          <div class="agency-dashboard__kanban-cards" data-column="under-review">
            <% profilesByStatus['under-review'].forEach((profile, index) => { 
              const appStatus = profile.application_status || 'pending';
              const aiScore = Math.floor(Math.random() * 30) + 70;
              const aiTags = [];
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('editorial')) {
                aiTags.push({ label: 'Editorial Potential', color: 'purple' });
              }
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('commercial')) {
                aiTags.push({ label: 'Commercial Ready', color: 'blue' });
              }
              if (profile.height_cm && profile.height_cm >= 175) {
                aiTags.push({ label: 'Runway Fit', color: 'green' });
              }
            %>
              <%- include('partials/application-card', { profile, index, currentUser, appStatus, aiScore, aiTags }) %>
            <% }); %>
            <% if (profilesByStatus['under-review'].length === 0) { %>
              <div class="agency-dashboard__empty-column">
                <p>No applications under review</p>
              </div>
                                      <% } %>
                      </div>
              </div>

        <!-- Accepted Column -->
        <div class="agency-dashboard__kanban-column" data-status="accepted">
          <div class="agency-dashboard__kanban-header">
            <h3 class="agency-dashboard__kanban-title">Accepted</h3>
            <span class="agency-dashboard__kanban-count"><%= profilesByStatus.accepted.length %></span>
          </div>
          <div class="agency-dashboard__kanban-cards" data-column="accepted">
            <% profilesByStatus.accepted.forEach((profile, index) => { 
              const appStatus = profile.application_status || 'pending';
              const aiScore = Math.floor(Math.random() * 30) + 70;
              const aiTags = [];
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('editorial')) {
                aiTags.push({ label: 'Editorial Potential', color: 'purple' });
              }
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('commercial')) {
                aiTags.push({ label: 'Commercial Ready', color: 'blue' });
              }
              if (profile.height_cm && profile.height_cm >= 175) {
                aiTags.push({ label: 'Runway Fit', color: 'green' });
              }
            %>
              <%- include('partials/application-card', { profile, index, currentUser, appStatus, aiScore, aiTags }) %>
            <% }); %>
            <% if (profilesByStatus.accepted.length === 0) { %>
              <div class="agency-dashboard__empty-column">
                <p>No accepted applications</p>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Archived Column -->
        <div class="agency-dashboard__kanban-column" data-status="archived">
          <div class="agency-dashboard__kanban-header">
            <h3 class="agency-dashboard__kanban-title">Archived</h3>
            <span class="agency-dashboard__kanban-count"><%= profilesByStatus.archived.length %></span>
          </div>
          <div class="agency-dashboard__kanban-cards" data-column="archived">
            <% profilesByStatus.archived.forEach((profile, index) => { 
              const appStatus = profile.application_status || 'pending';
              const aiScore = Math.floor(Math.random() * 30) + 70;
              const aiTags = [];
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('editorial')) {
                aiTags.push({ label: 'Editorial Potential', color: 'purple' });
              }
              if (profile.bio_curated && profile.bio_curated.toLowerCase().includes('commercial')) {
                aiTags.push({ label: 'Commercial Ready', color: 'blue' });
              }
              if (profile.height_cm && profile.height_cm >= 175) {
                aiTags.push({ label: 'Runway Fit', color: 'green' });
              }
            %>
              <%- include('partials/application-card', { profile, index, currentUser, appStatus, aiScore, aiTags }) %>
            <% }); %>
            <% if (profilesByStatus.archived.length === 0) { %>
              <div class="agency-dashboard__empty-column">
                <p>No archived applications</p>
              </div>
            <% } %>
          </div>
        </div>

      </div>
    </div>

    <!-- Gallery View -->
    <div class="agency-dashboard__view agency-dashboard__view--gallery" id="view-gallery" style="display: none;">
      <div class="agency-dashboard__gallery-grid">
        <% safeProfiles.forEach((profile, index) => { %>
          <div class="agency-dashboard__gallery-card" data-profile-id="<%= profile.id %>">
            <div class="agency-dashboard__gallery-image">
              <% if (profile.hero_image_path || (profile.images && profile.images.length > 0)) { %>
                <img 
                  src="<%= normalizeImagePath(profile.hero_image_path || profile.images[0].path) %>" 
                  alt="<%= profile.first_name %> <%= profile.last_name %>"
                  loading="lazy">
              <% } else { %>
                <div class="agency-dashboard__gallery-placeholder">
                  <%= profile.first_name.charAt(0) %><%= profile.last_name.charAt(0) %>
                </div>
              <% } %>
              <div class="agency-dashboard__gallery-overlay">
                <div class="agency-dashboard__gallery-actions">
                  <button class="agency-dashboard__gallery-preview" data-profile-id="<%= profile.id %>">Preview</button>
                </div>
              </div>
            </div>
            <div class="agency-dashboard__gallery-info">
              <h4 class="agency-dashboard__gallery-name"><%= profile.first_name %> <%= profile.last_name %></h4>
              <p class="agency-dashboard__gallery-location"><%= profile.city || 'Location TBD' %></p>
            </div>
          </div>
        <% }); %>
        <% if (safeProfiles.length === 0) { %>
          <div class="agency-dashboard__empty-state">
            <p>No applications found</p>
          </div>
        <% } %>
      </div>
    </div>

    <!-- List View -->
    <div class="agency-dashboard__view agency-dashboard__view--list" id="view-list" style="display: none;">
      <div class="agency-dashboard__list">
        <% safeProfiles.forEach((profile, index) => { %>
          <div class="agency-dashboard__list-item" data-profile-id="<%= profile.id %>">
            <div class="agency-dashboard__list-checkbox">
              <input type="checkbox" class="agency-dashboard__select-checkbox" data-profile-id="<%= profile.id %>" id="select-<%= profile.id %>">
            </div>
            <div class="agency-dashboard__list-image">
              <% if (profile.hero_image_path || (profile.images && profile.images.length > 0)) { %>
                <img 
                  src="<%= normalizeImagePath(profile.hero_image_path || profile.images[0].path) %>" 
                  alt="<%= profile.first_name %> <%= profile.last_name %>"
                  loading="lazy">
              <% } else { %>
                <div class="agency-dashboard__list-placeholder">
                  <%= profile.first_name.charAt(0) %><%= profile.last_name.charAt(0) %>
                </div>
              <% } %>
            </div>
            <div class="agency-dashboard__list-content">
              <h4 class="agency-dashboard__list-name"><%= profile.first_name %> <%= profile.last_name %></h4>
              <p class="agency-dashboard__list-meta">
                  <%= profile.city || 'Location TBD' %>
                    <% if (profile.height_cm) { %> ‚Ä¢ <%= profile.height_cm %> cm<% } %>
                <% if (profile.measurements) { %> ‚Ä¢ <%= profile.measurements %><% } %>
                </p>
                <% if (profile.bio_curated) { %>
                <p class="agency-dashboard__list-bio"><%= profile.bio_curated.length > 150 ? profile.bio_curated.substring(0, 150) + '...' : profile.bio_curated %></p>
                  <% } %>
            </div>
            <div class="agency-dashboard__list-actions">
              <button class="agency-dashboard__list-preview" data-profile-id="<%= profile.id %>">Preview</button>
              <div class="agency-dashboard__list-quick-actions">
                <% const appStatus = profile.application_status || 'pending'; %>
                <% if (appStatus !== 'accepted') { %>
                  <form method="post" action="/dashboard/agency/application/accept" class="agency-dashboard__quick-form">
                            <input type="hidden" name="profile_id" value="<%= profile.id %>">
                    <button type="submit" class="agency-dashboard__quick-btn agency-dashboard__quick-btn--accept">Accept</button>
                          </form>
                          <% } %>
                <% if (appStatus !== 'declined') { %>
                  <form method="post" action="/dashboard/agency/application/decline" class="agency-dashboard__quick-form">
                                <input type="hidden" name="profile_id" value="<%= profile.id %>">
                    <button type="submit" class="agency-dashboard__quick-btn agency-dashboard__quick-btn--decline">Decline</button>
                        </form>
                        <% } %>
                    </div>
              </div>
          </div>
            <% }); %>
        <% if (safeProfiles.length === 0) { %>
          <div class="agency-dashboard__empty-state">
            <p>No applications found</p>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Table View -->
    <div class="agency-dashboard__view agency-dashboard__view--table" id="view-table" style="display: none;">
      <div class="agency-dashboard__table-wrapper">
        <table class="agency-dashboard__table">
              <thead>
                <tr>
              <th>
                <input type="checkbox" id="select-all" class="agency-dashboard__select-all">
              </th>
              <th>Name</th>
              <th>Location</th>
              <th>Height</th>
              <th>Measurements</th>
              <th>Status</th>
              <th>Actions</th>
                </tr>
              </thead>
              <tbody>
            <% safeProfiles.forEach((profile) => { %>
              <tr class="agency-dashboard__table-row" data-profile-id="<%= profile.id %>">
                <td>
                  <input type="checkbox" class="agency-dashboard__select-checkbox" data-profile-id="<%= profile.id %>">
                    </td>
                <td>
                  <div class="agency-dashboard__table-name">
                    <% if (profile.hero_image_path || (profile.images && profile.images.length > 0)) { %>
                      <img 
                        src="<%= normalizeImagePath(profile.hero_image_path || profile.images[0].path) %>" 
                        alt="<%= profile.first_name %> <%= profile.last_name %>"
                        class="agency-dashboard__table-avatar"
                        loading="lazy">
                    <% } %>
                    <span><%= profile.first_name %> <%= profile.last_name %></span>
                  </div>
                    </td>
                <td><%= profile.city || '‚Äî' %></td>
                <td><%= profile.height_cm ? profile.height_cm + ' cm' : '‚Äî' %></td>
                <td><%= profile.measurements || '‚Äî' %></td>
                <td>
                  <% const appStatus = profile.application_status || 'pending'; %>
                  <span class="agency-dashboard__status-badge agency-dashboard__status-badge--<%= appStatus %>">
                    <%= appStatus.charAt(0).toUpperCase() + appStatus.slice(1) %>
                  </span>
                    </td>
                    <td>
                  <div class="agency-dashboard__table-actions">
                    <button class="agency-dashboard__table-preview" data-profile-id="<%= profile.id %>">Preview</button>
                    <% if (appStatus !== 'accepted') { %>
                      <form method="post" action="/dashboard/agency/application/accept" class="agency-dashboard__quick-form">
                        <input type="hidden" name="profile_id" value="<%= profile.id %>">
                        <button type="submit" class="agency-dashboard__table-btn agency-dashboard__table-btn--accept">Accept</button>
                      </form>
                    <% } %>
                    <% if (appStatus !== 'declined') { %>
                      <form method="post" action="/dashboard/agency/application/decline" class="agency-dashboard__quick-form">
                        <input type="hidden" name="profile_id" value="<%= profile.id %>">
                        <button type="submit" class="agency-dashboard__table-btn agency-dashboard__table-btn--decline">Decline</button>
                      </form>
                    <% } %>
                  </div>
                    </td>
                  </tr>
                  <% }); %>
            <% if (safeProfiles.length === 0) { %>
              <tr>
                <td colspan="7" class="agency-dashboard__empty-state">
                  <p>No applications found</p>
                </td>
              </tr>
            <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    <% } %>
  </section>

  <!-- Notes & Tags Modal -->
  <div class="agency-notes-modal" id="notes-tags-modal" style="display: none;">
    <div class="agency-notes-modal__overlay"></div>
    <div class="agency-notes-modal__content">
      <div class="agency-notes-modal__header">
        <div class="agency-notes-modal__header-main">
          <h2 class="agency-notes-modal__title">Notes & Tags</h2>
          <p class="agency-notes-modal__subtitle" id="notes-modal-subtitle">Application for <span id="notes-modal-name"></span></p>
        </div>
        <button class="agency-notes-modal__close" id="notes-modal-close" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="agency-notes-modal__body">
        <!-- Tags Section -->
        <div class="agency-notes-modal__section">
          <div class="agency-notes-modal__section-header">
            <h3 class="agency-notes-modal__section-title">Tags</h3>
            <button class="agency-notes-modal__add-btn" id="add-tag-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Tag
            </button>
          </div>
          <div class="agency-notes-modal__tags-container" id="tags-container">
            <!-- Tags will be loaded here -->
          </div>
          <div class="agency-notes-modal__tag-input-wrapper" id="tag-input-wrapper" style="display: none;">
            <input 
              type="text" 
              class="agency-notes-modal__tag-input" 
              id="tag-input" 
              placeholder="Enter tag name..."
              maxlength="30">
            <div class="agency-notes-modal__tag-color-picker" id="tag-color-picker">
              <button class="agency-notes-modal__color-option" data-color="#C9A55A" style="background: #C9A55A;" title="Gold"></button>
              <button class="agency-notes-modal__color-option" data-color="#10B981" style="background: #10B981;" title="Green"></button>
              <button class="agency-notes-modal__color-option" data-color="#3B82F6" style="background: #3B82F6;" title="Blue"></button>
              <button class="agency-notes-modal__color-option" data-color="#8B5CF6" style="background: #8B5CF6;" title="Purple"></button>
              <button class="agency-notes-modal__color-option" data-color="#EF4444" style="background: #EF4444;" title="Red"></button>
              <button class="agency-notes-modal__color-option" data-color="#F59E0B" style="background: #F59E0B;" title="Orange"></button>
            </div>
            <div class="agency-notes-modal__tag-input-actions">
              <button class="agency-notes-modal__btn agency-notes-modal__btn--primary" id="save-tag-btn">Save</button>
              <button class="agency-notes-modal__btn agency-notes-modal__btn--secondary" id="cancel-tag-btn">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Notes Section -->
        <div class="agency-notes-modal__section">
          <div class="agency-notes-modal__section-header">
            <h3 class="agency-notes-modal__section-title">Notes</h3>
            <button class="agency-notes-modal__add-btn" id="add-note-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Note
            </button>
          </div>
          <div class="agency-notes-modal__notes-container" id="notes-container">
            <!-- Notes will be loaded here -->
          </div>
          <div class="agency-notes-modal__note-input-wrapper" id="note-input-wrapper" style="display: none;">
            <textarea 
              class="agency-notes-modal__note-input" 
              id="note-input" 
              placeholder="Write a note..."
              rows="4"></textarea>
            <div class="agency-notes-modal__note-input-actions">
              <button class="agency-notes-modal__btn agency-notes-modal__btn--primary" id="save-note-btn">Save</button>
              <button class="agency-notes-modal__btn agency-notes-modal__btn--secondary" id="cancel-note-btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Application Detail Modal -->
  <div class="agency-detail-modal" id="application-detail-modal" style="display: none;">
    <div class="agency-detail-modal__overlay"></div>
    <div class="agency-detail-modal__content">
      <div class="agency-detail-modal__header">
        <div class="agency-detail-modal__header-main">
          <h2 class="agency-detail-modal__title" id="detail-modal-name">Application Details</h2>
          <p class="agency-detail-modal__subtitle" id="detail-modal-subtitle">Loading...</p>
        </div>
        <div class="agency-detail-modal__header-actions">
          <a href="#" id="detail-modal-portfolio-link" target="_blank" class="agency-detail-modal__portfolio-link">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15 3 21 3 21 9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
            View Portfolio
          </a>
          <button class="agency-detail-modal__close" id="detail-modal-close" aria-label="Close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>

      <div class="agency-detail-modal__body" id="detail-modal-body">
        <div class="agency-detail-modal__loading">
          <div class="agency-detail-modal__spinner"></div>
          <p>Loading application details...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Board Editor Modal -->
  <div class="board-editor-modal" id="board-editor-modal" style="display: none;">
    <div class="board-editor-modal__overlay"></div>
    <div class="board-editor-modal__content">
      <div class="board-editor-modal__header">
        <h2 class="board-editor-modal__title" id="board-editor-title">Create New Board</h2>
        <button class="board-editor-modal__close" id="board-editor-close" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="board-editor-modal__tabs">
        <button class="board-editor-modal__tab board-editor-modal__tab--active" data-tab="basic">Basic Info</button>
        <button class="board-editor-modal__tab" data-tab="requirements">Requirements</button>
        <button class="board-editor-modal__tab" data-tab="weights">Scoring Weights</button>
      </div>

      <form class="board-editor-modal__form" id="board-editor-form">
        <input type="hidden" id="board-editor-id" name="board_id" value="">

        <!-- Basic Info Tab -->
        <div class="board-editor-modal__tab-content board-editor-modal__tab-content--active" data-content="basic">
          <div class="board-editor-modal__field">
            <label for="board-name">Board Name *</label>
            <input type="text" id="board-name" name="name" required placeholder="e.g., Women's Division, Men's Commercial">
          </div>
          <div class="board-editor-modal__field">
            <label for="board-description">Description</label>
            <textarea id="board-description" name="description" rows="3" placeholder="Optional description of this board..."></textarea>
          </div>
          <div class="board-editor-modal__field">
            <label class="board-editor-modal__checkbox-label">
              <input type="checkbox" id="board-is-active" name="is_active" checked>
              <span>Active (board will be used for matching)</span>
            </label>
          </div>
        </div>

        <!-- Requirements Tab -->
        <div class="board-editor-modal__tab-content" data-content="requirements">
          <div class="board-editor-modal__section">
            <h3 class="board-editor-modal__section-title">Age Range</h3>
            <div class="board-editor-modal__range-group">
              <div class="board-editor-modal__field">
                <label for="req-min-age">Min Age</label>
                <input type="number" id="req-min-age" name="min_age" min="16" max="99" placeholder="Any">
              </div>
              <div class="board-editor-modal__field">
                <label for="req-max-age">Max Age</label>
                <input type="number" id="req-max-age" name="max_age" min="16" max="99" placeholder="Any">
              </div>
            </div>
          </div>

          <div class="board-editor-modal__section">
            <h3 class="board-editor-modal__section-title">Height Range (cm)</h3>
            <div class="board-editor-modal__range-group">
              <div class="board-editor-modal__field">
                <label for="req-min-height">Min Height</label>
                <input type="number" id="req-min-height" name="min_height_cm" min="120" max="220" placeholder="Any">
              </div>
              <div class="board-editor-modal__field">
                <label for="req-max-height">Max Height</label>
                <input type="number" id="req-max-height" name="max_height_cm" min="120" max="220" placeholder="Any">
              </div>
            </div>
          </div>

          <div class="board-editor-modal__section">
            <h3 class="board-editor-modal__section-title">Gender</h3>
            <div class="board-editor-modal__checkbox-group" id="req-genders">
              <label class="board-editor-modal__checkbox-label">
                <input type="checkbox" name="genders" value="Female">
                <span>Female</span>
              </label>
              <label class="board-editor-modal__checkbox-label">
                <input type="checkbox" name="genders" value="Male">
                <span>Male</span>
              </label>
              <label class="board-editor-modal__checkbox-label">
                <input type="checkbox" name="genders" value="Non-binary">
                <span>Non-binary</span>
              </label>
              <label class="board-editor-modal__checkbox-label">
                <input type="checkbox" name="genders" value="Other">
                <span>Other</span>
              </label>
            </div>
          </div>

          <div class="board-editor-modal__section">
            <h3 class="board-editor-modal__section-title">Measurements</h3>
            <div class="board-editor-modal__measurements-grid">
              <div class="board-editor-modal__field">
                <label for="req-min-bust">Min Bust</label>
                <input type="number" id="req-min-bust" name="min_bust" step="0.5" placeholder="Any">
              </div>
              <div class="board-editor-modal__field">
                <label for="req-max-bust">Max Bust</label>
                <input type="number" id="req-max-bust" name="max_bust" step="0.5" placeholder="Any">
              </div>
              <div class="board-editor-modal__field">
                <label for="req-min-waist">Min Waist</label>
                <input type="number" id="req-min-waist" name="min_waist" step="0.5" placeholder="Any">
              </div>
              <div class="board-editor-modal__field">
                <label for="req-max-waist">Max Waist</label>
                <input type="number" id="req-max-waist" name="max_waist" step="0.5" placeholder="Any">
              </div>
              <div class="board-editor-modal__field">
                <label for="req-min-hips">Min Hips</label>
                <input type="number" id="req-min-hips" name="min_hips" step="0.5" placeholder="Any">
              </div>
              <div class="board-editor-modal__field">
                <label for="req-max-hips">Max Hips</label>
                <input type="number" id="req-max-hips" name="max_hips" step="0.5" placeholder="Any">
              </div>
            </div>
          </div>

          <div class="board-editor-modal__section">
            <h3 class="board-editor-modal__section-title">Social Reach</h3>
            <div class="board-editor-modal__field">
              <label for="req-min-social-reach">Minimum Followers</label>
              <input type="number" id="req-min-social-reach" name="min_social_reach" min="0" placeholder="Any">
            </div>
            <div class="board-editor-modal__field">
              <label for="req-social-importance">Importance</label>
              <select id="req-social-importance" name="social_reach_importance">
                <option value="none">None</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical (Hard Filter)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Scoring Weights Tab -->
        <div class="board-editor-modal__tab-content" data-content="weights">
          <p class="board-editor-modal__help-text">Adjust the importance (0-5) of each dimension in the match score calculation. Higher values mean that dimension has more influence.</p>
          
          <div class="board-editor-modal__weights-list" id="weights-list">
            <div class="board-editor-modal__weight-item">
              <label for="weight-age">Age</label>
              <div class="board-editor-modal__weight-control">
                <input type="range" id="weight-age" name="age_weight" min="0" max="5" step="0.5" value="0">
                <span class="board-editor-modal__weight-value" id="weight-age-value">0</span>
              </div>
            </div>
            <div class="board-editor-modal__weight-item">
              <label for="weight-height">Height</label>
              <div class="board-editor-modal__weight-control">
                <input type="range" id="weight-height" name="height_weight" min="0" max="5" step="0.5" value="0">
                <span class="board-editor-modal__weight-value" id="weight-height-value">0</span>
              </div>
            </div>
            <div class="board-editor-modal__weight-item">
              <label for="weight-measurements">Measurements</label>
              <div class="board-editor-modal__weight-control">
                <input type="range" id="weight-measurements" name="measurements_weight" min="0" max="5" step="0.5" value="0">
                <span class="board-editor-modal__weight-value" id="weight-measurements-value">0</span>
              </div>
            </div>
            <div class="board-editor-modal__weight-item">
              <label for="weight-body-type">Body Type</label>
              <div class="board-editor-modal__weight-control">
                <input type="range" id="weight-body-type" name="body_type_weight" min="0" max="5" step="0.5" value="0">
                <span class="board-editor-modal__weight-value" id="weight-body-type-value">0</span>
              </div>
            </div>
            <div class="board-editor-modal__weight-item">
              <label for="weight-comfort">Comfort Levels</label>
              <div class="board-editor-modal__weight-control">
                <input type="range" id="weight-comfort" name="comfort_weight" min="0" max="5" step="0.5" value="0">
                <span class="board-editor-modal__weight-value" id="weight-comfort-value">0</span>
              </div>
            </div>
            <div class="board-editor-modal__weight-item">
              <label for="weight-experience">Experience</label>
              <div class="board-editor-modal__weight-control">
                <input type="range" id="weight-experience" name="experience_weight" min="0" max="5" step="0.5" value="0">
                <span class="board-editor-modal__weight-value" id="weight-experience-value">0</span>
              </div>
            </div>
            <div class="board-editor-modal__weight-item">
              <label for="weight-skills">Skills</label>
              <div class="board-editor-modal__weight-control">
                <input type="range" id="weight-skills" name="skills_weight" min="0" max="5" step="0.5" value="0">
                <span class="board-editor-modal__weight-value" id="weight-skills-value">0</span>
              </div>
            </div>
            <div class="board-editor-modal__weight-item">
              <label for="weight-location">Location</label>
              <div class="board-editor-modal__weight-control">
                <input type="range" id="weight-location" name="location_weight" min="0" max="5" step="0.5" value="0">
                <span class="board-editor-modal__weight-value" id="weight-location-value">0</span>
              </div>
            </div>
            <div class="board-editor-modal__weight-item">
              <label for="weight-social-reach">Social Reach</label>
              <div class="board-editor-modal__weight-control">
                <input type="range" id="weight-social-reach" name="social_reach_weight" min="0" max="5" step="0.5" value="0">
                <span class="board-editor-modal__weight-value" id="weight-social-reach-value">0</span>
              </div>
            </div>
          </div>
          <div class="board-editor-modal__total-weight">
            <strong>Total Weight: <span id="total-weight-value">0</span></strong>
          </div>
        </div>

        <div class="board-editor-modal__actions">
          <button type="button" class="board-editor-modal__btn board-editor-modal__btn--secondary" id="board-editor-cancel">Cancel</button>
          <button type="submit" class="board-editor-modal__btn board-editor-modal__btn--primary" id="board-editor-save">
            <span>Save Board</span>
            <svg class="board-editor-modal__spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="display: none;">
              <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
  // Pass data to JavaScript
  window.AGENCY_DASHBOARD_DATA = {
    boards: <%- JSON.stringify(safeBoards) %>,
    profiles: <%- JSON.stringify(safeProfiles.map(p => ({
      id: p.id,
      slug: p.slug,
      first_name: p.first_name,
      last_name: p.last_name,
      city: p.city,
      height_cm: p.height_cm,
      measurements: p.measurements,
      bio_curated: p.bio_curated,
      hero_image_path: p.hero_image_path,
      application_status: p.application_status || 'pending',
      application_id: p.application_id,
      images: (p.images || []).map(img => ({ id: img.id, path: img.path, label: img.label }))
    }))) %>,
    stats: <%- JSON.stringify(safeStats) %>,
    filters: <%- JSON.stringify(safeFilters) %>
  };
</script>
<script src="/scripts/agency-dashboard.js?v=<%= Date.now() %>" defer></script>
